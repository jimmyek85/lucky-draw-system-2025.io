<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·æ³¨å†Œæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #666;
            border-radius: 4px;
            background-color: #333;
            color: white;
        }
        .log {
            background-color: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç”¨æˆ·æ³¨å†Œå’Œæ•°æ®ä¿å­˜æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š Supabase è¿æ¥çŠ¶æ€</h2>
        <div id="connection-status">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkConnection()">é‡æ–°æ£€æŸ¥è¿æ¥</button>
    </div>

    <div class="test-section">
        <h2>ğŸ‘¤ æµ‹è¯•ç”¨æˆ·æ³¨å†Œ</h2>
        <div>
            <input type="text" id="test-name" placeholder="å§“å" value="æµ‹è¯•ç”¨æˆ·">
            <input type="text" id="test-phone" placeholder="ç”µè¯" value="+60123456789">
            <input type="email" id="test-email" placeholder="é‚®ç®±" value="test@example.com">
            <input type="text" id="test-address" placeholder="åœ°å€" value="æµ‹è¯•åœ°å€">
        </div>
        <button onclick="testRegistration()">æµ‹è¯•æ³¨å†Œ</button>
        <button onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        <div id="registration-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æ•°æ®åº“ç”¨æˆ·åˆ—è¡¨</h2>
        <button onclick="loadUsers()">åŠ è½½ç”¨æˆ·æ•°æ®</button>
        <button onclick="countUsers()">ç»Ÿè®¡ç”¨æˆ·æ•°é‡</button>
        <div id="users-list"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ—‚ï¸ ç¦»çº¿æ•°æ®æ£€æŸ¥</h2>
        <button onclick="checkOfflineData()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
        <button onclick="syncOfflineData()">åŒæ­¥ç¦»çº¿æ•°æ®</button>
        <div id="offline-data"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="test-log" class="log"></div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase;
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logDiv = document.getElementById('test-log');
            logDiv.textContent = testLog.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logEntry);
        }

        async function initSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('SUPABASE_CONFIG æœªæ‰¾åˆ°');
                }
                
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                log(`âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = 'æ£€æŸ¥ä¸­...';
            
            try {
                if (!supabase) {
                    const initialized = await initSupabase();
                    if (!initialized) {
                        statusDiv.innerHTML = '<span class="error">âŒ æ— æ³•åˆå§‹åŒ– Supabase</span>';
                        return;
                    }
                }
                
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                const { data, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                statusDiv.innerHTML = '<span class="success">âœ… Supabase è¿æ¥æ­£å¸¸</span>';
                log('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</span>`;
                log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testRegistration() {
            const resultDiv = document.getElementById('registration-result');
            resultDiv.innerHTML = 'æ³¨å†Œä¸­...';
            
            try {
                const userData = {
                    name: document.getElementById('test-name').value,
                    phone: document.getElementById('test-phone').value,
                    email: document.getElementById('test-email').value,
                    address: document.getElementById('test-address').value,
                    created_at: new Date().toISOString(),
                    participation_count: 1
                };
                
                log(`ğŸ”„ å¼€å§‹æ³¨å†Œç”¨æˆ·: ${userData.name}`);
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser, error: checkError } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('*')
                    .eq('phone', userData.phone)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }
                
                if (existingUser) {
                    log(`âš ï¸ ç”¨æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°å‚ä¸æ¬¡æ•°`, 'warning');
                    
                    const { data: updateData, error: updateError } = await supabase
                        .from(window.SUPABASE_CONFIG.TABLES.USERS)
                        .update({ 
                            participation_count: existingUser.participation_count + 1,
                            last_participation: new Date().toISOString()
                        })
                        .eq('phone', userData.phone)
                        .select();
                    
                    if (updateError) throw updateError;
                    
                    resultDiv.innerHTML = '<span class="warning">âš ï¸ ç”¨æˆ·å·²å­˜åœ¨ï¼Œå·²æ›´æ–°å‚ä¸è®°å½•</span>';
                    log(`âœ… ç”¨æˆ·å‚ä¸è®°å½•æ›´æ–°æˆåŠŸ`);
                } else {
                    log(`â• åˆ›å»ºæ–°ç”¨æˆ·`);
                    
                    const { data: insertData, error: insertError } = await supabase
                        .from(window.SUPABASE_CONFIG.TABLES.USERS)
                        .insert([userData])
                        .select();
                    
                    if (insertError) throw insertError;
                    
                    resultDiv.innerHTML = '<span class="success">âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ</span>';
                    log(`âœ… æ–°ç”¨æˆ·æ³¨å†ŒæˆåŠŸ: ${JSON.stringify(insertData[0])}`);
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ æ³¨å†Œå¤±è´¥: ${error.message}</span>`;
                log(`âŒ ç”¨æˆ·æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadUsers() {
            const listDiv = document.getElementById('users-list');
            listDiv.innerHTML = 'åŠ è½½ä¸­...';
            
            try {
                const { data, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (data.length === 0) {
                    listDiv.innerHTML = '<span class="warning">âš ï¸ æš‚æ— ç”¨æˆ·æ•°æ®</span>';
                    log('âš ï¸ æ•°æ®åº“ä¸­æš‚æ— ç”¨æˆ·æ•°æ®', 'warning');
                } else {
                    let html = `<div class="success">âœ… æ‰¾åˆ° ${data.length} ä¸ªç”¨æˆ·:</div><ul>`;
                    data.forEach(user => {
                        html += `<li>${user.name} - ${user.phone} - ${user.email} (å‚ä¸${user.participation_count || 1}æ¬¡)</li>`;
                    });
                    html += '</ul>';
                    listDiv.innerHTML = html;
                    log(`âœ… æˆåŠŸåŠ è½½ ${data.length} ä¸ªç”¨æˆ·`);
                }
                
            } catch (error) {
                listDiv.innerHTML = `<span class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</span>`;
                log(`âŒ ç”¨æˆ·æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function countUsers() {
            try {
                const { count, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                
                log(`ğŸ“Š æ•°æ®åº“ä¸­å…±æœ‰ ${count} ä¸ªç”¨æˆ·`);
                
            } catch (error) {
                log(`âŒ ç”¨æˆ·ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkOfflineData() {
            const offlineDiv = document.getElementById('offline-data');
            
            try {
                const offlineUsers = localStorage.getItem('offlineUsers');
                const userData = localStorage.getItem('userData');
                
                let html = '<h4>æœ¬åœ°å­˜å‚¨æ•°æ®:</h4>';
                
                if (offlineUsers) {
                    const users = JSON.parse(offlineUsers);
                    html += `<div class="warning">âš ï¸ ç¦»çº¿ç”¨æˆ·æ•°æ®: ${users.length} ä¸ªç”¨æˆ·</div>`;
                    html += '<ul>';
                    users.forEach(user => {
                        html += `<li>${user.name} - ${user.phone}</li>`;
                    });
                    html += '</ul>';
                    log(`âš ï¸ å‘ç° ${users.length} ä¸ªç¦»çº¿ç”¨æˆ·æ•°æ®`, 'warning');
                } else {
                    html += '<div class="info">â„¹ï¸ æ— ç¦»çº¿ç”¨æˆ·æ•°æ®</div>';
                }
                
                if (userData) {
                    const user = JSON.parse(userData);
                    html += `<div class="info">â„¹ï¸ å½“å‰ç”¨æˆ·æ•°æ®: ${user.name} - ${user.phone}</div>`;
                } else {
                    html += '<div class="info">â„¹ï¸ æ— å½“å‰ç”¨æˆ·æ•°æ®</div>';
                }
                
                offlineDiv.innerHTML = html;
                
            } catch (error) {
                offlineDiv.innerHTML = `<span class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</span>`;
                log(`âŒ ç¦»çº¿æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function syncOfflineData() {
            try {
                const offlineUsers = localStorage.getItem('offlineUsers');
                if (!offlineUsers) {
                    log('â„¹ï¸ æ— ç¦»çº¿æ•°æ®éœ€è¦åŒæ­¥', 'info');
                    return;
                }
                
                const users = JSON.parse(offlineUsers);
                log(`ğŸ”„ å¼€å§‹åŒæ­¥ ${users.length} ä¸ªç¦»çº¿ç”¨æˆ·`);
                
                for (const user of users) {
                    try {
                        const { data, error } = await supabase
                            .from(window.SUPABASE_CONFIG.TABLES.USERS)
                            .insert([user])
                            .select();
                        
                        if (error) {
                            log(`âŒ åŒæ­¥ç”¨æˆ·å¤±è´¥ ${user.name}: ${error.message}`, 'error');
                        } else {
                            log(`âœ… åŒæ­¥ç”¨æˆ·æˆåŠŸ: ${user.name}`);
                        }
                    } catch (syncError) {
                        log(`âŒ åŒæ­¥ç”¨æˆ·å¼‚å¸¸ ${user.name}: ${syncError.message}`, 'error');
                    }
                }
                
                // æ¸…é™¤å·²åŒæ­¥çš„ç¦»çº¿æ•°æ®
                localStorage.removeItem('offlineUsers');
                log('âœ… ç¦»çº¿æ•°æ®åŒæ­¥å®Œæˆï¼Œå·²æ¸…é™¤æœ¬åœ°ç¼“å­˜');
                
            } catch (error) {
                log(`âŒ ç¦»çº¿æ•°æ®åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            try {
                const { data, error } = await supabase
                    .from(window.SUPABASE_CONFIG.TABLES.USERS)
                    .delete()
                    .eq('name', 'æµ‹è¯•ç”¨æˆ·');
                
                if (error) throw error;
                
                log('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…é™¤');
                document.getElementById('registration-result').innerHTML = '<span class="info">â„¹ï¸ æµ‹è¯•æ•°æ®å·²æ¸…é™¤</span>';
                
            } catch (error) {
                log(`âŒ æ¸…é™¤æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            testLog = [];
            document.getElementById('test-log').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            await initSupabase();
            await checkConnection();
        });
    </script>
</body>
</html>