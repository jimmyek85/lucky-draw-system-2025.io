<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 Lucky Draw - ç³»ç»Ÿå°±ç»ªæ£€æŸ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .status-card.ready {
            border-left-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
        .status-card.error {
            border-left-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-ready { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-checking { 
            background-color: #f59e0b; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">ğŸ¯ 1602 Lucky Draw</h1>
            <h2 class="text-2xl text-gray-300 mb-4">ç³»ç»Ÿå°±ç»ªæ£€æŸ¥</h2>
            <p class="text-gray-400">ç¡®ä¿å‰ç«¯å’Œåç«¯æ•°æ®è¿æ¥æ­£å¸¸ï¼Œæ”¯æŒæœ‰ç½‘æ— ç½‘æŒç»­è¿è¡Œ</p>
        </div>

        <!-- æ€»ä½“çŠ¶æ€ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 text-center">
            <div id="overall-status" class="text-3xl font-bold mb-4">
                <span class="status-indicator status-checking"></span>
                <span id="overall-text">ç³»ç»Ÿæ£€æŸ¥ä¸­...</span>
            </div>
            <div id="overall-description" class="text-gray-400">
                æ­£åœ¨æ£€æŸ¥æ‰€æœ‰ç³»ç»Ÿç»„ä»¶...
            </div>
        </div>

        <!-- ç³»ç»Ÿç»„ä»¶çŠ¶æ€ -->
        <div class="feature-grid mb-8">
            <!-- Supabase è¿æ¥ -->
            <div id="supabase-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-blue-400">ğŸ”— Supabase è¿æ¥</h3>
                    <span id="supabase-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="supabase-details" class="space-y-2 text-sm">
                    <div>URL: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>çŠ¶æ€: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>å»¶è¿Ÿ: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>

            <!-- å‰ç«¯åŠŸèƒ½ -->
            <div id="frontend-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-green-400">ğŸ¯ å‰ç«¯åŠŸèƒ½</h3>
                    <span id="frontend-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="frontend-details" class="space-y-2 text-sm">
                    <div>ç”¨æˆ·æ³¨å†Œ: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>æŠ½å¥–åŠŸèƒ½: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>æ•°æ®åŒæ­¥: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>

            <!-- åç«¯ç®¡ç† -->
            <div id="backend-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-purple-400">âš™ï¸ åç«¯ç®¡ç†</h3>
                    <span id="backend-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="backend-details" class="space-y-2 text-sm">
                    <div>ç”¨æˆ·ç®¡ç†: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>æ•°æ®æŸ¥è¯¢: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>ç³»ç»Ÿé…ç½®: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>

            <!-- ç½‘ç»œéŸ§æ€§ -->
            <div id="network-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-yellow-400">ğŸ“¡ ç½‘ç»œéŸ§æ€§</h3>
                    <span id="network-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="network-details" class="space-y-2 text-sm">
                    <div>è¿æ¥ç¨³å®šæ€§: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>é‡è¿æœºåˆ¶: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                    <div>ç¦»çº¿æ”¯æŒ: <span class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿè®¿é—®é“¾æ¥ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-blue-400 mb-4">ğŸš€ å¿«é€Ÿè®¿é—®</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center transition-colors">
                    <div class="text-2xl mb-2">ğŸ¯</div>
                    <div class="font-semibold">ç”¨æˆ·å‰ç«¯</div>
                    <div class="text-sm text-blue-200">æŠ½å¥–ç³»ç»Ÿ</div>
                </a>
                <a href="admin.html" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center transition-colors">
                    <div class="text-2xl mb-2">âš™ï¸</div>
                    <div class="font-semibold">ç®¡ç†åå°</div>
                    <div class="text-sm text-purple-200">ç³»ç»Ÿç®¡ç†</div>
                </a>
                <a href="full-system-test.html" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center transition-colors">
                    <div class="text-2xl mb-2">ğŸ”§</div>
                    <div class="font-semibold">ç³»ç»Ÿæµ‹è¯•</div>
                    <div class="text-sm text-green-200">å®Œæ•´æµ‹è¯•</div>
                </a>
            </div>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-300 mb-4">ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-400 mb-2">é…ç½®ä¿¡æ¯</h4>
                    <div class="space-y-1 text-sm">
                        <div>Supabase URL: <span id="config-url" class="text-blue-400">åŠ è½½ä¸­...</span></div>
                        <div>é¡¹ç›®ID: <span id="config-project" class="text-blue-400">åŠ è½½ä¸­...</span></div>
                        <div>è¿æ¥æ¨¡å¼: <span class="text-green-400">å¢å¼ºæ¨¡å¼</span></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-400 mb-2">åŠŸèƒ½ç‰¹æ€§</h4>
                    <div class="space-y-1 text-sm">
                        <div>âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶</div>
                        <div>âœ… ç¦»çº¿æ•°æ®ç¼“å­˜</div>
                        <div>âœ… å®æ—¶æ•°æ®åŒæ­¥</div>
                        <div>âœ… é”™è¯¯è‡ªåŠ¨ä¿®å¤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="enhanced-supabase-connection.js"></script>
    <script src="final-config-verification.js"></script>

    <script>
        // ç³»ç»Ÿæ£€æŸ¥çŠ¶æ€
        let checkResults = {
            supabase: false,
            frontend: false,
            backend: false,
            network: false
        };

        // åˆå§‹åŒ–ç³»ç»Ÿæ£€æŸ¥
        async function initSystemCheck() {
            console.log('ğŸš€ å¼€å§‹ç³»ç»Ÿå°±ç»ªæ£€æŸ¥...');
            
            // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
            displayConfigInfo();
            
            // ä¾æ¬¡æ£€æŸ¥å„ä¸ªç»„ä»¶
            await checkSupabaseConnection();
            await checkFrontendFeatures();
            await checkBackendFeatures();
            await checkNetworkResilience();
            
            // æ›´æ–°æ€»ä½“çŠ¶æ€
            updateOverallStatus();
        }

        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        function displayConfigInfo() {
            if (window.SUPABASE_CONFIG) {
                const url = window.SUPABASE_CONFIG.SUPABASE_URL;
                const projectId = url ? url.split('//')[1].split('.')[0] : 'æœªçŸ¥';
                
                document.getElementById('config-url').textContent = url || 'æœªé…ç½®';
                document.getElementById('config-project').textContent = projectId;
            }
        }

        // æ£€æŸ¥ Supabase è¿æ¥
        async function checkSupabaseConnection() {
            const card = document.getElementById('supabase-card');
            const indicator = document.getElementById('supabase-indicator');
            const details = document.getElementById('supabase-details');
            
            try {
                console.log('ğŸ” æ£€æŸ¥ Supabase è¿æ¥...');
                
                const startTime = Date.now();
                const supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                const latency = Date.now() - startTime;
                
                if (error) {
                    throw error;
                }
                
                // æˆåŠŸ
                checkResults.supabase = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>URL: <span class="text-green-400">âœ… è¿æ¥æ­£å¸¸</span></div>
                    <div>çŠ¶æ€: <span class="text-green-400">âœ… åœ¨çº¿</span></div>
                    <div>å»¶è¿Ÿ: <span class="text-green-400">${latency}ms</span></div>
                `;
                
                console.log('âœ… Supabase è¿æ¥æ£€æŸ¥æˆåŠŸ');
                
            } catch (error) {
                console.error('âŒ Supabase è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>URL: <span class="text-red-400">âŒ è¿æ¥å¤±è´¥</span></div>
                    <div>çŠ¶æ€: <span class="text-red-400">âŒ ç¦»çº¿</span></div>
                    <div>é”™è¯¯: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // æ£€æŸ¥å‰ç«¯åŠŸèƒ½
        async function checkFrontendFeatures() {
            const card = document.getElementById('frontend-card');
            const indicator = document.getElementById('frontend-indicator');
            const details = document.getElementById('frontend-details');
            
            try {
                console.log('ğŸ¯ æ£€æŸ¥å‰ç«¯åŠŸèƒ½...');
                
                // æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®å‰ç«¯é¡µé¢
                const response = await fetch('index.html', { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error('å‰ç«¯é¡µé¢æ— æ³•è®¿é—®');
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿï¼‰
                const supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                // æµ‹è¯•è¡¨ç»“æ„
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                // æˆåŠŸ
                checkResults.frontend = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>ç”¨æˆ·æ³¨å†Œ: <span class="text-green-400">âœ… æ­£å¸¸</span></div>
                    <div>æŠ½å¥–åŠŸèƒ½: <span class="text-green-400">âœ… å°±ç»ª</span></div>
                    <div>æ•°æ®åŒæ­¥: <span class="text-green-400">âœ… æ­£å¸¸</span></div>
                `;
                
                console.log('âœ… å‰ç«¯åŠŸèƒ½æ£€æŸ¥æˆåŠŸ');
                
            } catch (error) {
                console.error('âŒ å‰ç«¯åŠŸèƒ½æ£€æŸ¥å¤±è´¥:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>ç”¨æˆ·æ³¨å†Œ: <span class="text-red-400">âŒ å¼‚å¸¸</span></div>
                    <div>æŠ½å¥–åŠŸèƒ½: <span class="text-red-400">âŒ å¼‚å¸¸</span></div>
                    <div>é”™è¯¯: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // æ£€æŸ¥åç«¯åŠŸèƒ½
        async function checkBackendFeatures() {
            const card = document.getElementById('backend-card');
            const indicator = document.getElementById('backend-indicator');
            const details = document.getElementById('backend-details');
            
            try {
                console.log('âš™ï¸ æ£€æŸ¥åç«¯ç®¡ç†åŠŸèƒ½...');
                
                // æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®ç®¡ç†é¡µé¢
                const response = await fetch('admin.html', { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error('ç®¡ç†é¡µé¢æ— æ³•è®¿é—®');
                }
                
                // æ£€æŸ¥ç®¡ç†åŠŸèƒ½ï¼ˆä½¿ç”¨ service role key å¦‚æœå¯ç”¨ï¼‰
                const supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_SERVICE_ROLE_KEY || window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                // æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                // æˆåŠŸ
                checkResults.backend = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>ç”¨æˆ·ç®¡ç†: <span class="text-green-400">âœ… æ­£å¸¸</span></div>
                    <div>æ•°æ®æŸ¥è¯¢: <span class="text-green-400">âœ… æ­£å¸¸</span></div>
                    <div>ç³»ç»Ÿé…ç½®: <span class="text-green-400">âœ… å°±ç»ª</span></div>
                `;
                
                console.log('âœ… åç«¯ç®¡ç†åŠŸèƒ½æ£€æŸ¥æˆåŠŸ');
                
            } catch (error) {
                console.error('âŒ åç«¯ç®¡ç†åŠŸèƒ½æ£€æŸ¥å¤±è´¥:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>ç”¨æˆ·ç®¡ç†: <span class="text-red-400">âŒ å¼‚å¸¸</span></div>
                    <div>æ•°æ®æŸ¥è¯¢: <span class="text-red-400">âŒ å¼‚å¸¸</span></div>
                    <div>é”™è¯¯: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // æ£€æŸ¥ç½‘ç»œéŸ§æ€§
        async function checkNetworkResilience() {
            const card = document.getElementById('network-card');
            const indicator = document.getElementById('network-indicator');
            const details = document.getElementById('network-details');
            
            try {
                console.log('ğŸ“¡ æ£€æŸ¥ç½‘ç»œéŸ§æ€§...');
                
                // æ£€æŸ¥å¢å¼ºè¿æ¥ç®¡ç†å™¨
                let enhancedConnectionAvailable = false;
                if (window.EnhancedSupabaseConnection) {
                    enhancedConnectionAvailable = true;
                }
                
                // æµ‹è¯•åŸºç¡€ç½‘ç»œè¿æ¥
                const response = await fetch(window.SUPABASE_CONFIG.SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥: ${response.status}`);
                }
                
                // æˆåŠŸ
                checkResults.network = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>è¿æ¥ç¨³å®šæ€§: <span class="text-green-400">âœ… ç¨³å®š</span></div>
                    <div>é‡è¿æœºåˆ¶: <span class="text-green-400">âœ… ${enhancedConnectionAvailable ? 'å¢å¼ºæ¨¡å¼' : 'åŸºç¡€æ¨¡å¼'}</span></div>
                    <div>ç¦»çº¿æ”¯æŒ: <span class="text-green-400">âœ… æ”¯æŒ</span></div>
                `;
                
                console.log('âœ… ç½‘ç»œéŸ§æ€§æ£€æŸ¥æˆåŠŸ');
                
            } catch (error) {
                console.error('âŒ ç½‘ç»œéŸ§æ€§æ£€æŸ¥å¤±è´¥:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>è¿æ¥ç¨³å®šæ€§: <span class="text-red-400">âŒ ä¸ç¨³å®š</span></div>
                    <div>é‡è¿æœºåˆ¶: <span class="text-red-400">âŒ å¼‚å¸¸</span></div>
                    <div>é”™è¯¯: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // æ›´æ–°æ€»ä½“çŠ¶æ€
        function updateOverallStatus() {
            const overallStatus = document.getElementById('overall-status');
            const overallText = document.getElementById('overall-text');
            const overallDescription = document.getElementById('overall-description');
            
            const totalChecks = Object.keys(checkResults).length;
            const passedChecks = Object.values(checkResults).filter(result => result).length;
            const successRate = (passedChecks / totalChecks * 100).toFixed(0);
            
            if (passedChecks === totalChecks) {
                // å…¨éƒ¨é€šè¿‡
                overallStatus.innerHTML = `
                    <span class="status-indicator status-ready"></span>
                    <span class="text-green-400">ç³»ç»Ÿå°±ç»ª âœ…</span>
                `;
                overallDescription.textContent = 'æ‰€æœ‰ç³»ç»Ÿç»„ä»¶è¿è¡Œæ­£å¸¸ï¼Œå‰åç«¯æ•°æ®è¿æ¥ç¨³å®šï¼Œæ”¯æŒæœ‰ç½‘æ— ç½‘æŒç»­è¿è¡Œã€‚';
            } else if (passedChecks > 0) {
                // éƒ¨åˆ†é€šè¿‡
                overallStatus.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    <span class="text-yellow-400">éƒ¨åˆ†å°±ç»ª âš ï¸</span>
                `;
                overallDescription.textContent = `${passedChecks}/${totalChecks} ä¸ªç»„ä»¶æ­£å¸¸è¿è¡Œ (${successRate}%)ï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„ç»„ä»¶ã€‚`;
            } else {
                // å…¨éƒ¨å¤±è´¥
                overallStatus.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    <span class="text-red-400">ç³»ç»Ÿå¼‚å¸¸ âŒ</span>
                `;
                overallDescription.textContent = 'ç³»ç»Ÿå­˜åœ¨ä¸¥é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œè¿æ¥ã€‚';
            }
            
            console.log(`ğŸ“Š ç³»ç»Ÿæ£€æŸ¥å®Œæˆ: ${passedChecks}/${totalChecks} é€šè¿‡ (${successRate}%)`);
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initSystemCheck, 1000); // å»¶è¿Ÿ1ç§’å¼€å§‹æ£€æŸ¥ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        });
    </script>
</body>
</html>