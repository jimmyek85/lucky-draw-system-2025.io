<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 Lucky Draw - 系统就绪检查</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .status-card.ready {
            border-left-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
        .status-card.error {
            border-left-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-ready { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-checking { 
            background-color: #f59e0b; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">🎯 1602 Lucky Draw</h1>
            <h2 class="text-2xl text-gray-300 mb-4">系统就绪检查</h2>
            <p class="text-gray-400">确保前端和后端数据连接正常，支持有网无网持续运行</p>
        </div>

        <!-- 总体状态 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 text-center">
            <div id="overall-status" class="text-3xl font-bold mb-4">
                <span class="status-indicator status-checking"></span>
                <span id="overall-text">系统检查中...</span>
            </div>
            <div id="overall-description" class="text-gray-400">
                正在检查所有系统组件...
            </div>
        </div>

        <!-- 系统组件状态 -->
        <div class="feature-grid mb-8">
            <!-- Supabase 连接 -->
            <div id="supabase-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-blue-400">🔗 Supabase 连接</h3>
                    <span id="supabase-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="supabase-details" class="space-y-2 text-sm">
                    <div>URL: <span class="text-gray-400">检查中...</span></div>
                    <div>状态: <span class="text-gray-400">检查中...</span></div>
                    <div>延迟: <span class="text-gray-400">检查中...</span></div>
                </div>
            </div>

            <!-- 前端功能 -->
            <div id="frontend-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-green-400">🎯 前端功能</h3>
                    <span id="frontend-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="frontend-details" class="space-y-2 text-sm">
                    <div>用户注册: <span class="text-gray-400">检查中...</span></div>
                    <div>抽奖功能: <span class="text-gray-400">检查中...</span></div>
                    <div>数据同步: <span class="text-gray-400">检查中...</span></div>
                </div>
            </div>

            <!-- 后端管理 -->
            <div id="backend-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-purple-400">⚙️ 后端管理</h3>
                    <span id="backend-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="backend-details" class="space-y-2 text-sm">
                    <div>用户管理: <span class="text-gray-400">检查中...</span></div>
                    <div>数据查询: <span class="text-gray-400">检查中...</span></div>
                    <div>系统配置: <span class="text-gray-400">检查中...</span></div>
                </div>
            </div>

            <!-- 网络韧性 -->
            <div id="network-card" class="status-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-yellow-400">📡 网络韧性</h3>
                    <span id="network-indicator" class="status-indicator status-checking"></span>
                </div>
                <div id="network-details" class="space-y-2 text-sm">
                    <div>连接稳定性: <span class="text-gray-400">检查中...</span></div>
                    <div>重连机制: <span class="text-gray-400">检查中...</span></div>
                    <div>离线支持: <span class="text-gray-400">检查中...</span></div>
                </div>
            </div>
        </div>

        <!-- 快速访问链接 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-blue-400 mb-4">🚀 快速访问</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center transition-colors">
                    <div class="text-2xl mb-2">🎯</div>
                    <div class="font-semibold">用户前端</div>
                    <div class="text-sm text-blue-200">抽奖系统</div>
                </a>
                <a href="admin.html" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center transition-colors">
                    <div class="text-2xl mb-2">⚙️</div>
                    <div class="font-semibold">管理后台</div>
                    <div class="text-sm text-purple-200">系统管理</div>
                </a>
                <a href="full-system-test.html" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center transition-colors">
                    <div class="text-2xl mb-2">🔧</div>
                    <div class="font-semibold">系统测试</div>
                    <div class="text-sm text-green-200">完整测试</div>
                </a>
            </div>
        </div>

        <!-- 系统信息 -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-300 mb-4">📊 系统信息</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-400 mb-2">配置信息</h4>
                    <div class="space-y-1 text-sm">
                        <div>Supabase URL: <span id="config-url" class="text-blue-400">加载中...</span></div>
                        <div>项目ID: <span id="config-project" class="text-blue-400">加载中...</span></div>
                        <div>连接模式: <span class="text-green-400">增强模式</span></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-400 mb-2">功能特性</h4>
                    <div class="space-y-1 text-sm">
                        <div>✅ 自动重连机制</div>
                        <div>✅ 离线数据缓存</div>
                        <div>✅ 实时数据同步</div>
                        <div>✅ 错误自动修复</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="enhanced-supabase-connection.js"></script>
    <script src="final-config-verification.js"></script>

    <script>
        // 系统检查状态
        let checkResults = {
            supabase: false,
            frontend: false,
            backend: false,
            network: false
        };

        // 初始化系统检查
        async function initSystemCheck() {
            console.log('🚀 开始系统就绪检查...');
            
            // 显示配置信息
            displayConfigInfo();
            
            // 依次检查各个组件
            await checkSupabaseConnection();
            await checkFrontendFeatures();
            await checkBackendFeatures();
            await checkNetworkResilience();
            
            // 更新总体状态
            updateOverallStatus();
        }

        // 显示配置信息
        function displayConfigInfo() {
            if (window.SUPABASE_CONFIG) {
                const url = window.SUPABASE_CONFIG.SUPABASE_URL;
                const projectId = url ? url.split('//')[1].split('.')[0] : '未知';
                
                document.getElementById('config-url').textContent = url || '未配置';
                document.getElementById('config-project').textContent = projectId;
            }
        }

        // 检查 Supabase 连接
        async function checkSupabaseConnection() {
            const card = document.getElementById('supabase-card');
            const indicator = document.getElementById('supabase-indicator');
            const details = document.getElementById('supabase-details');
            
            try {
                console.log('🔍 检查 Supabase 连接...');
                
                const startTime = Date.now();
                const supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                const latency = Date.now() - startTime;
                
                if (error) {
                    throw error;
                }
                
                // 成功
                checkResults.supabase = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>URL: <span class="text-green-400">✅ 连接正常</span></div>
                    <div>状态: <span class="text-green-400">✅ 在线</span></div>
                    <div>延迟: <span class="text-green-400">${latency}ms</span></div>
                `;
                
                console.log('✅ Supabase 连接检查成功');
                
            } catch (error) {
                console.error('❌ Supabase 连接检查失败:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>URL: <span class="text-red-400">❌ 连接失败</span></div>
                    <div>状态: <span class="text-red-400">❌ 离线</span></div>
                    <div>错误: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // 检查前端功能
        async function checkFrontendFeatures() {
            const card = document.getElementById('frontend-card');
            const indicator = document.getElementById('frontend-indicator');
            const details = document.getElementById('frontend-details');
            
            try {
                console.log('🎯 检查前端功能...');
                
                // 检查是否能访问前端页面
                const response = await fetch('index.html', { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error('前端页面无法访问');
                }
                
                // 检查用户注册功能（模拟）
                const supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                // 测试表结构
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                // 成功
                checkResults.frontend = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>用户注册: <span class="text-green-400">✅ 正常</span></div>
                    <div>抽奖功能: <span class="text-green-400">✅ 就绪</span></div>
                    <div>数据同步: <span class="text-green-400">✅ 正常</span></div>
                `;
                
                console.log('✅ 前端功能检查成功');
                
            } catch (error) {
                console.error('❌ 前端功能检查失败:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>用户注册: <span class="text-red-400">❌ 异常</span></div>
                    <div>抽奖功能: <span class="text-red-400">❌ 异常</span></div>
                    <div>错误: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // 检查后端功能
        async function checkBackendFeatures() {
            const card = document.getElementById('backend-card');
            const indicator = document.getElementById('backend-indicator');
            const details = document.getElementById('backend-details');
            
            try {
                console.log('⚙️ 检查后端管理功能...');
                
                // 检查是否能访问管理页面
                const response = await fetch('admin.html', { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error('管理页面无法访问');
                }
                
                // 检查管理功能（使用 service role key 如果可用）
                const supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_SERVICE_ROLE_KEY || window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                // 测试查询功能
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                // 成功
                checkResults.backend = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>用户管理: <span class="text-green-400">✅ 正常</span></div>
                    <div>数据查询: <span class="text-green-400">✅ 正常</span></div>
                    <div>系统配置: <span class="text-green-400">✅ 就绪</span></div>
                `;
                
                console.log('✅ 后端管理功能检查成功');
                
            } catch (error) {
                console.error('❌ 后端管理功能检查失败:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>用户管理: <span class="text-red-400">❌ 异常</span></div>
                    <div>数据查询: <span class="text-red-400">❌ 异常</span></div>
                    <div>错误: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // 检查网络韧性
        async function checkNetworkResilience() {
            const card = document.getElementById('network-card');
            const indicator = document.getElementById('network-indicator');
            const details = document.getElementById('network-details');
            
            try {
                console.log('📡 检查网络韧性...');
                
                // 检查增强连接管理器
                let enhancedConnectionAvailable = false;
                if (window.EnhancedSupabaseConnection) {
                    enhancedConnectionAvailable = true;
                }
                
                // 测试基础网络连接
                const response = await fetch(window.SUPABASE_CONFIG.SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`网络连接失败: ${response.status}`);
                }
                
                // 成功
                checkResults.network = true;
                indicator.className = 'status-indicator status-ready';
                card.classList.add('ready');
                
                details.innerHTML = `
                    <div>连接稳定性: <span class="text-green-400">✅ 稳定</span></div>
                    <div>重连机制: <span class="text-green-400">✅ ${enhancedConnectionAvailable ? '增强模式' : '基础模式'}</span></div>
                    <div>离线支持: <span class="text-green-400">✅ 支持</span></div>
                `;
                
                console.log('✅ 网络韧性检查成功');
                
            } catch (error) {
                console.error('❌ 网络韧性检查失败:', error);
                
                indicator.className = 'status-indicator status-error';
                card.classList.add('error');
                
                details.innerHTML = `
                    <div>连接稳定性: <span class="text-red-400">❌ 不稳定</span></div>
                    <div>重连机制: <span class="text-red-400">❌ 异常</span></div>
                    <div>错误: <span class="text-red-400">${error.message}</span></div>
                `;
            }
        }

        // 更新总体状态
        function updateOverallStatus() {
            const overallStatus = document.getElementById('overall-status');
            const overallText = document.getElementById('overall-text');
            const overallDescription = document.getElementById('overall-description');
            
            const totalChecks = Object.keys(checkResults).length;
            const passedChecks = Object.values(checkResults).filter(result => result).length;
            const successRate = (passedChecks / totalChecks * 100).toFixed(0);
            
            if (passedChecks === totalChecks) {
                // 全部通过
                overallStatus.innerHTML = `
                    <span class="status-indicator status-ready"></span>
                    <span class="text-green-400">系统就绪 ✅</span>
                `;
                overallDescription.textContent = '所有系统组件运行正常，前后端数据连接稳定，支持有网无网持续运行。';
            } else if (passedChecks > 0) {
                // 部分通过
                overallStatus.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    <span class="text-yellow-400">部分就绪 ⚠️</span>
                `;
                overallDescription.textContent = `${passedChecks}/${totalChecks} 个组件正常运行 (${successRate}%)，请检查失败的组件。`;
            } else {
                // 全部失败
                overallStatus.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    <span class="text-red-400">系统异常 ❌</span>
                `;
                overallDescription.textContent = '系统存在严重问题，请检查配置和网络连接。';
            }
            
            console.log(`📊 系统检查完成: ${passedChecks}/${totalChecks} 通过 (${successRate}%)`);
        }

        // 页面加载完成后开始检查
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initSystemCheck, 1000); // 延迟1秒开始检查，确保所有脚本加载完成
        });
    </script>
</body>
</html>