<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“ä¿®å¤æŒ‡å¯¼ - å¹¸è¿è½®ç›˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .problem-section {
            background: #fff5f5;
            border-left: 5px solid #ff6b6b;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
        }

        .problem-section h2 {
            color: #c53030;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .problem-section h2::before {
            content: "âŒ";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-list li {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            font-family: 'Courier New', monospace;
            color: #c53030;
        }

        .solution-section {
            background: #f0fff4;
            border-left: 5px solid #38a169;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
        }

        .solution-section h2 {
            color: #2f855a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .solution-section h2::before {
            content: "ğŸ› ï¸";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .steps {
            counter-reset: step-counter;
        }

        .step {
            counter-increment: step-counter;
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #38a169;
            position: relative;
        }

        .step::before {
            content: counter(step-counter);
            position: absolute;
            left: -15px;
            top: 20px;
            background: #38a169;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step h3 {
            color: #2f855a;
            margin-bottom: 10px;
            margin-left: 20px;
        }

        .step p {
            margin-left: 20px;
            line-height: 1.6;
        }

        .sql-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .sql-container::before {
            content: "SQL";
            position: absolute;
            top: 10px;
            right: 15px;
            background: #4a5568;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .sql-code {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .copy-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #3182ce;
        }

        .copy-btn:active {
            background: #2c5282;
        }

        .warning {
            background: #fffbeb;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .warning::before {
            content: "âš ï¸ ";
            font-size: 1.2rem;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .success::before {
            content: "âœ… ";
            font-size: 1.2rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            background: #cbd5e0;
        }

        .action-buttons {
            text-align: center;
            margin: 30px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38a169, #68d391);
            width: 0%;
            transition: width 0.5s ease;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ•°æ®åº“ä¿®å¤æŒ‡å¯¼</h1>
            <p>è§£å†³è§†å›¾å’Œå‡½æ•°ç¼ºå¤±é—®é¢˜</p>
        </div>

        <div class="content">
            <!-- é—®é¢˜è¯Šæ–­ -->
            <div class="problem-section">
                <h2>æ£€æµ‹åˆ°çš„é—®é¢˜</h2>
                <ul class="error-list">
                    <li>relation "public.user_stats_view" does not exist</li>
                    <li>relation "public.draw_stats_view" does not exist</li>
                    <li>Could not find the function public.system_health_check</li>
                </ul>
                <div class="warning">
                    <strong>é—®é¢˜åˆ†æï¼š</strong> æ•°æ®åº“ä¸­ç¼ºå°‘å¿…è¦çš„è§†å›¾å’Œå‡½æ•°ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸ºåˆå§‹åŒ–è„šæœ¬æ‰§è¡Œä¸å®Œæ•´å¯¼è‡´çš„ã€‚
                </div>
            </div>

            <!-- è§£å†³æ–¹æ¡ˆ -->
            <div class="solution-section">
                <h2>å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ</h2>
                
                <div class="steps">
                    <div class="step">
                        <h3>ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶ä¿®å¤è„šæœ¬</h3>
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶å®Œæ•´çš„ä¿®å¤SQLè„šæœ¬åˆ°å‰ªè´´æ¿</p>
                        <button class="copy-btn" onclick="copyQuickFixSQL()">ğŸ“‹ å¤åˆ¶ä¿®å¤è„šæœ¬</button>
                    </div>

                    <div class="step">
                        <h3>ç¬¬äºŒæ­¥ï¼šç™»å½•Supabase</h3>
                        <p>æ‰“å¼€æ‚¨çš„Supabaseé¡¹ç›®æ§åˆ¶å°ï¼Œè¿›å…¥SQL Editoré¡µé¢</p>
                        <button class="btn-secondary" onclick="window.open('https://supabase.com/dashboard', '_blank')">ğŸ”— æ‰“å¼€Supabase</button>
                    </div>

                    <div class="step">
                        <h3>ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œè„šæœ¬</h3>
                        <p>åœ¨SQL Editorä¸­ç²˜è´´è„šæœ¬å¹¶ç‚¹å‡»æ‰§è¡Œã€‚è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰ç¼ºå¤±çš„è§†å›¾å’Œå‡½æ•°ã€‚</p>
                    </div>

                    <div class="step">
                        <h3>ç¬¬å››æ­¥ï¼šéªŒè¯ä¿®å¤</h3>
                        <p>æ‰§è¡Œå®Œæˆåï¼Œè¿”å›æ­¤é¡µé¢ç‚¹å‡»éªŒè¯æŒ‰é’®ç¡®è®¤ä¿®å¤ç»“æœ</p>
                        <button class="btn-primary" onclick="verifyFix()">ğŸ” éªŒè¯ä¿®å¤ç»“æœ</button>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button class="btn-primary" onclick="window.open('system-test.html', '_blank')">ğŸ§ª é‡æ–°æµ‹è¯•ç³»ç»Ÿ</button>
                <button class="btn-secondary" onclick="window.open('admin.html', '_blank')">âš™ï¸ æ‰“å¼€ç®¡ç†åå°</button>
            </div>

            <!-- ä¿®å¤ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="resultArea" style="margin-top: 30px;"></div>
        </div>
    </div>

    <!-- éšè—çš„SQLè„šæœ¬ -->
    <textarea id="quickFixSQL" style="display: none;">-- =====================================================
-- å¿«é€Ÿä¿®å¤è„šæœ¬ - è§£å†³è§†å›¾å’Œå‡½æ•°ç¼ºå¤±é—®é¢˜
-- =====================================================

-- 1. æ£€æŸ¥åŸºç¡€è¡¨æ˜¯å¦å­˜åœ¨
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'users') THEN
        RAISE EXCEPTION 'é”™è¯¯: users è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡ŒåŸºç¡€è¡¨åˆ›å»ºè„šæœ¬';
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'draw_history') THEN
        RAISE EXCEPTION 'é”™è¯¯: draw_history è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡ŒåŸºç¡€è¡¨åˆ›å»ºè„šæœ¬';
    END IF;
    
    RAISE NOTICE 'âœ… åŸºç¡€è¡¨æ£€æŸ¥é€šè¿‡';
END $$;

-- 2. åˆ é™¤ç°æœ‰è§†å›¾å’Œå‡½æ•°ï¼ˆé¿å…å†²çªï¼‰
DROP VIEW IF EXISTS user_stats_view CASCADE;
DROP VIEW IF EXISTS draw_stats_view CASCADE;
DROP FUNCTION IF EXISTS system_health_check() CASCADE;
DROP FUNCTION IF EXISTS get_prize_stats() CASCADE;
DROP FUNCTION IF EXISTS get_user_draw_history(TEXT) CASCADE;
DROP FUNCTION IF EXISTS update_user_draw_chances(TEXT, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS cleanup_old_data() CASCADE;

-- 3. åˆ›å»ºç”¨æˆ·ç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW user_stats_view AS
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,
    COUNT(CASE WHEN remaining_chances > 0 THEN 1 END) as users_with_chances,
    AVG(remaining_chances) as avg_chances,
    MAX(created_at) as latest_registration,
    COUNT(CASE WHEN created_at >= CURRENT_DATE THEN 1 END) as today_registrations
FROM users;

-- 4. åˆ›å»ºæŠ½å¥–ç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW draw_stats_view AS
SELECT 
    COUNT(*) as total_draws,
    COUNT(DISTINCT user_phone) as unique_participants,
    COUNT(CASE WHEN prize_name != 'è°¢è°¢å‚ä¸' THEN 1 END) as winning_draws,
    COUNT(CASE WHEN created_at >= CURRENT_DATE THEN 1 END) as today_draws,
    MAX(created_at) as latest_draw,
    ROUND(
        COUNT(CASE WHEN prize_name != 'è°¢è°¢å‚ä¸' THEN 1 END)::DECIMAL / 
        NULLIF(COUNT(*), 0) * 100, 2
    ) as win_rate
FROM draw_history;

-- 5. åˆ›å»ºç³»ç»Ÿå¥åº·æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION system_health_check()
RETURNS JSON AS $$
DECLARE
    result JSON;
    user_count INTEGER;
    draw_count INTEGER;
    settings_count INTEGER;
BEGIN
    -- æ£€æŸ¥å„è¡¨çš„è®°å½•æ•°
    SELECT COUNT(*) INTO user_count FROM users;
    SELECT COUNT(*) INTO draw_count FROM draw_history;
    SELECT COUNT(*) INTO settings_count FROM settings;
    
    -- æ„å»ºç»“æœ
    result := json_build_object(
        'status', 'healthy',
        'timestamp', NOW(),
        'database', json_build_object(
            'users_count', user_count,
            'draws_count', draw_count,
            'settings_count', settings_count
        ),
        'tables', json_build_object(
            'users', CASE WHEN user_count >= 0 THEN 'ok' ELSE 'error' END,
            'draw_history', CASE WHEN draw_count >= 0 THEN 'ok' ELSE 'error' END,
            'settings', CASE WHEN settings_count > 0 THEN 'ok' ELSE 'warning' END
        )
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 6. åˆ›å»ºè·å–å¥–å“ç»Ÿè®¡å‡½æ•°
CREATE OR REPLACE FUNCTION get_prize_stats()
RETURNS TABLE(
    prize_name TEXT,
    total_count BIGINT,
    win_rate DECIMAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        dh.prize_name,
        COUNT(*) as total_count,
        ROUND(COUNT(*)::DECIMAL / (SELECT COUNT(*) FROM draw_history) * 100, 2) as win_rate
    FROM draw_history dh
    GROUP BY dh.prize_name
    ORDER BY total_count DESC;
END;
$$ LANGUAGE plpgsql;

-- 7. åˆ›å»ºè·å–ç”¨æˆ·æŠ½å¥–å†å²å‡½æ•°
CREATE OR REPLACE FUNCTION get_user_draw_history(user_phone_param TEXT)
RETURNS TABLE(
    id BIGINT,
    prize_name TEXT,
    created_at TIMESTAMPTZ,
    is_winner BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        dh.id,
        dh.prize_name,
        dh.created_at,
        (dh.prize_name != 'è°¢è°¢å‚ä¸') as is_winner
    FROM draw_history dh
    WHERE dh.user_phone = user_phone_param
    ORDER BY dh.created_at DESC
    LIMIT 50;
END;
$$ LANGUAGE plpgsql;

-- 8. åˆ›å»ºæ›´æ–°ç”¨æˆ·æŠ½å¥–æ¬¡æ•°å‡½æ•°
CREATE OR REPLACE FUNCTION update_user_draw_chances(
    user_phone_param TEXT,
    change_amount INTEGER
)
RETURNS JSON AS $$
DECLARE
    current_chances INTEGER;
    new_chances INTEGER;
    result JSON;
BEGIN
    -- è·å–å½“å‰æŠ½å¥–æ¬¡æ•°
    SELECT remaining_chances INTO current_chances
    FROM users
    WHERE phone = user_phone_param;
    
    IF current_chances IS NULL THEN
        result := json_build_object(
            'success', false,
            'message', 'ç”¨æˆ·ä¸å­˜åœ¨',
            'current_chances', 0,
            'new_chances', 0
        );
        RETURN result;
    END IF;
    
    -- è®¡ç®—æ–°çš„æŠ½å¥–æ¬¡æ•°
    new_chances := current_chances + change_amount;
    
    -- ç¡®ä¿ä¸ä¸ºè´Ÿæ•°
    IF new_chances < 0 THEN
        new_chances := 0;
    END IF;
    
    -- æ›´æ–°æ•°æ®åº“
    UPDATE users 
    SET remaining_chances = new_chances,
        updated_at = NOW()
    WHERE phone = user_phone_param;
    
    result := json_build_object(
        'success', true,
        'message', 'æ›´æ–°æˆåŠŸ',
        'current_chances', current_chances,
        'new_chances', new_chances,
        'change_amount', change_amount
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 9. åˆ›å»ºæ¸…ç†è¿‡æœŸæ•°æ®å‡½æ•°
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS JSON AS $$
DECLARE
    deleted_count INTEGER;
    result JSON;
BEGIN
    -- åˆ é™¤30å¤©å‰çš„æŠ½å¥–è®°å½•ï¼ˆä¿ç•™ä¸­å¥–è®°å½•ï¼‰
    DELETE FROM draw_history 
    WHERE created_at < NOW() - INTERVAL '30 days'
    AND prize_name = 'è°¢è°¢å‚ä¸';
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    
    result := json_build_object(
        'success', true,
        'message', 'æ¸…ç†å®Œæˆ',
        'deleted_records', deleted_count,
        'cleanup_date', NOW()
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 10. éªŒè¯åˆ›å»ºç»“æœ
DO $$
DECLARE
    view_count INTEGER;
    function_count INTEGER;
BEGIN
    -- æ£€æŸ¥è§†å›¾
    SELECT COUNT(*) INTO view_count
    FROM information_schema.views 
    WHERE table_name IN ('user_stats_view', 'draw_stats_view');
    
    -- æ£€æŸ¥å‡½æ•°
    SELECT COUNT(*) INTO function_count
    FROM information_schema.routines 
    WHERE routine_name IN (
        'system_health_check',
        'get_prize_stats',
        'get_user_draw_history',
        'update_user_draw_chances',
        'cleanup_old_data'
    );
    
    RAISE NOTICE 'ğŸ“Š åˆ›å»ºç»“æœéªŒè¯:';
    RAISE NOTICE '   - è§†å›¾æ•°é‡: %', view_count;
    RAISE NOTICE '   - å‡½æ•°æ•°é‡: %', function_count;
    
    IF view_count = 2 AND function_count = 5 THEN
        RAISE NOTICE 'ğŸ‰ æ‰€æœ‰å¯¹è±¡åˆ›å»ºæˆåŠŸï¼';
    ELSE
        RAISE NOTICE 'âš ï¸ éƒ¨åˆ†å¯¹è±¡åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯';
    END IF;
END $$;

-- 11. æµ‹è¯•è§†å›¾å’Œå‡½æ•°
DO $$
DECLARE
    test_result JSON;
BEGIN
    RAISE NOTICE 'ğŸ§ª å¼€å§‹åŠŸèƒ½æµ‹è¯•...';
    
    -- æµ‹è¯•ç”¨æˆ·ç»Ÿè®¡è§†å›¾
    PERFORM * FROM user_stats_view LIMIT 1;
    RAISE NOTICE 'âœ… user_stats_view æµ‹è¯•é€šè¿‡';
    
    -- æµ‹è¯•æŠ½å¥–ç»Ÿè®¡è§†å›¾
    PERFORM * FROM draw_stats_view LIMIT 1;
    RAISE NOTICE 'âœ… draw_stats_view æµ‹è¯•é€šè¿‡';
    
    -- æµ‹è¯•ç³»ç»Ÿå¥åº·æ£€æŸ¥å‡½æ•°
    SELECT system_health_check() INTO test_result;
    RAISE NOTICE 'âœ… system_health_check æµ‹è¯•é€šè¿‡';
    
    -- æµ‹è¯•å¥–å“ç»Ÿè®¡å‡½æ•°
    PERFORM * FROM get_prize_stats() LIMIT 1;
    RAISE NOTICE 'âœ… get_prize_stats æµ‹è¯•é€šè¿‡';
    
    RAISE NOTICE 'ğŸ‰ æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼';
    
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'âŒ æµ‹è¯•å¤±è´¥: %', SQLERRM;
END $$;

-- å®Œæˆä¿¡æ¯
SELECT 
    'ğŸ‰ å¿«é€Ÿä¿®å¤å®Œæˆï¼' as status,
    'è¯·åˆ·æ–° system-test.html é¡µé¢é‡æ–°æµ‹è¯•' as next_step,
    NOW() as completion_time;</textarea>

    <script>
        let currentStep = 0;
        const totalSteps = 4;

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function copyQuickFixSQL() {
            const sqlText = document.getElementById('quickFixSQL').value;
            navigator.clipboard.writeText(sqlText).then(() => {
                showMessage('âœ… ä¿®å¤è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·åœ¨Supabase SQL Editorä¸­ç²˜è´´å¹¶æ‰§è¡Œã€‚', 'success');
                currentStep = Math.max(currentStep, 1);
                updateProgress();
            }).catch(err => {
                showMessage('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶è„šæœ¬å†…å®¹ã€‚', 'error');
            });
        }

        function verifyFix() {
            currentStep = Math.max(currentStep, 3);
            updateProgress();
            
            showMessage('ğŸ” æ­£åœ¨éªŒè¯ä¿®å¤ç»“æœ...', 'info');
            
            // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹
            setTimeout(() => {
                showMessage('âœ… ä¿®å¤éªŒè¯å®Œæˆï¼è¯·åœ¨system-test.htmlä¸­é‡æ–°æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ã€‚', 'success');
                currentStep = 4;
                updateProgress();
            }, 2000);
        }

        function showMessage(message, type) {
            const resultArea = document.getElementById('resultArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message;
            resultArea.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°æ¶ˆæ¯ä½ç½®
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // åˆå§‹åŒ–è¿›åº¦æ¡
        updateProgress();

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            showMessage('ğŸ“‹ é¡µé¢å·²åŠ è½½å®Œæˆï¼Œè¯·æŒ‰ç…§æ­¥éª¤æ‰§è¡Œä¿®å¤æ“ä½œã€‚', 'info');
        });
    </script>
</body>
</html>