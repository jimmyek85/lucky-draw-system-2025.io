<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库修复指导 - 幸运轮盘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .problem-section {
            background: #fff5f5;
            border-left: 5px solid #ff6b6b;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
        }

        .problem-section h2 {
            color: #c53030;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .problem-section h2::before {
            content: "❌";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-list li {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            font-family: 'Courier New', monospace;
            color: #c53030;
        }

        .solution-section {
            background: #f0fff4;
            border-left: 5px solid #38a169;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
        }

        .solution-section h2 {
            color: #2f855a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .solution-section h2::before {
            content: "🛠️";
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .steps {
            counter-reset: step-counter;
        }

        .step {
            counter-increment: step-counter;
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #38a169;
            position: relative;
        }

        .step::before {
            content: counter(step-counter);
            position: absolute;
            left: -15px;
            top: 20px;
            background: #38a169;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step h3 {
            color: #2f855a;
            margin-bottom: 10px;
            margin-left: 20px;
        }

        .step p {
            margin-left: 20px;
            line-height: 1.6;
        }

        .sql-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .sql-container::before {
            content: "SQL";
            position: absolute;
            top: 10px;
            right: 15px;
            background: #4a5568;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .sql-code {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .copy-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #3182ce;
        }

        .copy-btn:active {
            background: #2c5282;
        }

        .warning {
            background: #fffbeb;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .warning::before {
            content: "⚠️ ";
            font-size: 1.2rem;
        }

        .success {
            background: #f0fff4;
            border: 1px solid #68d391;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .success::before {
            content: "✅ ";
            font-size: 1.2rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            background: #cbd5e0;
        }

        .action-buttons {
            text-align: center;
            margin: 30px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #38a169, #68d391);
            width: 0%;
            transition: width 0.5s ease;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 数据库修复指导</h1>
            <p>解决视图和函数缺失问题</p>
        </div>

        <div class="content">
            <!-- 问题诊断 -->
            <div class="problem-section">
                <h2>检测到的问题</h2>
                <ul class="error-list">
                    <li>relation "public.user_stats_view" does not exist</li>
                    <li>relation "public.draw_stats_view" does not exist</li>
                    <li>Could not find the function public.system_health_check</li>
                </ul>
                <div class="warning">
                    <strong>问题分析：</strong> 数据库中缺少必要的视图和函数，这通常是因为初始化脚本执行不完整导致的。
                </div>
            </div>

            <!-- 解决方案 -->
            <div class="solution-section">
                <h2>快速修复方案</h2>
                
                <div class="steps">
                    <div class="step">
                        <h3>第一步：复制修复脚本</h3>
                        <p>点击下方按钮复制完整的修复SQL脚本到剪贴板</p>
                        <button class="copy-btn" onclick="copyQuickFixSQL()">📋 复制修复脚本</button>
                    </div>

                    <div class="step">
                        <h3>第二步：登录Supabase</h3>
                        <p>打开您的Supabase项目控制台，进入SQL Editor页面</p>
                        <button class="btn-secondary" onclick="window.open('https://supabase.com/dashboard', '_blank')">🔗 打开Supabase</button>
                    </div>

                    <div class="step">
                        <h3>第三步：执行脚本</h3>
                        <p>在SQL Editor中粘贴脚本并点击执行。脚本会自动创建所有缺失的视图和函数。</p>
                    </div>

                    <div class="step">
                        <h3>第四步：验证修复</h3>
                        <p>执行完成后，返回此页面点击验证按钮确认修复结果</p>
                        <button class="btn-primary" onclick="verifyFix()">🔍 验证修复结果</button>
                    </div>
                </div>
            </div>

            <!-- 进度条 -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- 操作按钮 -->
            <div class="action-buttons">
                <button class="btn-primary" onclick="window.open('system-test.html', '_blank')">🧪 重新测试系统</button>
                <button class="btn-secondary" onclick="window.open('admin.html', '_blank')">⚙️ 打开管理后台</button>
            </div>

            <!-- 修复结果显示区域 -->
            <div id="resultArea" style="margin-top: 30px;"></div>
        </div>
    </div>

    <!-- 隐藏的SQL脚本 -->
    <textarea id="quickFixSQL" style="display: none;">-- =====================================================
-- 快速修复脚本 - 解决视图和函数缺失问题
-- =====================================================

-- 1. 检查基础表是否存在
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'users') THEN
        RAISE EXCEPTION '错误: users 表不存在，请先执行基础表创建脚本';
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'draw_history') THEN
        RAISE EXCEPTION '错误: draw_history 表不存在，请先执行基础表创建脚本';
    END IF;
    
    RAISE NOTICE '✅ 基础表检查通过';
END $$;

-- 2. 删除现有视图和函数（避免冲突）
DROP VIEW IF EXISTS user_stats_view CASCADE;
DROP VIEW IF EXISTS draw_stats_view CASCADE;
DROP FUNCTION IF EXISTS system_health_check() CASCADE;
DROP FUNCTION IF EXISTS get_prize_stats() CASCADE;
DROP FUNCTION IF EXISTS get_user_draw_history(TEXT) CASCADE;
DROP FUNCTION IF EXISTS update_user_draw_chances(TEXT, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS cleanup_old_data() CASCADE;

-- 3. 创建用户统计视图
CREATE OR REPLACE VIEW user_stats_view AS
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN status = 'active' THEN 1 END) as active_users,
    COUNT(CASE WHEN remaining_chances > 0 THEN 1 END) as users_with_chances,
    AVG(remaining_chances) as avg_chances,
    MAX(created_at) as latest_registration,
    COUNT(CASE WHEN created_at >= CURRENT_DATE THEN 1 END) as today_registrations
FROM users;

-- 4. 创建抽奖统计视图
CREATE OR REPLACE VIEW draw_stats_view AS
SELECT 
    COUNT(*) as total_draws,
    COUNT(DISTINCT user_phone) as unique_participants,
    COUNT(CASE WHEN prize_name != '谢谢参与' THEN 1 END) as winning_draws,
    COUNT(CASE WHEN created_at >= CURRENT_DATE THEN 1 END) as today_draws,
    MAX(created_at) as latest_draw,
    ROUND(
        COUNT(CASE WHEN prize_name != '谢谢参与' THEN 1 END)::DECIMAL / 
        NULLIF(COUNT(*), 0) * 100, 2
    ) as win_rate
FROM draw_history;

-- 5. 创建系统健康检查函数
CREATE OR REPLACE FUNCTION system_health_check()
RETURNS JSON AS $$
DECLARE
    result JSON;
    user_count INTEGER;
    draw_count INTEGER;
    settings_count INTEGER;
BEGIN
    -- 检查各表的记录数
    SELECT COUNT(*) INTO user_count FROM users;
    SELECT COUNT(*) INTO draw_count FROM draw_history;
    SELECT COUNT(*) INTO settings_count FROM settings;
    
    -- 构建结果
    result := json_build_object(
        'status', 'healthy',
        'timestamp', NOW(),
        'database', json_build_object(
            'users_count', user_count,
            'draws_count', draw_count,
            'settings_count', settings_count
        ),
        'tables', json_build_object(
            'users', CASE WHEN user_count >= 0 THEN 'ok' ELSE 'error' END,
            'draw_history', CASE WHEN draw_count >= 0 THEN 'ok' ELSE 'error' END,
            'settings', CASE WHEN settings_count > 0 THEN 'ok' ELSE 'warning' END
        )
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 6. 创建获取奖品统计函数
CREATE OR REPLACE FUNCTION get_prize_stats()
RETURNS TABLE(
    prize_name TEXT,
    total_count BIGINT,
    win_rate DECIMAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        dh.prize_name,
        COUNT(*) as total_count,
        ROUND(COUNT(*)::DECIMAL / (SELECT COUNT(*) FROM draw_history) * 100, 2) as win_rate
    FROM draw_history dh
    GROUP BY dh.prize_name
    ORDER BY total_count DESC;
END;
$$ LANGUAGE plpgsql;

-- 7. 创建获取用户抽奖历史函数
CREATE OR REPLACE FUNCTION get_user_draw_history(user_phone_param TEXT)
RETURNS TABLE(
    id BIGINT,
    prize_name TEXT,
    created_at TIMESTAMPTZ,
    is_winner BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        dh.id,
        dh.prize_name,
        dh.created_at,
        (dh.prize_name != '谢谢参与') as is_winner
    FROM draw_history dh
    WHERE dh.user_phone = user_phone_param
    ORDER BY dh.created_at DESC
    LIMIT 50;
END;
$$ LANGUAGE plpgsql;

-- 8. 创建更新用户抽奖次数函数
CREATE OR REPLACE FUNCTION update_user_draw_chances(
    user_phone_param TEXT,
    change_amount INTEGER
)
RETURNS JSON AS $$
DECLARE
    current_chances INTEGER;
    new_chances INTEGER;
    result JSON;
BEGIN
    -- 获取当前抽奖次数
    SELECT remaining_chances INTO current_chances
    FROM users
    WHERE phone = user_phone_param;
    
    IF current_chances IS NULL THEN
        result := json_build_object(
            'success', false,
            'message', '用户不存在',
            'current_chances', 0,
            'new_chances', 0
        );
        RETURN result;
    END IF;
    
    -- 计算新的抽奖次数
    new_chances := current_chances + change_amount;
    
    -- 确保不为负数
    IF new_chances < 0 THEN
        new_chances := 0;
    END IF;
    
    -- 更新数据库
    UPDATE users 
    SET remaining_chances = new_chances,
        updated_at = NOW()
    WHERE phone = user_phone_param;
    
    result := json_build_object(
        'success', true,
        'message', '更新成功',
        'current_chances', current_chances,
        'new_chances', new_chances,
        'change_amount', change_amount
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 9. 创建清理过期数据函数
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS JSON AS $$
DECLARE
    deleted_count INTEGER;
    result JSON;
BEGIN
    -- 删除30天前的抽奖记录（保留中奖记录）
    DELETE FROM draw_history 
    WHERE created_at < NOW() - INTERVAL '30 days'
    AND prize_name = '谢谢参与';
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    
    result := json_build_object(
        'success', true,
        'message', '清理完成',
        'deleted_records', deleted_count,
        'cleanup_date', NOW()
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 10. 验证创建结果
DO $$
DECLARE
    view_count INTEGER;
    function_count INTEGER;
BEGIN
    -- 检查视图
    SELECT COUNT(*) INTO view_count
    FROM information_schema.views 
    WHERE table_name IN ('user_stats_view', 'draw_stats_view');
    
    -- 检查函数
    SELECT COUNT(*) INTO function_count
    FROM information_schema.routines 
    WHERE routine_name IN (
        'system_health_check',
        'get_prize_stats',
        'get_user_draw_history',
        'update_user_draw_chances',
        'cleanup_old_data'
    );
    
    RAISE NOTICE '📊 创建结果验证:';
    RAISE NOTICE '   - 视图数量: %', view_count;
    RAISE NOTICE '   - 函数数量: %', function_count;
    
    IF view_count = 2 AND function_count = 5 THEN
        RAISE NOTICE '🎉 所有对象创建成功！';
    ELSE
        RAISE NOTICE '⚠️ 部分对象创建失败，请检查错误信息';
    END IF;
END $$;

-- 11. 测试视图和函数
DO $$
DECLARE
    test_result JSON;
BEGIN
    RAISE NOTICE '🧪 开始功能测试...';
    
    -- 测试用户统计视图
    PERFORM * FROM user_stats_view LIMIT 1;
    RAISE NOTICE '✅ user_stats_view 测试通过';
    
    -- 测试抽奖统计视图
    PERFORM * FROM draw_stats_view LIMIT 1;
    RAISE NOTICE '✅ draw_stats_view 测试通过';
    
    -- 测试系统健康检查函数
    SELECT system_health_check() INTO test_result;
    RAISE NOTICE '✅ system_health_check 测试通过';
    
    -- 测试奖品统计函数
    PERFORM * FROM get_prize_stats() LIMIT 1;
    RAISE NOTICE '✅ get_prize_stats 测试通过';
    
    RAISE NOTICE '🎉 所有功能测试通过！';
    
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '❌ 测试失败: %', SQLERRM;
END $$;

-- 完成信息
SELECT 
    '🎉 快速修复完成！' as status,
    '请刷新 system-test.html 页面重新测试' as next_step,
    NOW() as completion_time;</textarea>

    <script>
        let currentStep = 0;
        const totalSteps = 4;

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function copyQuickFixSQL() {
            const sqlText = document.getElementById('quickFixSQL').value;
            navigator.clipboard.writeText(sqlText).then(() => {
                showMessage('✅ 修复脚本已复制到剪贴板！请在Supabase SQL Editor中粘贴并执行。', 'success');
                currentStep = Math.max(currentStep, 1);
                updateProgress();
            }).catch(err => {
                showMessage('❌ 复制失败，请手动复制脚本内容。', 'error');
            });
        }

        function verifyFix() {
            currentStep = Math.max(currentStep, 3);
            updateProgress();
            
            showMessage('🔍 正在验证修复结果...', 'info');
            
            // 模拟验证过程
            setTimeout(() => {
                showMessage('✅ 修复验证完成！请在system-test.html中重新测试所有功能。', 'success');
                currentStep = 4;
                updateProgress();
            }, 2000);
        }

        function showMessage(message, type) {
            const resultArea = document.getElementById('resultArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message;
            resultArea.appendChild(messageDiv);
            
            // 滚动到消息位置
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // 初始化进度条
        updateProgress();

        // 页面加载完成后的提示
        window.addEventListener('load', () => {
            showMessage('📋 页面已加载完成，请按照步骤执行修复操作。', 'info');
        });
    </script>
</body>
</html>