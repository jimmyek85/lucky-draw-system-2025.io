<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥é—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>ğŸ” å‰åç«¯è¿æ¥é—®é¢˜è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å°†æ·±åº¦æ£€æµ‹å‰ç«¯ç”¨æˆ·æ•°æ®æ— æ³•ä¿å­˜åˆ°åç«¯æ•°æ®åº“çš„é—®é¢˜</p>
        
        <button onclick="runFullDiagnostic()">ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­</button>
        <button onclick="testUserRegistration()">ğŸ‘¤ æµ‹è¯•ç”¨æˆ·æ³¨å†Œæµç¨‹</button>
        <button onclick="checkOfflineMode()">ğŸ“± æ£€æŸ¥ç¦»çº¿æ¨¡å¼çŠ¶æ€</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        
        <div id="diagnostic-results"></div>
    </div>

    <!-- åŠ è½½é…ç½®æ–‡ä»¶ -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        let supabase;
        let diagnosticResults = document.getElementById('diagnostic-results');
        let isOfflineMode = false;
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        try {
            supabase = window.supabase.createClient(
                window.SUPABASE_CONFIG?.SUPABASE_URL || 'https://your-project-id.supabase.co',
                window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY || 'your-supabase-anon-key-here'
            );
            addResult('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
        } catch (error) {
            addResult('âŒ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            diagnosticResults.appendChild(div);
            diagnosticResults.scrollTop = diagnosticResults.scrollHeight;
        }
        
        function addCodeBlock(title, code) {
            const div = document.createElement('div');
            div.innerHTML = `<h4>${title}</h4><div class="code-block">${code}</div>`;
            diagnosticResults.appendChild(div);
        }
        
        function clearResults() {
            diagnosticResults.innerHTML = '';
        }
        
        async function runFullDiagnostic() {
            clearResults();
            addResult('ğŸš€ å¼€å§‹å®Œæ•´çš„è¿æ¥é—®é¢˜è¯Šæ–­...', 'info');
            
            // 1. æ£€æŸ¥é…ç½®
            await checkConfiguration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 2. æ£€æŸ¥ç½‘ç»œè¿æ¥
            await checkNetworkConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 3. æ£€æŸ¥ Supabase è¿æ¥
            await checkSupabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 4. æ£€æŸ¥æ•°æ®åº“æƒé™
            await checkDatabasePermissions();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 5. æ£€æŸ¥ç¦»çº¿æ¨¡å¼
            await checkOfflineMode();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 6. æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
            await testUserRegistration();
            
            addResult('ğŸ‰ è¯Šæ–­å®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šè¿°ç»“æœæ‰¾å‡ºé—®é¢˜åŸå› ã€‚', 'success');
        }
        
        async function checkConfiguration() {
            addResult('ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶...', 'info');
            
            try {
                const config = window.SUPABASE_CONFIG;
                if (!config) {
                    addResult('âŒ æœªæ‰¾åˆ° SUPABASE_CONFIG é…ç½®', 'error');
                    return;
                }
                
                addResult(`âœ… Supabase URL: ${config.SUPABASE_URL}`, 'success');
                addResult(`âœ… API Key é•¿åº¦: ${config.SUPABASE_ANON_KEY?.length || 0} å­—ç¬¦`, 'success');
                
                if (config.SUPABASE_URL === 'https://your-project-id.supabase.co') {
                    addResult('âŒ é…ç½®æ–‡ä»¶ä¸­çš„ URL æœªæ›´æ–°ï¼Œä»ä¸ºé»˜è®¤å€¼', 'error');
                }
                
                if (config.SUPABASE_ANON_KEY === 'your-supabase-anon-key-here') {
                    addResult('âŒ é…ç½®æ–‡ä»¶ä¸­çš„ API Key æœªæ›´æ–°ï¼Œä»ä¸ºé»˜è®¤å€¼', 'error');
                }
                
                const status = window.getSupabaseConfigStatus();
                addCodeBlock('é…ç½®çŠ¶æ€è¯¦æƒ…', JSON.stringify(status, null, 2));
                
            } catch (error) {
                addResult('âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function checkNetworkConnection() {
            addResult('ğŸŒ æ£€æŸ¥ç½‘ç»œè¿æ¥...', 'info');
            
            try {
                // æ£€æŸ¥åŸºæœ¬ç½‘ç»œè¿æ¥
                const response = await fetch('https://www.google.com/favicon.ico', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                addResult('âœ… åŸºæœ¬ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
                
                // æ£€æŸ¥ Supabase æœåŠ¡å™¨è¿æ¥
                const supabaseResponse = await fetch(window.SUPABASE_CONFIG.SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                    }
                });
                
                if (supabaseResponse.ok) {
                    addResult('âœ… Supabase æœåŠ¡å™¨å¯è®¿é—®', 'success');
                } else {
                    addResult(`âŒ Supabase æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${supabaseResponse.status} ${supabaseResponse.statusText}`, 'error');
                }
                
            } catch (error) {
                addResult('âŒ ç½‘ç»œè¿æ¥æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                addResult('âš ï¸ å¯èƒ½çš„åŸå› ï¼šç½‘ç»œé—®é¢˜ã€é˜²ç«å¢™é˜»æ­¢ã€æˆ– Supabase æœåŠ¡å™¨ä¸å¯ç”¨', 'warning');
            }
        }
        
        async function checkSupabaseConnection() {
            addResult('ğŸ”— æ£€æŸ¥ Supabase è¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•åŸºç¡€è¿æ¥
                const { data, error } = await supabase.from('users').select('count').limit(1);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        addResult('âœ… Supabase è¿æ¥æˆåŠŸï¼ˆç”¨æˆ·è¡¨ä¸ºç©ºï¼‰', 'success');
                    } else {
                        addResult(`âŒ Supabase è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                        addCodeBlock('é”™è¯¯è¯¦æƒ…', JSON.stringify(error, null, 2));
                        
                        // åˆ†æå¸¸è§é”™è¯¯
                        if (error.message.includes('JWT')) {
                            addResult('ğŸ’¡ å¯èƒ½åŸå› ï¼šAPI Key æ— æ•ˆæˆ–å·²è¿‡æœŸ', 'warning');
                        } else if (error.message.includes('permission')) {
                            addResult('ğŸ’¡ å¯èƒ½åŸå› ï¼šæ•°æ®åº“æƒé™é…ç½®é—®é¢˜', 'warning');
                        } else if (error.message.includes('network')) {
                            addResult('ğŸ’¡ å¯èƒ½åŸå› ï¼šç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
                        }
                        return;
                    }
                } else {
                    addResult('âœ… Supabase è¿æ¥æˆåŠŸ', 'success');
                }
                
            } catch (error) {
                addResult('âŒ Supabase è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                addCodeBlock('é”™è¯¯å †æ ˆ', error.stack || 'æ— å †æ ˆä¿¡æ¯');
            }
        }
        
        async function checkDatabasePermissions() {
            addResult('ğŸ” æ£€æŸ¥æ•°æ®åº“æƒé™...', 'info');
            
            try {
                // æµ‹è¯•è¯»å–æƒé™
                const { data: readTest, error: readError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (readError) {
                    addResult(`âŒ è¯»å–æƒé™æµ‹è¯•å¤±è´¥: ${readError.message}`, 'error');
                } else {
                    addResult('âœ… è¯»å–æƒé™æ­£å¸¸', 'success');
                }
                
                // æµ‹è¯•å†™å…¥æƒé™ï¼ˆåˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼‰
                const testUser = {
                    name: 'Test User ' + Date.now(),
                    phone: 'test_' + Date.now(),
                    email: 'test@example.com',
                    address: 'Test Address',
                    drawchances: 1,
                    joindate: new Date().toISOString(),
                    prizeswon: []
                };
                
                const { data: insertTest, error: insertError } = await supabase
                    .from('users')
                    .insert([testUser])
                    .select()
                    .single();
                
                if (insertError) {
                    addResult(`âŒ å†™å…¥æƒé™æµ‹è¯•å¤±è´¥: ${insertError.message}`, 'error');
                    addCodeBlock('å†™å…¥é”™è¯¯è¯¦æƒ…', JSON.stringify(insertError, null, 2));
                    
                    // åˆ†ææƒé™é”™è¯¯
                    if (insertError.message.includes('RLS')) {
                        addResult('ğŸ’¡ å¯èƒ½åŸå› ï¼šè¡Œçº§å®‰å…¨ç­–ç•¥(RLS)é˜»æ­¢äº†æ•°æ®æ’å…¥', 'warning');
                        addResult('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ Supabase Dashboard ä¸­çš„ RLS ç­–ç•¥é…ç½®', 'warning');
                    } else if (insertError.message.includes('permission')) {
                        addResult('ğŸ’¡ å¯èƒ½åŸå› ï¼šanon è§’è‰²æ²¡æœ‰ INSERT æƒé™', 'warning');
                        addResult('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šåœ¨ Supabase Dashboard ä¸­ä¸º anon è§’è‰²æ·»åŠ  INSERT æƒé™', 'warning');
                    }
                } else {
                    addResult('âœ… å†™å…¥æƒé™æ­£å¸¸', 'success');
                    addResult(`âœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ${insertTest.name} (${insertTest.phone})`, 'success');
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    await supabase.from('users').delete().eq('phone', testUser.phone);
                    addResult('ğŸ§¹ æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'info');
                }
                
            } catch (error) {
                addResult('âŒ æƒé™æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function checkOfflineMode() {
            addResult('ğŸ“± æ£€æŸ¥ç¦»çº¿æ¨¡å¼çŠ¶æ€...', 'info');
            
            try {
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„ç¦»çº¿ç”¨æˆ·æ•°æ®
                const offlineUser = localStorage.getItem('offlineUser');
                if (offlineUser) {
                    const userData = JSON.parse(offlineUser);
                    addResult('âš ï¸ å‘ç°ç¦»çº¿ç”¨æˆ·æ•°æ®ï¼è¿™å¯èƒ½æ˜¯é—®é¢˜çš„æ ¹æº', 'warning');
                    addCodeBlock('ç¦»çº¿ç”¨æˆ·æ•°æ®', JSON.stringify(userData, null, 2));
                    addResult('ğŸ’¡ ç”¨æˆ·æ•°æ®è¢«ä¿å­˜åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œè€Œä¸æ˜¯ Supabase æ•°æ®åº“', 'warning');
                    addResult('ğŸ’¡ è¿™é€šå¸¸å‘ç”Ÿåœ¨ Supabase è¿æ¥å¤±è´¥æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å¯ç”¨ç¦»çº¿æ¨¡å¼', 'warning');
                } else {
                    addResult('âœ… æœªå‘ç°ç¦»çº¿ç”¨æˆ·æ•°æ®', 'success');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç¦»çº¿æ¨¡å¼æŒ‡ç¤ºå™¨
                const offlineNotice = document.querySelector('.fixed.top-0.bg-yellow-600');
                if (offlineNotice) {
                    addResult('âš ï¸ æ£€æµ‹åˆ°ç¦»çº¿æ¨¡å¼æç¤ºæ¡', 'warning');
                } else {
                    addResult('âœ… æœªæ£€æµ‹åˆ°ç¦»çº¿æ¨¡å¼æç¤º', 'success');
                }
                
            } catch (error) {
                addResult('âŒ ç¦»çº¿æ¨¡å¼æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testUserRegistration() {
            addResult('ğŸ‘¤ æµ‹è¯•ç”¨æˆ·æ³¨å†Œæµç¨‹...', 'info');
            
            try {
                const testUser = {
                    name: 'Diagnostic Test User',
                    phone: '+60123456789_test_' + Date.now(),
                    email: 'diagnostic@test.com',
                    address: 'Test Address for Diagnostic',
                    drawchances: 1,
                    joindate: new Date().toISOString(),
                    prizeswon: []
                };
                
                addResult('ğŸ“ å°è¯•æ³¨å†Œæµ‹è¯•ç”¨æˆ·...', 'info');
                addCodeBlock('æµ‹è¯•ç”¨æˆ·æ•°æ®', JSON.stringify(testUser, null, 2));
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                const { data: existingUser, error: fetchError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', testUser.phone)
                    .single();
                
                if (existingUser && !fetchError) {
                    addResult('â„¹ï¸ æµ‹è¯•ç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡æ³¨å†Œ', 'info');
                } else {
                    // å°è¯•æ³¨å†Œæ–°ç”¨æˆ·
                    const { data: newUser, error: insertError } = await supabase
                        .from('users')
                        .insert([testUser])
                        .select()
                        .single();
                    
                    if (insertError) {
                        addResult(`âŒ ç”¨æˆ·æ³¨å†Œå¤±è´¥: ${insertError.message}`, 'error');
                        addCodeBlock('æ³¨å†Œé”™è¯¯è¯¦æƒ…', JSON.stringify(insertError, null, 2));
                        
                        // è¿™é‡Œæ˜¯å…³é”®ï¼šå¦‚æœæ³¨å†Œå¤±è´¥ï¼Œç³»ç»Ÿä¼šå¯ç”¨ç¦»çº¿æ¨¡å¼
                        addResult('ğŸ” è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼ç”¨æˆ·æ³¨å†Œå¤±è´¥å¯¼è‡´ç³»ç»Ÿå¯ç”¨ç¦»çº¿æ¨¡å¼', 'error');
                        addResult('ğŸ’¡ ç”¨æˆ·æ•°æ®è¢«ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨è€Œä¸æ˜¯æ•°æ®åº“', 'warning');
                        
                    } else {
                        addResult('âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼', 'success');
                        addCodeBlock('æ³¨å†ŒæˆåŠŸçš„ç”¨æˆ·æ•°æ®', JSON.stringify(newUser, null, 2));
                        
                        // æ¸…ç†æµ‹è¯•æ•°æ®
                        await supabase.from('users').delete().eq('phone', testUser.phone);
                        addResult('ğŸ§¹ æµ‹è¯•ç”¨æˆ·å·²æ¸…ç†', 'info');
                    }
                }
                
            } catch (error) {
                addResult('âŒ ç”¨æˆ·æ³¨å†Œæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                addResult('ğŸ” è¿™å¯èƒ½å°±æ˜¯ç”¨æˆ·æ•°æ®æ— æ³•ä¿å­˜åˆ°æ•°æ®åº“çš„åŸå› ï¼', 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            addResult('ğŸŒŸ è¿æ¥é—®é¢˜è¯Šæ–­å·¥å…·å·²åŠ è½½', 'info');
            addResult('ğŸ’¡ ç‚¹å‡»"å¼€å§‹å®Œæ•´è¯Šæ–­"æŒ‰é’®æ¥æ£€æµ‹å‰åç«¯è¿æ¥é—®é¢˜', 'info');
        });
    </script>
</body>
</html>