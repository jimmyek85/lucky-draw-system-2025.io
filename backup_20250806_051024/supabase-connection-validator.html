<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”— Supabase äº‘æœåŠ¡å™¨è¿æ¥éªŒè¯å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 4px solid #6b7280;
        }
        .status-success {
            border-left-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
        .status-error {
            border-left-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        .status-warning {
            border-left-color: #f59e0b;
            background-color: rgba(245, 158, 11, 0.1);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-success { background-color: rgba(16, 185, 129, 0.2); color: #10b981; }
        .log-error { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .log-warning { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .log-info { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- åŠ è½½ Supabase é…ç½® -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- æ ‡é¢˜ -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-blue-400 mb-2">ğŸ”— Supabase äº‘æœåŠ¡å™¨è¿æ¥éªŒè¯å™¨</h1>
                <p class="text-gray-300">ç¡®ä¿å‰ç«¯ç”¨æˆ·ç«¯å’Œåç«¯ç®¡ç†ç«¯æ•°æ®è¿æ¥ç»Ÿä¸€</p>
            </div>

            <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <button onclick="runFullValidation()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    ğŸš€ å®Œæ•´éªŒè¯
                </button>
                <button onclick="testRealtimeConnection()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    ğŸ“¡ å®æ—¶è¿æ¥æµ‹è¯•
                </button>
                <button onclick="validateDataConsistency()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    ğŸ”„ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
                </button>
            </div>

            <!-- è¿æ¥çŠ¶æ€é¢æ¿ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- é…ç½®çŠ¶æ€ -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“‹ é…ç½®çŠ¶æ€</h3>
                    <div id="config-status" class="space-y-3">
                        <div class="status-card bg-gray-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span>Supabase URL</span>
                                <span id="url-status" class="text-gray-400">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                        <div class="status-card bg-gray-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span>API Key</span>
                                <span id="key-status" class="text-gray-400">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                        <div class="status-card bg-gray-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span>è¡¨é…ç½®</span>
                                <span id="table-status" class="text-gray-400">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¿æ¥çŠ¶æ€ -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-green-400">ğŸŒ è¿æ¥çŠ¶æ€</h3>
                    <div id="connection-status" class="space-y-3">
                        <div class="status-card bg-gray-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span>å®¢æˆ·ç«¯åˆå§‹åŒ–</span>
                                <span id="client-status" class="text-gray-400">æœªæµ‹è¯•</span>
                            </div>
                        </div>
                        <div class="status-card bg-gray-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span>æ•°æ®åº“è¿æ¥</span>
                                <span id="db-status" class="text-gray-400">æœªæµ‹è¯•</span>
                            </div>
                        </div>
                        <div class="status-card bg-gray-700 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <span>å®æ—¶è®¢é˜…</span>
                                <span id="realtime-status" class="text-gray-400">æœªæµ‹è¯•</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®è¡¨çŠ¶æ€ -->
            <div class="bg-gray-800 rounded-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-4 text-yellow-400">ğŸ“Š æ•°æ®è¡¨çŠ¶æ€</h3>
                <div id="table-details" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="status-card bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-blue-300 mb-2">users è¡¨</h4>
                        <div class="text-sm space-y-1">
                            <div>çŠ¶æ€: <span id="users-table-status" class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                            <div>è®°å½•æ•°: <span id="users-count" class="text-gray-400">-</span></div>
                            <div>æœ€åæ›´æ–°: <span id="users-updated" class="text-gray-400">-</span></div>
                        </div>
                    </div>
                    <div class="status-card bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-green-300 mb-2">settings è¡¨</h4>
                        <div class="text-sm space-y-1">
                            <div>çŠ¶æ€: <span id="settings-table-status" class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                            <div>è®°å½•æ•°: <span id="settings-count" class="text-gray-400">-</span></div>
                            <div>æœ€åæ›´æ–°: <span id="settings-updated" class="text-gray-400">-</span></div>
                        </div>
                    </div>
                    <div class="status-card bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-purple-300 mb-2">knowledge è¡¨</h4>
                        <div class="text-sm space-y-1">
                            <div>çŠ¶æ€: <span id="knowledge-table-status" class="text-gray-400">æ£€æŸ¥ä¸­...</span></div>
                            <div>è®°å½•æ•°: <span id="knowledge-count" class="text-gray-400">-</span></div>
                            <div>æœ€åæ›´æ–°: <span id="knowledge-updated" class="text-gray-400">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶æ—¥å¿— -->
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-400">ğŸ“ å®æ—¶æ—¥å¿—</h3>
                    <button onclick="clearLogs()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
                <div id="log-container" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto">
                    <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- ä¿®å¤å»ºè®® -->
            <div id="fix-suggestions" class="bg-yellow-900 border border-yellow-600 rounded-lg p-6 mt-8 hidden">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">ğŸ”§ ä¿®å¤å»ºè®®</h3>
                <div id="suggestions-content" class="space-y-2">
                    <!-- ä¿®å¤å»ºè®®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let realtimeChannel = null;
        const logs = [];

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            logs.push(logEntry);
            
            const logContainer = document.getElementById('log-container');
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logs.length = 0;
            document.getElementById('log-container').innerHTML = '';
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = status === 'success' ? 'text-green-400' : 
                                  status === 'error' ? 'text-red-400' : 
                                  status === 'warning' ? 'text-yellow-400' : 'text-gray-400';
            }
        }

        // æ£€æŸ¥é…ç½®
        async function checkConfiguration() {
            addLog('ğŸ” æ£€æŸ¥ Supabase é…ç½®...', 'info');
            
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase é…ç½®æœªæ‰¾åˆ°');
                }

                const config = window.SUPABASE_CONFIG;
                
                // æ£€æŸ¥ URL
                if (!config.SUPABASE_URL || config.SUPABASE_URL === 'https://your-project-id.supabase.co') {
                    updateStatus('url-status', 'error', 'âŒ æœªé…ç½®');
                    addLog('âŒ Supabase URL æœªæ­£ç¡®é…ç½®', 'error');
                } else if (!config.SUPABASE_URL.includes('.supabase.co')) {
                    updateStatus('url-status', 'warning', 'âš ï¸ æ ¼å¼é”™è¯¯');
                    addLog('âš ï¸ Supabase URL æ ¼å¼å¯èƒ½ä¸æ­£ç¡®', 'warning');
                } else {
                    updateStatus('url-status', 'success', 'âœ… å·²é…ç½®');
                    addLog('âœ… Supabase URL é…ç½®æ­£ç¡®', 'success');
                }

                // æ£€æŸ¥ API Key
                if (!config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === 'your-supabase-anon-key-here') {
                    updateStatus('key-status', 'error', 'âŒ æœªé…ç½®');
                    addLog('âŒ Supabase API Key æœªæ­£ç¡®é…ç½®', 'error');
                } else if (!config.SUPABASE_ANON_KEY.startsWith('eyJ')) {
                    updateStatus('key-status', 'warning', 'âš ï¸ æ ¼å¼é”™è¯¯');
                    addLog('âš ï¸ Supabase API Key æ ¼å¼å¯èƒ½ä¸æ­£ç¡®', 'warning');
                } else {
                    updateStatus('key-status', 'success', 'âœ… å·²é…ç½®');
                    addLog('âœ… Supabase API Key é…ç½®æ­£ç¡®', 'success');
                }

                // æ£€æŸ¥è¡¨é…ç½®
                if (config.TABLES && config.TABLES.USERS && config.TABLES.SETTINGS && config.TABLES.KNOWLEDGE) {
                    updateStatus('table-status', 'success', 'âœ… å·²é…ç½®');
                    addLog('âœ… æ•°æ®è¡¨é…ç½®å®Œæ•´', 'success');
                } else {
                    updateStatus('table-status', 'warning', 'âš ï¸ ä¸å®Œæ•´');
                    addLog('âš ï¸ æ•°æ®è¡¨é…ç½®ä¸å®Œæ•´', 'warning');
                }

                return config;
            } catch (error) {
                addLog(`âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        async function initializeSupabaseClient() {
            addLog('ğŸ”§ åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...', 'info');
            
            try {
                const config = window.SUPABASE_CONFIG;
                if (!config) {
                    throw new Error('é…ç½®æœªæ‰¾åˆ°');
                }

                supabase = window.supabase.createClient(
                    config.SUPABASE_URL,
                    config.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: false
                        },
                        realtime: {
                            params: {
                                eventsPerSecond: 10
                            }
                        }
                    }
                );

                updateStatus('client-status', 'success', 'âœ… å·²åˆå§‹åŒ–');
                addLog('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                updateStatus('client-status', 'error', 'âŒ å¤±è´¥');
                addLog(`âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            addLog('ğŸ”— æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
            
            try {
                if (!supabase) {
                    throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                // ç®€å•çš„è¿æ¥æµ‹è¯•
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                updateStatus('db-status', 'success', 'âœ… è¿æ¥æ­£å¸¸');
                addLog('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                updateStatus('db-status', 'error', 'âŒ è¿æ¥å¤±è´¥');
                addLog(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æµ‹è¯•å®æ—¶è¿æ¥
        async function testRealtimeConnection() {
            addLog('ğŸ“¡ æµ‹è¯•å®æ—¶è¿æ¥...', 'info');
            
            try {
                if (!supabase) {
                    throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                }

                // æ¸…ç†ç°æœ‰è®¢é˜…
                if (realtimeChannel) {
                    await supabase.removeChannel(realtimeChannel);
                }

                // åˆ›å»ºå®æ—¶è®¢é˜…
                realtimeChannel = supabase
                    .channel('test-channel')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'users' },
                        (payload) => {
                            addLog(`ğŸ“¡ æ”¶åˆ°å®æ—¶æ›´æ–°: ${payload.eventType}`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            updateStatus('realtime-status', 'success', 'âœ… å·²è¿æ¥');
                            addLog('âœ… å®æ—¶è¿æ¥å»ºç«‹æˆåŠŸ', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            updateStatus('realtime-status', 'error', 'âŒ è¿æ¥é”™è¯¯');
                            addLog('âŒ å®æ—¶è¿æ¥å»ºç«‹å¤±è´¥', 'error');
                        }
                    });

                return true;
            } catch (error) {
                updateStatus('realtime-status', 'error', 'âŒ å¤±è´¥');
                addLog(`âŒ å®æ—¶è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ£€æŸ¥æ•°æ®è¡¨çŠ¶æ€
        async function checkTableStatus() {
            addLog('ğŸ“Š æ£€æŸ¥æ•°æ®è¡¨çŠ¶æ€...', 'info');
            
            const tables = ['users', 'settings', 'knowledge'];
            
            for (const table of tables) {
                try {
                    const { count, error } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });

                    if (error) {
                        throw error;
                    }

                    updateStatus(`${table}-table-status`, 'success', 'âœ… æ­£å¸¸');
                    updateStatus(`${table}-count`, 'success', count || 0);
                    updateStatus(`${table}-updated`, 'success', new Date().toLocaleString());
                    addLog(`âœ… ${table} è¡¨çŠ¶æ€æ­£å¸¸ï¼Œè®°å½•æ•°: ${count || 0}`, 'success');
                } catch (error) {
                    updateStatus(`${table}-table-status`, 'error', 'âŒ é”™è¯¯');
                    updateStatus(`${table}-count`, 'error', '-');
                    updateStatus(`${table}-updated`, 'error', '-');
                    addLog(`âŒ ${table} è¡¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // éªŒè¯æ•°æ®ä¸€è‡´æ€§
        async function validateDataConsistency() {
            addLog('ğŸ”„ éªŒè¯æ•°æ®ä¸€è‡´æ€§...', 'info');
            
            try {
                // æ£€æŸ¥ç”¨æˆ·æ•°æ®å®Œæ•´æ€§
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(5);

                if (usersError) {
                    throw usersError;
                }

                addLog(`âœ… ç”¨æˆ·æ•°æ®æ ·æœ¬æ£€æŸ¥å®Œæˆï¼Œå…± ${users.length} æ¡è®°å½•`, 'success');

                // æ£€æŸ¥è®¾ç½®æ•°æ®
                const { data: settings, error: settingsError } = await supabase
                    .from('settings')
                    .select('*');

                if (settingsError) {
                    throw settingsError;
                }

                addLog(`âœ… è®¾ç½®æ•°æ®æ£€æŸ¥å®Œæˆï¼Œå…± ${settings.length} æ¡è®°å½•`, 'success');

                addLog('âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯å®Œæˆ', 'success');
            } catch (error) {
                addLog(`âŒ æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œå®Œæ•´éªŒè¯
        async function runFullValidation() {
            addLog('ğŸš€ å¼€å§‹å®Œæ•´éªŒè¯æµç¨‹...', 'info');
            clearLogs();
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            const statusElements = document.querySelectorAll('[id$="-status"]');
            statusElements.forEach(el => {
                el.textContent = 'æ£€æŸ¥ä¸­...';
                el.className = 'text-gray-400';
            });

            // æ­¥éª¤ 1: æ£€æŸ¥é…ç½®
            const config = await checkConfiguration();
            if (!config) {
                addLog('âŒ é…ç½®æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢éªŒè¯', 'error');
                showFixSuggestions(['æ£€æŸ¥ supabase-config.js æ–‡ä»¶æ˜¯å¦å­˜åœ¨', 'ç¡®è®¤ Supabase URL å’Œ API Key é…ç½®æ­£ç¡®']);
                return;
            }

            // æ­¥éª¤ 2: åˆå§‹åŒ–å®¢æˆ·ç«¯
            const clientInitialized = await initializeSupabaseClient();
            if (!clientInitialized) {
                addLog('âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼Œåœæ­¢éªŒè¯', 'error');
                showFixSuggestions(['æ£€æŸ¥ç½‘ç»œè¿æ¥', 'éªŒè¯ Supabase é¡¹ç›®æ˜¯å¦æ­£å¸¸è¿è¡Œ', 'ç¡®è®¤ API Key æƒé™']);
                return;
            }

            // æ­¥éª¤ 3: æµ‹è¯•æ•°æ®åº“è¿æ¥
            const dbConnected = await testDatabaseConnection();
            if (!dbConnected) {
                showFixSuggestions(['æ£€æŸ¥æ•°æ®åº“è¡¨æ˜¯å¦å·²åˆ›å»º', 'éªŒè¯ API Key æƒé™', 'ç¡®è®¤ç½‘ç»œè¿æ¥']);
            }

            // æ­¥éª¤ 4: æµ‹è¯•å®æ—¶è¿æ¥
            await testRealtimeConnection();

            // æ­¥éª¤ 5: æ£€æŸ¥æ•°æ®è¡¨çŠ¶æ€
            await checkTableStatus();

            // æ­¥éª¤ 6: éªŒè¯æ•°æ®ä¸€è‡´æ€§
            await validateDataConsistency();

            addLog('ğŸ‰ å®Œæ•´éªŒè¯æµç¨‹å®Œæˆï¼', 'success');
        }

        // æ˜¾ç¤ºä¿®å¤å»ºè®®
        function showFixSuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('fix-suggestions');
            const suggestionsContent = document.getElementById('suggestions-content');
            
            suggestionsContent.innerHTML = '';
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'text-yellow-200';
                div.innerHTML = `â€¢ ${suggestion}`;
                suggestionsContent.appendChild(div);
            });
            
            suggestionsContainer.classList.remove('hidden');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', async function() {
            addLog('ğŸ”§ Supabase è¿æ¥éªŒè¯å™¨å·²åŠ è½½', 'info');
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬å·²åŠ è½½
            setTimeout(async () => {
                await checkConfiguration();
                await initializeSupabaseClient();
            }, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            if (realtimeChannel && supabase) {
                supabase.removeChannel(realtimeChannel);
            }
        });
    </script>
</body>
</html>