<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 Lucky Draw - å…¨ç³»ç»Ÿè¿æ¥æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .test-card.success {
            border-left-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
        .test-card.error {
            border-left-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        .test-card.warning {
            border-left-color: #f59e0b;
            background-color: rgba(245, 158, 11, 0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
        }
        .log-success { background-color: rgba(16, 185, 129, 0.2); color: #10b981; }
        .log-error { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .log-info { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .log-warning { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">ğŸ”§ 1602 Lucky Draw</h1>
            <h2 class="text-2xl text-gray-300 mb-4">å…¨ç³»ç»Ÿè¿æ¥æµ‹è¯•</h2>
            <p class="text-gray-400">ç¡®ä¿å‰ç«¯å’Œåç«¯æ•°æ®è¿æ¥æ­£å¸¸ï¼Œæ”¯æŒæœ‰ç½‘æ— ç½‘æŒç»­è¿è¡Œ</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <div class="flex flex-wrap gap-4 justify-center">
                <button onclick="runFullTest()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•
                </button>
                <button onclick="testFrontend()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ¯ æµ‹è¯•å‰ç«¯ (index.html)
                </button>
                <button onclick="testBackend()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    âš™ï¸ æµ‹è¯•åç«¯ (admin.html)
                </button>
                <button onclick="testNetworkResilience()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ“¡ æµ‹è¯•ç½‘ç»œéŸ§æ€§
                </button>
                <button onclick="clearLogs()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—
                </button>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="test-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Supabase è¿æ¥</p>
                        <p id="supabase-status" class="text-xl font-bold">
                            <span class="status-indicator status-offline"></span>æ£€æµ‹ä¸­...
                        </p>
                    </div>
                    <div class="text-3xl">ğŸ”—</div>
                </div>
            </div>
            <div class="test-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">å‰ç«¯çŠ¶æ€</p>
                        <p id="frontend-status" class="text-xl font-bold">
                            <span class="status-indicator status-offline"></span>æœªæµ‹è¯•
                        </p>
                    </div>
                    <div class="text-3xl">ğŸ¯</div>
                </div>
            </div>
            <div class="test-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">åç«¯çŠ¶æ€</p>
                        <p id="backend-status" class="text-xl font-bold">
                            <span class="status-indicator status-offline"></span>æœªæµ‹è¯•
                        </p>
                    </div>
                    <div class="text-3xl">âš™ï¸</div>
                </div>
            </div>
            <div class="test-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">ç½‘ç»œéŸ§æ€§</p>
                        <p id="network-status" class="text-xl font-bold">
                            <span class="status-indicator status-offline"></span>æœªæµ‹è¯•
                        </p>
                    </div>
                    <div class="text-3xl">ğŸ“¡</div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æµ‹è¯•ç»“æœ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- è¿æ¥æµ‹è¯•ç»“æœ -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-bold text-blue-400 mb-4">ğŸ” è¿æ¥æµ‹è¯•ç»“æœ</h3>
                <div id="connection-tests" class="space-y-4">
                    <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- å®æ—¶æ—¥å¿— -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-bold text-green-400 mb-4">ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
                <div id="test-logs" class="bg-gray-900 rounded p-4 h-96 overflow-y-auto">
                    <div class="log-entry log-info">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…æµ‹è¯•...</div>
                </div>
            </div>
        </div>

        <!-- ä¿®å¤å»ºè®® -->
        <div id="fix-suggestions" class="bg-gray-800 rounded-lg p-6 mt-8" style="display: none;">
            <h3 class="text-xl font-bold text-yellow-400 mb-4">ğŸ”§ ä¿®å¤å»ºè®®</h3>
            <div id="suggestions-content" class="space-y-4">
                <!-- ä¿®å¤å»ºè®®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="enhanced-supabase-connection.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let supabase = null;
        let enhancedConnection = null;
        let testResults = {
            supabase: false,
            frontend: false,
            backend: false,
            network: false
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            addLog('info', 'ğŸš€ å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...');
            
            try {
                // æ£€æŸ¥é…ç½®
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase é…ç½®æœªåŠ è½½');
                }

                addLog('success', 'âœ… Supabase é…ç½®å·²åŠ è½½');

                // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );

                addLog('success', 'âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');

                // åˆå§‹åŒ–å¢å¼ºè¿æ¥ç®¡ç†å™¨
                if (window.EnhancedSupabaseConnection) {
                    enhancedConnection = new window.EnhancedSupabaseConnection();
                    await enhancedConnection.initialize();
                    addLog('success', 'âœ… å¢å¼ºè¿æ¥ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    addLog('warning', 'âš ï¸ å¢å¼ºè¿æ¥ç®¡ç†å™¨æœªæ‰¾åˆ°ï¼Œä½¿ç”¨åŸºç¡€è¿æ¥');
                }

                // æµ‹è¯•åŸºç¡€è¿æ¥
                await testSupabaseConnection();

            } catch (error) {
                addLog('error', `âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                updateStatus('supabase-status', 'è¿æ¥å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯• Supabase è¿æ¥
        async function testSupabaseConnection() {
            addLog('info', 'ğŸ” æµ‹è¯• Supabase è¿æ¥...');
            
            try {
                // æµ‹è¯•åŸºç¡€è¿æ¥
                const { data, error } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                testResults.supabase = true;
                updateStatus('supabase-status', 'è¿æ¥æ­£å¸¸', 'success');
                addLog('success', 'âœ… Supabase è¿æ¥æµ‹è¯•æˆåŠŸ');

                // æ·»åŠ è¿æ¥æµ‹è¯•ç»“æœ
                addConnectionTest('Supabase åŸºç¡€è¿æ¥', true, 'æ•°æ®åº“è¿æ¥æ­£å¸¸');

            } catch (error) {
                testResults.supabase = false;
                updateStatus('supabase-status', 'è¿æ¥å¤±è´¥', 'error');
                addLog('error', `âŒ Supabase è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                addConnectionTest('Supabase åŸºç¡€è¿æ¥', false, error.message);
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            addLog('info', 'ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•...');
            clearConnectionTests();

            // é‡ç½®çŠ¶æ€
            Object.keys(testResults).forEach(key => {
                testResults[key] = false;
            });

            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            await testSupabaseConnection();
            await testFrontend();
            await testBackend();
            await testNetworkResilience();

            // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
            generateTestReport();
        }

        // æµ‹è¯•å‰ç«¯åŠŸèƒ½
        async function testFrontend() {
            addLog('info', 'ğŸ¯ æµ‹è¯•å‰ç«¯åŠŸèƒ½...');
            
            try {
                // æµ‹è¯•ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
                const testUser = {
                    name: 'Test User ' + Date.now(),
                    phone: '1234567890',
                    email: 'test@example.com',
                    address: 'Test Address'
                };

                const { data, error } = await supabase
                    .from('users')
                    .insert([testUser])
                    .select();

                if (error) {
                    throw error;
                }

                // æ¸…ç†æµ‹è¯•æ•°æ®
                await supabase
                    .from('users')
                    .delete()
                    .eq('phone', testUser.phone);

                testResults.frontend = true;
                updateStatus('frontend-status', 'åŠŸèƒ½æ­£å¸¸', 'success');
                addLog('success', 'âœ… å‰ç«¯åŠŸèƒ½æµ‹è¯•æˆåŠŸ');
                addConnectionTest('å‰ç«¯ç”¨æˆ·æ³¨å†Œ', true, 'ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½æ­£å¸¸');

            } catch (error) {
                testResults.frontend = false;
                updateStatus('frontend-status', 'åŠŸèƒ½å¼‚å¸¸', 'error');
                addLog('error', `âŒ å‰ç«¯åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
                addConnectionTest('å‰ç«¯ç”¨æˆ·æ³¨å†Œ', false, error.message);
            }
        }

        // æµ‹è¯•åç«¯åŠŸèƒ½
        async function testBackend() {
            addLog('info', 'âš™ï¸ æµ‹è¯•åç«¯ç®¡ç†åŠŸèƒ½...');
            
            try {
                // æµ‹è¯•ç®¡ç†å‘˜æŸ¥è¯¢åŠŸèƒ½
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);

                if (error) {
                    throw error;
                }

                // æµ‹è¯•è®¾ç½®æ›´æ–°åŠŸèƒ½
                const { data: settingsData, error: settingsError } = await supabase
                    .from('settings')
                    .select('*')
                    .limit(1);

                if (settingsError && settingsError.code !== 'PGRST116') {
                    throw settingsError;
                }

                testResults.backend = true;
                updateStatus('backend-status', 'åŠŸèƒ½æ­£å¸¸', 'success');
                addLog('success', 'âœ… åç«¯ç®¡ç†åŠŸèƒ½æµ‹è¯•æˆåŠŸ');
                addConnectionTest('åç«¯ç®¡ç†æŸ¥è¯¢', true, 'ç®¡ç†åŠŸèƒ½æ­£å¸¸');

            } catch (error) {
                testResults.backend = false;
                updateStatus('backend-status', 'åŠŸèƒ½å¼‚å¸¸', 'error');
                addLog('error', `âŒ åç«¯ç®¡ç†åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
                addConnectionTest('åç«¯ç®¡ç†æŸ¥è¯¢', false, error.message);
            }
        }

        // æµ‹è¯•ç½‘ç»œéŸ§æ€§
        async function testNetworkResilience() {
            addLog('info', 'ğŸ“¡ æµ‹è¯•ç½‘ç»œéŸ§æ€§...');
            
            try {
                // æµ‹è¯•é‡è¿æœºåˆ¶
                if (enhancedConnection) {
                    const connectionStatus = await enhancedConnection.testConnection();
                    
                    if (connectionStatus.success) {
                        testResults.network = true;
                        updateStatus('network-status', 'éŸ§æ€§è‰¯å¥½', 'success');
                        addLog('success', 'âœ… ç½‘ç»œéŸ§æ€§æµ‹è¯•æˆåŠŸ');
                        addConnectionTest('ç½‘ç»œéŸ§æ€§æµ‹è¯•', true, 'é‡è¿æœºåˆ¶æ­£å¸¸');
                    } else {
                        throw new Error(connectionStatus.error);
                    }
                } else {
                    // åŸºç¡€ç½‘ç»œæµ‹è¯•
                    const response = await fetch(window.SUPABASE_CONFIG.SUPABASE_URL + '/rest/v1/', {
                        method: 'HEAD',
                        headers: {
                            'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                        }
                    });

                    if (response.ok) {
                        testResults.network = true;
                        updateStatus('network-status', 'è¿æ¥æ­£å¸¸', 'success');
                        addLog('success', 'âœ… åŸºç¡€ç½‘ç»œæµ‹è¯•æˆåŠŸ');
                        addConnectionTest('åŸºç¡€ç½‘ç»œæµ‹è¯•', true, 'ç½‘ç»œè¿æ¥æ­£å¸¸');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }

            } catch (error) {
                testResults.network = false;
                updateStatus('network-status', 'è¿æ¥å¼‚å¸¸', 'error');
                addLog('error', `âŒ ç½‘ç»œéŸ§æ€§æµ‹è¯•å¤±è´¥: ${error.message}`);
                addConnectionTest('ç½‘ç»œéŸ§æ€§æµ‹è¯•', false, error.message);
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(elementId, text, type) {
            const element = document.getElementById(elementId);
            const indicator = element.querySelector('.status-indicator');
            
            element.innerHTML = `<span class="status-indicator status-${type === 'success' ? 'online' : type === 'error' ? 'offline' : 'warning'}"></span>${text}`;
            
            const card = element.closest('.test-card');
            card.className = `test-card bg-gray-800 p-6 rounded-lg ${type}`;
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLog(type, message) {
            const logsContainer = document.getElementById('test-logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // æ·»åŠ è¿æ¥æµ‹è¯•ç»“æœ
        function addConnectionTest(testName, success, message) {
            const container = document.getElementById('connection-tests');
            const testDiv = document.createElement('div');
            testDiv.className = `test-card bg-gray-700 p-4 rounded ${success ? 'success' : 'error'}`;
            
            testDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold">${testName}</h4>
                        <p class="text-sm text-gray-300">${message}</p>
                    </div>
                    <div class="text-2xl">${success ? 'âœ…' : 'âŒ'}</div>
                </div>
            `;
            
            container.appendChild(testDiv);
        }

        // æ¸…é™¤è¿æ¥æµ‹è¯•ç»“æœ
        function clearConnectionTests() {
            document.getElementById('connection-tests').innerHTML = '';
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.getElementById('test-logs').innerHTML = '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…é™¤ï¼Œç­‰å¾…æ–°çš„æµ‹è¯•...</div>';
        }

        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        function generateTestReport() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result).length;
            const successRate = (passedTests / totalTests * 100).toFixed(1);

            addLog('info', `ğŸ“Š æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡ (${successRate}%)`);

            // æ˜¾ç¤ºä¿®å¤å»ºè®®
            if (passedTests < totalTests) {
                showFixSuggestions();
            }
        }

        // æ˜¾ç¤ºä¿®å¤å»ºè®®
        function showFixSuggestions() {
            const suggestionsDiv = document.getElementById('fix-suggestions');
            const contentDiv = document.getElementById('suggestions-content');
            
            let suggestions = [];

            if (!testResults.supabase) {
                suggestions.push({
                    title: 'Supabase è¿æ¥é—®é¢˜',
                    description: 'æ£€æŸ¥ Supabase URL å’Œ API å¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®',
                    action: 'æŸ¥çœ‹ supabase-config.js æ–‡ä»¶'
                });
            }

            if (!testResults.frontend) {
                suggestions.push({
                    title: 'å‰ç«¯åŠŸèƒ½é—®é¢˜',
                    description: 'ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½å¯èƒ½å­˜åœ¨é—®é¢˜',
                    action: 'æ£€æŸ¥ index.html ä¸­çš„ç”¨æˆ·æ³¨å†Œé€»è¾‘'
                });
            }

            if (!testResults.backend) {
                suggestions.push({
                    title: 'åç«¯ç®¡ç†é—®é¢˜',
                    description: 'ç®¡ç†å‘˜åŠŸèƒ½å¯èƒ½å­˜åœ¨é—®é¢˜',
                    action: 'æ£€æŸ¥ admin.html ä¸­çš„ç®¡ç†åŠŸèƒ½'
                });
            }

            if (!testResults.network) {
                suggestions.push({
                    title: 'ç½‘ç»œè¿æ¥é—®é¢˜',
                    description: 'ç½‘ç»œéŸ§æ€§æµ‹è¯•å¤±è´¥',
                    action: 'æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®'
                });
            }

            contentDiv.innerHTML = suggestions.map(suggestion => `
                <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded p-4">
                    <h4 class="font-semibold text-yellow-400">${suggestion.title}</h4>
                    <p class="text-gray-300 mt-2">${suggestion.description}</p>
                    <p class="text-yellow-300 mt-2 text-sm">å»ºè®®: ${suggestion.action}</p>
                </div>
            `).join('');

            suggestionsDiv.style.display = 'block';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>