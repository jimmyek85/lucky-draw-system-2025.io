<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>1602 Lucky Draw</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a202c;
            color: #f7fafc;
        }
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: auto;
        }
        #canvas {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ff8a8a, #f56565);
            border: 5px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .pointer::after {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 15px solid white;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.7);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #landing-page-container {
            background: #0d0d0d;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: fadeIn 1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(253, 224, 71, 0.2);
            animation: float 25s infinite linear;
            bottom: -50px;
        }
        @keyframes float {
            0% { transform: translateY(0) translateX(0); opacity: 0.5; }
            100% { transform: translateY(-100vh) translateX(var(--x-end)); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #wheel-wrapper {
            border-radius: 50%;
            transition: box-shadow 0.5s ease-in-out;
        }
        .spinning-neon {
            animation: neon-flicker 1.5s infinite alternate;
        }
        @keyframes neon-flicker {
          from {
            box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #f0f, 0 0 40px #f0f, 0 0 50px #f0f, 0 0 60px #f0f, 0 0 70px #f0f;
          }
          to {
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #0ff, 0 0 20px #0ff, 0 0 25px #0ff, 0 0 30px #0ff, 0 0 35px #0ff;
          }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">

        <!-- Language Switcher -->
        <div class="text-center mb-4">
            <button id="lang-en" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">English</button>
            <button id="lang-zh" class="px-3 py-1 bg-gray-600 text-white rounded-md text-sm">中文</button>
        </div>

        <!-- Engaging Landing Page -->
        <div id="landing-page-container">
            <div id="particles-container"></div>
            <div id="landing-page" class="text-center relative z-10">
                <h1 class="text-4xl font-bold mb-2 text-yellow-300" data-lang-en="A Surprise Awaits!">A Surprise Awaits!</h1>
                <p class="text-lg mb-4 text-white" data-lang-en="Meeting is fate, a gift is our bond.">Meeting is fate, a gift is our bond.</p>
                <div class="bg-white p-2 rounded-lg inline-block my-4 shadow-lg">
                     <!-- UPDATED: New QR Code -->
                     <img src="https://storage2.me-qr.com/qr/231358832.png" alt="1602 Lucky Draw QR Code" class="w-48 h-48">
                </div>
                <p class="mt-4 text-sm text-gray-300" data-lang-en="Scan or Click Below to Join!">Scan or Click Below to Join!</p>
                <button id="fast-track-btn" class="mt-6 w-full bg-gradient-to-r from-yellow-400 to-amber-500 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Enter Now">Enter Now</button>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="register-page" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-4" data-lang-en="Become a 1602 Member">Become a 1602 Member</h2>
            <p class="text-center mb-6 text-gray-300" data-lang-en="Fill in your details to get 1 free spin!">Fill in your details to get 1 free spin!</p>
            <form id="register-form">
                <div class="mb-4">
                    <label for="name" class="block mb-2 text-sm font-medium" data-lang-en="Name (Required)">Name (Required)</label>
                    <input type="text" id="name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block mb-2 text-sm font-medium" data-lang-en="Phone (Required)">Phone (Required)</label>
                    <div class="flex">
                        <select id="country-code" aria-label="Country Code" title="Select Country Code" class="bg-gray-700 border border-r-0 border-gray-600 rounded-l-lg p-2.5 text-white focus:outline-none"></select>
                        </select>
                        <input type="tel" id="phone" class="w-full bg-gray-700 border border-gray-600 rounded-r-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="1123456789" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="email" class="block mb-2 text-sm font-medium" data-lang-en="Email (Optional)">Email (Optional)</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="address" class="block mb-2 text-sm font-medium" data-lang-en="Address (Optional)">Address (Optional)</label>
                    <input type="text" id="address" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="submit-register" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105" data-lang-en="Submit & Get Spin!">Submit & Get Spin!</button>
            </form>
        </div>

        <!-- Lucky Wheel Page -->
        <div id="wheel-page" class="hidden text-center">
            <h2 class="text-3xl font-bold mb-2" data-lang-en="1602 Lucky Draw">1602 Lucky Draw</h2>
            <p class="mb-4" data-lang-en="Welcome, "><span id="user-name-display"></span>!</p>
            <div id="wheel-wrapper" class="p-2 inline-block">
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <canvas id="canvas" width="400" height="400"></canvas>
                </div>
            </div>
            <button id="spin-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                <span data-lang-en="SPIN">SPIN</span> (<span id="chances-left">0</span> <span data-lang-en="chances left">chances left</span>)
            </button>
            <div class="mt-4 flex justify-center gap-4">
                <button id="tnc-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Prize T&C">Prize T&C</button>
                <button id="beer-sommelier-btn" class="text-sm text-purple-400 hover:text-purple-300 font-bold" data-lang-en="✨ AI Beer Recommendation">✨ AI Beer Recommendation</button>
                <button id="packages-btn" class="text-sm text-gray-400 hover:text-white" data-lang-en="Our Packages">Our Packages</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-auto text-center">
            <h3 id="modal-title" class="text-3xl font-bold mb-4"></h3>
            <div id="modal-content">
                <p id="modal-text" class="text-lg mb-2"></p>
                <div id="online-voucher-instructions" class="hidden text-sm mt-4 p-3 bg-gray-700 rounded-lg">
                    <p class="font-bold mb-2" data-lang-en="How to Claim Your Online Voucher:">How to Claim Your Online Voucher:</p>
                    <p data-lang-en="Download our '1602craftbeer' app to redeem your prize!">Download our '1602craftbeer' app to redeem your prize!</p>
                    <div class="flex justify-center gap-4 mt-2">
                        <a href="https://apps.apple.com/your-app-link" target="_blank" rel="noopener" class="opacity-80 hover:opacity-100"><img src="https://placehold.co/120x40/000000/FFFFFF?text=App+Store" alt="Download on the App Store"></a>
                        <a href="https://play.google.com/store/apps/details?id=your.app.id" target="_blank" rel="noopener" class="opacity-80 hover:opacity-100"><img src="https://placehold.co/120x40/000000/FFFFFF?text=Google+Play" alt="Get it on Google Play"></a>
                    </div>
                </div>
                <button id="gemini-idea-btn" class="hidden w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 my-4">
                    ✨ <span data-lang-en="AI, give me an idea!">AI, give me an idea!</span>
                </button>
            </div>
            <div id="gemini-loading" class="hidden">
                <div class="loader"></div>
                <p data-lang-en="Our AI is thinking...">Our AI is thinking...</p>
            </div>
            <div id="share-section" class="mt-4 pt-4 border-t border-gray-600">
                <p class="mb-3 text-sm" data-lang-en="Share to get a RM2 cash voucher!">Share to get a RM2 cash voucher!</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="share('facebook')" title="Share on Facebook" aria-label="Share on Facebook" class="bg-blue-800 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v2.385z"/></svg></button>
                    <button onclick="share('instagram')" title="Share on Instagram" aria-label="Share on Instagram" class="bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069-3.204 0-3.584-.012-4.849-.069-3.225-.149-4.771-1.664-4.919-4.919-.058-1.265-.069-1.645-.069-4.849 0-3.204.012-3.584.069-4.849.149-3.225 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg></button>
                    <button onclick="share('copy_whatsapp')" title="Share on WhatsApp" aria-label="Share on WhatsApp" class="bg-gray-500 text-white p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:opacity-80 transition-opacity"><svg fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                </div>
            </div>
            <button id="modal-close-btn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg" data-lang-en="Close">Close</button>
        </div>
    </div>

    <!-- Generic Modal for T&C, Packages, and Announcements -->
    <div id="generic-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 id="generic-modal-title" class="text-2xl font-bold"></h3>
                <button id="generic-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div id="generic-modal-content" class="text-gray-300 text-sm space-y-2">
            </div>
        </div>
    </div>

    <!-- AI Beer Sommelier Modal -->
    <div id="beer-modal" class="fixed inset-0 w-full h-full flex items-center justify-center modal-bg hidden z-50 p-4">
        <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-auto text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 id="beer-modal-title" class="text-2xl font-bold" data-lang-en="✨ AI Beer Sommelier">✨ AI Beer Sommelier</h3>
                <button id="beer-modal-close-btn" class="text-2xl leading-none">&times;</button>
            </div>
            <div id="beer-modal-content">
                <p class="mb-4" data-lang-en="What kind of flavor are you in the mood for?">What kind of flavor are you in the mood for?</p>
                <div class="space-y-3">
                    <button data-flavor="Pale Ale" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Pale Ale (Fruity & Light)">Pale Ale (Fruity & Light)</button>
                    <button data-flavor="Extra Dark" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Extra Dark (Rich & Malty)">Extra Dark (Rich & Malty)</button>
                    <button data-flavor="Lager" class="beer-flavor-btn w-full text-left p-3 bg-gray-700 hover:bg-purple-600 rounded-lg transition-colors" data-lang-en="Lager (Classic & Crisp)">Lager (Classic & Crisp)</button>
                </div>
            </div>
             <div id="beer-loading" class="hidden">
                <div class="loader"></div>
                <p class="text-center" data-lang-en="Our AI Sommelier is pouring a recommendation...">Our AI Sommelier is pouring a recommendation...</p>
            </div>
            <div id="beer-recommendation" class="hidden mt-4 text-purple-300 italic"></div>
        </div>
    </div>


    <!-- API Configuration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="enhanced-supabase-connection.js"></script>
    <script src="supabase-connection.js"></script>
    <script src="ai-features.js"></script>
    <script src="fix-connection.js"></script>
    <script src="fix-three-errors.js"></script>
    <script src="supabase-connection-fix.js"></script>
    <script>
        // 浏览器兼容性检查
        if (!window.fetch) {
            console.error('This browser does not support fetch API. Please use a modern browser.');
        }
        
        // 初始化 Supabase 客户端，优化实时连接配置
        let supabase;
        try {
            supabase = window.supabase.createClient(
                window.SUPABASE_CONFIG?.SUPABASE_URL || 'https://your-project-id.supabase.co',
                window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY || 'your-supabase-anon-key-here',
                {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true
                    },
                    realtime: {
                        params: {
                            eventsPerSecond: 10
                        },
                        heartbeatIntervalMs: 30000,
                        reconnectAfterMs: function(tries) {
                            return Math.min(tries * 1000, 30000);
                        }
                    },
                    db: {
                        schema: 'public'
                    },
                    global: {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    }
                }
            );
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
            supabase = null;
        }
        
        // 数据库表名
        const TABLES = window.SUPABASE_CONFIG?.TABLES || {
            USERS: 'users',
            SETTINGS: 'settings',
            KNOWLEDGE: 'knowledge'
        };
        
        // 实时订阅管理
        let realtimeSubscriptions = [];

        const langData = {
            en: {
                "Welcome to 1602": "Welcome to 1602",
                "Scan the QR code to participate!": "Scan the QR code to participate!",
                "This is the official entry point for the 1602 Lucky Draw.": "This is the official entry point for the 1602 Lucky Draw.",
                "A Surprise Awaits!": "A Surprise Awaits!",
                "Meeting is fate, a gift is our bond.": "Meeting is fate, a gift is our bond.",
                "Scan or Click Below to Join!": "Scan or Click Below to Join!",
                "Enter Now": "Enter Now",
                "Become a 1602 Member": "Become a 1602 Member",
                "Fill in your details to get 1 free spin!": "Fill in your details to get 1 free spin!",
                "Name (Required)": "Name (Required)",
                "Phone (Required)": "Phone (Required)",
                "Email (Optional)": "Email (Optional)",
                "Address (Optional)": "Address (Optional)",
                "Submit & Get Spin!": "Submit & Get Spin!",
                "1602 Lucky Draw": "1602 Lucky Draw",
                "Welcome, ": "Welcome, ",
                "SPIN": "SPIN",
                "chances left": "chances left",
                "Share to get a RM2 cash voucher!": "Share to get a RM2 cash voucher!",
                "Close": "Close",
                "AI, give me an idea!": "AI, give me an idea!",
                "Our AI is thinking...": "Our AI is thinking...",
                "Prize T&C": "Prize T&C",
                "Our Packages": "Our Packages",
                "How to Claim Your Online Voucher:": "How to Claim Your Online Voucher:",
                "Download our '1602craftbeer' app to redeem your prize!": "Download our '1602craftbeer' app to redeem your prize!",
                "Terms & Conditions": "Terms & Conditions",
                "1602 Packages": "1602 Packages",
                "✨ AI Beer Recommendation": "✨ AI Beer Recommendation",
                "✨ AI Beer Sommelier": "✨ AI Beer Sommelier",
                "What kind of flavor are you in the mood for?": "What kind of flavor are you in the mood for?",
                "Pale Ale (Fruity & Light)": "Pale Ale (Fruity & Light)",
                "Extra Dark (Rich & Malty)": "Extra Dark (Rich & Malty)",
                "Lager (Classic & Crisp)": "Lager (Classic & Crisp)",
                "Our AI Sommelier is pouring a recommendation...": "Our AI Sommelier is pouring a recommendation...",
                "Event Announcement": "Event Announcement",
                "Wine Card": "Wine Card",
                "Cash Voucher RM5": "Cash Voucher RM5",
                "Online Voucher RM10": "Online Voucher RM10",
                "Online Voucher RM20": "Online Voucher RM20",
                "New 330ml Can": "New 330ml Can",
                "Free 660ml Bottle": "Free 660ml Bottle",
                "1602 Pen": "1602 Pen",
                "Cooler Bag": "Cooler Bag",
                "1602 Mug": "1602 Mug",
                "Thank You": "Thank You",
                "Spin Again!": "Spin Again!",
                "Congratulations!": "Congratulations!",
                "Oh No...": "Oh No...",
                "Awesome!": "Awesome!",
                "You won a": "You won a",
                "Better luck next time!": "Better luck next time!",
                "You get another free spin!": "You get another free spin!",
                "Copied to clipboard! And opening WhatsApp...": "Copied to clipboard! And opening WhatsApp...",
                "Link copied! Please share it on Instagram.": "Link copied! Please share it on Instagram.",
                "User already exists. Loading your data...": "User already exists. Loading your data...",
                "Registration successful!": "Registration successful!",
                "Please fill in required fields.": "Please fill in required fields.",
                "Please enter a valid phone number (digits only).": "Please enter a valid phone number (digits only).",
            },
            zh: {
                "Welcome to 1602": "欢迎来到 1602",
                "Scan the QR code to participate!": "请扫描二维码参与活动！",
                "This is the official entry point for the 1602 Lucky Draw.": "这是1602幸运轮盘的官方活动入口。",
                "A Surprise Awaits!": "扫码有惊喜！",
                "Meeting is fate, a gift is our bond.": "与你相遇是缘分，扫码送礼结情分。",
                "Scan or Click Below to Join!": "扫描或点击下方按钮参与！",
                "Enter Now": "快捷通道",
                "Become a 1602 Member": "成为 1602 会员",
                "Fill in your details to get 1 free spin!": "填写资料即可获得1次免费抽奖机会！",
                "Name (Required)": "名字（必填）",
                "Phone (Required)": "电话（必填）",
                "Email (Optional)": "邮箱（选填）",
                "Address (Optional)": "地址（选填）",
                "Submit & Get Spin!": "提交并获取抽奖机会！",
                "1602 Lucky Draw": "1602 幸运轮盘",
                "Welcome, ": "欢迎, ",
                "SPIN": "开始抽奖",
                "chances left": "次机会",
                "Share to get a RM2 cash voucher!": "成功分享可获得RM2现金券！",
                "Close": "关闭",
                "AI, give me an idea!": "AI给我一个好主意！",
                "Our AI is thinking...": "AI正在为您生成创意...",
                "Prize T&C": "领奖 T&C",
                "Our Packages": "优惠套餐",
                "How to Claim Your Online Voucher:": "如何领取您的线上代金券:",
                "Download our '1602craftbeer' app to redeem your prize!": "请下载我们的 “1602craftbeer” App 领取您的奖励！",
                "Terms & Conditions": "条款与规定",
                "1602 Packages": "1602 优惠套餐",
                "✨ AI Beer Recommendation": "✨ AI 啤酒推荐",
                "✨ AI Beer Sommelier": "✨ AI 啤酒品鉴顾问",
                "What kind of flavor are you in the mood for?": "您今天想喝点什么口味？",
                "Pale Ale (Fruity & Light)": "清爽果香 (Pale Ale)",
                "Extra Dark (Rich & Malty)": "浓郁麦香 (Extra Dark)",
                "Lager (Classic & Crisp)": "经典原味 (Lager)",
                "Event Announcement": "活动公告",
                "Wine Card": "酒卡",
                "Cash Voucher RM5": "RM5 现金券",
                "Online Voucher RM10": "RM10 线上券",
                "Online Voucher RM20": "RM20 线上券",
                "New 330ml Can": "330ml罐装新品",
                "Free 660ml Bottle": "免费660ml瓶装",
                "1602 Pen": "1602纪念笔",
                "Cooler Bag": "保冷袋",
                "1602 Mug": "纪念酒杯",
                "Thank You": "谢谢参与",
                "Spin Again!": "再来一次！",
                "Congratulations!": "恭喜！",
                "Oh No...": "很遗憾...",
                "Awesome!": "太棒了！",
                "You won a": "您抽中了",
                "Better luck next time!": "祝您下次好运！",
                "You get another free spin!": "您获得了一次额外抽奖机会！",
                "Copied to clipboard! And opening WhatsApp...": "已复制链接！正在打开WhatsApp...",
                "Link copied! Please share it on Instagram.": "已复制链接！请到Instagram分享。",
                "User already exists. Loading your data...": "用户已存在，正在加载您的数据...",
                "Registration successful!": "注册成功！",
                "Please fill in required fields.": "请填写必填项。",
                "Please enter a valid phone number (digits only).": "请输入有效的电话号码（仅限数字）。",
            }
        };

        let currentLang = 'en';
        let knowledgeBaseContent = '';

        const landingPageContainer = document.getElementById('landing-page-container');
        const registerPage = document.getElementById('register-page');
        const wheelPage = document.getElementById('wheel-page');
        const registerForm = document.getElementById('register-form');
        const spinBtn = document.getElementById('spin-btn');
        const chancesLeftSpan = document.getElementById('chances-left');
        const userNameDisplay = document.getElementById('user-name-display');
        const resultModal = document.getElementById('result-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalText = document.getElementById('modal-text');
        const onlineVoucherInstructions = document.getElementById('online-voucher-instructions');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const geminiIdeaBtn = document.getElementById('gemini-idea-btn');
        const geminiLoading = document.getElementById('gemini-loading');
        const genericModal = document.getElementById('generic-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalContent = document.getElementById('generic-modal-content');
        const genericModalCloseBtn = document.getElementById('generic-modal-close-btn');
        const beerModal = document.getElementById('beer-modal');
        const beerModalCloseBtn = document.getElementById('beer-modal-close-btn');
        const beerModalContent = document.getElementById('beer-modal-content');
        const beerLoading = document.getElementById('beer-loading');
        const beerRecommendation = document.getElementById('beer-recommendation');


        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // 默认奖品配置（离线模式或加载失败时使用）
        let prizes = [
            { text: "Cash Voucher RM5", color: "#fde047", percentage: 18 },
            { text: "Thank You", color: "#4b5563", percentage: 25 },
            { text: "Online Voucher RM10", color: "#60a5fa", percentage: 7 },
            { text: "Free 660ml Bottle", color: "#ef4444", percentage: 8 },
            { text: "1602 Mug", color: "#a78bfa", percentage: 0 },
            { text: "Spin Again!", color: "#f97316", percentage: 9 },
            { text: "Online Voucher RM20", color: "#22c55e", percentage: 5 },
            { text: "1602 Pen", color: "#ec4899", percentage: 9 },
            { text: "Wine Card", color: "#d946ef", percentage: 0 },
            { text: "Cooler Bag", color: "#14b8a6", percentage: 7 },
            { text: "New 330ml Can", color: "#84cc16", percentage: 12 },
        ];

        let totalPercentage = 0;
        let prizeSegments = prizes.map(p => {
            const start = totalPercentage;
            totalPercentage += p.percentage;
            const end = totalPercentage;
            return { ...p, start, end };
        });
        
        // 更新奖品段落计算的函数
        function updatePrizeSegments() {
            let total = 0;
            prizeSegments = prizes.map(p => {
                const start = total;
                total += p.percentage;
                const end = total;
                return { ...p, start, end };
            });
            numSegments = prizes.length;
            anglePerSegment = 2 * Math.PI / numSegments;
        }

        let numSegments = prizes.length;
        let anglePerSegment = 2 * Math.PI / numSegments;
        let isSpinning = false;
        let currentUser = null;
        let unsubscribeUser;

        // 使用新的 GeminiAI 类
        async function callGemini(prompt, loadingElement, contentElement) {
            loadingElement.classList.remove('hidden');
            if (contentElement) contentElement.classList.add('hidden');

            try {
                const result = await geminiAI.callAPI(prompt, knowledgeBaseContent, currentLang);
                return result;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return currentLang === 'zh' 
                    ? "AI 似乎在休息中，请稍后再试。" 
                    : "Our AI seems to be on a break. Please try again.";
            } finally {
                loadingElement.classList.add('hidden');
                if (contentElement) contentElement.classList.remove('hidden');
            }
        }

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = 'bold 14px Poppins';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';

            prizes.forEach((prize, i) => {
                const startAngle = (i * anglePerSegment) - (Math.PI / 2);
                const endAngle = ((i + 1) * anglePerSegment) - (Math.PI / 2);

                ctx.beginPath();
                ctx.moveTo(200, 200);
                ctx.arc(200, 200, 200, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.save();
                
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                ctx.translate(200, 200);
                ctx.rotate(startAngle + anglePerSegment / 2);
                ctx.fillText(langData[currentLang][prize.text] || prize.text, 120, 0);
                ctx.restore();
            });
        }
        
        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-en]').forEach(el => {
                const key = el.dataset.langEn;
                const translatedText = langData[lang][key] || key;
                
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = translatedText;
                } else {
                    const target = el.querySelector('span') || el;
                    const textNode = Array.from(target.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '');
                    if(textNode) {
                        textNode.textContent = translatedText;
                    } else {
                        target.textContent = translatedText;
                    }
                }
            });
            if (chancesLeftSpan.textContent) {
                updateChancesText(parseInt(chancesLeftSpan.textContent));
            }
            drawWheel();
            document.getElementById('lang-en').classList.toggle('bg-blue-500', lang === 'en');
            document.getElementById('lang-en').classList.toggle('bg-gray-600', lang !== 'en');
            document.getElementById('lang-zh').classList.toggle('bg-blue-500', lang === 'zh');
            document.getElementById('lang-zh').classList.toggle('bg-gray-600', lang !== 'zh');
        }
        
        document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
        document.getElementById('lang-zh').addEventListener('click', () => switchLanguage('zh'));
        
        function getPrizeFromPercentage() {
            let rand = Math.random() * 100;
            for (const prize of prizeSegments) {
                if (rand >= prize.start && rand < prize.end) {
                    return prize;
                }
            }
            return prizeSegments[0];
        }

        function spin() {
            if (isSpinning || currentUser.remaining_chances <= 0) return;
            isSpinning = true;
            spinBtn.disabled = true;
            document.getElementById('wheel-wrapper').classList.add('spinning-neon');

            const targetPrize = getPrizeFromPercentage();
            const targetIndex = prizes.findIndex(p => p.text === targetPrize.text);
            
            const baseRotations = 5 * 360;
            const segmentAngle = 360 / numSegments;
            const targetAngle = segmentAngle * targetIndex;
            const randomOffset = (Math.random() * 0.8 + 0.1) * segmentAngle;
            const finalAngle = baseRotations - targetAngle - randomOffset;

            canvas.style.transform = `rotate(${finalAngle}deg)`;
            
            setTimeout(async () => {
                isSpinning = false;
                document.getElementById('wheel-wrapper').classList.remove('spinning-neon');
                canvas.style.transition = 'none';
                const currentTransform = canvas.style.transform;
                const currentAngle = parseFloat(currentTransform.replace(/[^0-9.-]/g, ''));
                canvas.style.transform = `rotate(${currentAngle % 360}deg)`;
                canvas.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';

                await handlePrize(targetPrize);
            }, 5000);
        }

        async function handlePrize(prize) {
            let newChances = currentUser.remaining_chances - 1;

            const prizeText = langData[currentLang][prize.text] || prize.text;

            const updatedPrizes = currentUser.prizeswon || [];
            updatedPrizes.push({ prize: prize.text, timestamp: new Date() });
            
            const isOnlineVoucher = prize.text.includes("Online Voucher");

            if (prize.text === "Spin Again!") {
                newChances += 1;
                showResult(langData[currentLang]["Awesome!"], langData[currentLang]["You get another free spin!"]);
            } else if (prize.text === "Thank You") {
                showResult(langData[currentLang]["Oh No..."], langData[currentLang]["Better luck next time!"], true);
            } else {
                showResult(langData[currentLang]["Congratulations!"], `${langData[currentLang]["You won a"]} ${prizeText}!`, false, isOnlineVoucher);
                confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });

                if (!isOfflineMode) {
                    try {
                        const aiDescription = await geminiAI.getPersonalizedWinMessage(prizeText, currentLang);
                        modalText.innerHTML += `<br/><br/><p class="text-sm italic text-purple-300">${aiDescription}</p>`;
                    } catch (error) {
                        console.error("AI message generation error:", error);
                    }
                }
            }

            // 更新用户数据
            currentUser.remaining_chances = newChances;
            currentUser.prizeswon = updatedPrizes;

            if (isOfflineMode) {
                // 离线模式：保存到本地存储
                localStorage.setItem('offlineUser', JSON.stringify(currentUser));
                updateChancesText(newChances);
                spinBtn.disabled = newChances <= 0 || isSpinning;
            } else {
                // 在线模式：更新到 Supabase
                try {
                    // 1. 更新用户表
                    const { error: userError } = await supabase
                        .from(TABLES.USERS)
                        .update({
                            remaining_chances: newChances,
                            prizeswon: updatedPrizes,
                            draw_count: (currentUser.draw_count || 0) + 1,
                            last_draw_date: new Date().toISOString()
                        })
                        .eq('phone', currentUser.phone);
                    
                    if (userError) throw userError;

                    // 2. 保存抽奖记录到 draw_history 表
                    const { error: historyError } = await supabase
                        .from('draw_history')
                        .insert({
                            user_id: currentUser.id,
                            user_phone: currentUser.phone,
                            user_name: currentUser.name,
                            prize_won: prize.text,
                            draw_date: new Date().toISOString(),
                            remaining_chances_after: newChances
                        });
                    
                    if (historyError) {
                        console.warn("抽奖记录保存失败:", historyError);
                        // 不阻止主流程，只记录警告
                    }

                    console.log("用户数据和抽奖记录更新成功");
                } catch (error) {
                    console.error("Error updating user data:", error);
                    // 如果更新失败，至少在本地更新
                    updateChancesText(newChances);
                    spinBtn.disabled = newChances <= 0 || isSpinning;
                }
            }
        }
        
        function showResult(title, text, isThankYou = false, isOnlineVoucher = false) {
            modalTitle.textContent = title;
            modalText.innerHTML = text;
            geminiIdeaBtn.classList.toggle('hidden', !isThankYou);
            onlineVoucherInstructions.classList.toggle('hidden', !isOnlineVoucher);
            resultModal.classList.remove('hidden');
        }

        geminiIdeaBtn.addEventListener('click', async () => {
            try {
                const idea = await geminiAI.getCreativeSuggestion(currentLang);
                modalText.textContent = idea;
                geminiIdeaBtn.classList.add('hidden');
            } catch (error) {
                console.error("Creative suggestion error:", error);
                const fallbackText = currentLang === 'zh' 
                    ? "AI 正在思考中，请稍后再试！别忘了您还可以通过消费RM60获得更多抽奖机会哦！" 
                    : "Our AI is thinking hard! Please try again later. Don't forget you can get more chances by spending RM60!";
                modalText.textContent = fallbackText;
                geminiIdeaBtn.classList.add('hidden');
            }
        });

        modalCloseBtn.addEventListener('click', () => resultModal.classList.add('hidden'));

        function updateChancesText(chances) {
             chancesLeftSpan.textContent = chances;
             if (currentLang === 'en') {
                chancesLeftSpan.nextElementSibling.textContent = ' chances left';
             } else {
                chancesLeftSpan.nextElementSibling.textContent = ' 次机会';
             }
        }

        function setupUserSession(userData) {
            currentUser = userData;
            userNameDisplay.textContent = currentUser.name;
            updateChancesText(userData.remaining_chances || userData.drawchances || 1);
            spinBtn.disabled = (userData.remaining_chances || userData.drawchances || 1) <= 0;

            landingPageContainer.classList.add('hidden');
            registerPage.classList.add('hidden');
            wheelPage.classList.remove('hidden');

            if (!isOfflineMode) {
                // 在线模式：监听 Supabase 数据变化
                // 清除之前的订阅
                realtimeSubscriptions.forEach(subscription => {
                    supabase.removeChannel(subscription);
                });
                realtimeSubscriptions = [];
                
                // 创建新的实时订阅
                const userSubscription = supabase
                    .channel('user-changes')
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: TABLES.USERS,
                        filter: `phone=eq.${currentUser.phone}`
                    }, (payload) => {
                        if (payload.new) {
                            currentUser = payload.new;
                            updateChancesText(currentUser.remaining_chances || currentUser.drawchances || 1);
                            spinBtn.disabled = (currentUser.remaining_chances || currentUser.drawchances || 1) <= 0 || isSpinning;
                        }
                    })
                    .subscribe();
                
                realtimeSubscriptions.push(userSubscription);
            }
        }

        // 获取抽奖配置
        async function getLotteryConfig() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'lottery_config')
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.warn('获取抽奖配置失败，使用默认配置:', error);
                    return { INITIAL_CHANCES: 1 };
                }

                if (data && data.content) {
                    try {
                        return JSON.parse(data.content);
                    } catch (parseError) {
                        console.warn('配置数据格式错误，使用默认配置:', parseError);
                        return { INITIAL_CHANCES: 1 };
                    }
                }

                return { INITIAL_CHANCES: 1 };
            } catch (error) {
                console.warn('获取抽奖配置异常，使用默认配置:', error);
                return { INITIAL_CHANCES: 1 };
            }
        }

        async function handleRegistration(e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const countryCode = document.getElementById('country-code').value;
            const phoneInput = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();

            if (!name || !phoneInput) {
                alert(langData[currentLang]["Please fill in required fields."]);
                return;
            }

            if (!/^\d+$/.test(phoneInput)) {
                alert(langData[currentLang]["Please enter a valid phone number (digits only)."]);
                return;
            }

            const phone = countryCode + phoneInput;

            // 首先尝试连接Supabase
            try {
                // 测试Supabase连接
                const { data: connectionTest, error: connectionError } = await supabase
                    .from(TABLES.USERS)
                    .select('count')
                    .limit(1);
                
                if (connectionError && connectionError.code !== 'PGRST116') {
                    throw new Error(`Supabase连接失败: ${connectionError.message}`);
                }

                // 连接成功，检查用户是否已存在
                const { data: existingUser, error: fetchError } = await supabase
                    .from(TABLES.USERS)
                    .select('*')
                    .eq('phone', phone)
                    .single();

                if (existingUser && !fetchError) {
                    alert(langData[currentLang]["User already exists. Loading your data..."]);
                    setupUserSession(existingUser);
                    // 确保不在离线模式
                    if (isOfflineMode) {
                        isOfflineMode = false;
                        const offlineNotice = document.querySelector('.fixed.top-0.bg-yellow-600');
                        if (offlineNotice) offlineNotice.remove();
                    }
                } else {
                    // 获取抽奖配置
                    const lotteryConfig = await getLotteryConfig();
                    
                    // 创建新用户
                    const userData = {
                        name,
                        phone,
                        email,
                        address,
                        remaining_chances: lotteryConfig.INITIAL_CHANCES || 1,
                        joindate: new Date().toISOString(),
                        prizeswon: []
                    };
                    
                    const { data, error } = await supabase
                        .from(TABLES.USERS)
                        .insert([userData])
                        .select()
                        .single();
                    
                    if (error) {
                        console.error("用户插入错误:", error);
                        throw new Error(`用户注册失败: ${error.message}`);
                    }
                    
                    alert(langData[currentLang]["Registration successful!"]);
                    setupUserSession(data);
                    
                    // 确保不在离线模式
                    if (isOfflineMode) {
                        isOfflineMode = false;
                        const offlineNotice = document.querySelector('.fixed.top-0.bg-yellow-600');
                        if (offlineNotice) offlineNotice.remove();
                    }
                }
            } catch (error) {
                console.error("注册过程中发生错误:", error);
                console.log("启用离线模式...");
                
                // Supabase连接失败，启用离线模式
                if (!isOfflineMode) {
                    enableOfflineMode();
                }
                
                const newUser = {
                    name,
                    phone,
                    email,
                    address,
                    remaining_chances: (typeof LOTTERY_CONFIG !== 'undefined' && LOTTERY_CONFIG) ? LOTTERY_CONFIG.INITIAL_CHANCES : 1,
                    joindate: new Date().toISOString(),
                    prizeswon: []
                };
                
                offlineUserData = newUser;
                localStorage.setItem('offlineUser', JSON.stringify(newUser));
                
                const offlineMessage = currentLang === 'zh' 
                    ? "注册成功！(离线模式 - 数据将在连接恢复后同步)"
                    : "Registration successful! (Offline mode - data will sync when connection is restored)";
                
                alert(offlineMessage);
                setupUserSession(newUser);
            }
        }
        
        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert(langData[currentLang]["Copied to clipboard! And opening WhatsApp..."]);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        window.share = function(platform) {
            const text = `🎉 1602手工精酿邀请您参加2025年古晋美食节！🍻\n\n快来我们的档口品尝新鲜出炉的鲜啤酒！现场分享此消息，即可额外获赠RM2代金券，还能参与我们的幸运轮盘大抽奖活动！🎁\n\n人人有机会，好酒好礼有惊喜！1602在古晋美食节档口等着您的光临!`;
            let shareUrl = '';

            switch(platform) {
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=https://www.example.com&quote=${encodeURIComponent(text)}`;
                    window.open(shareUrl, '_blank');
                    break;
                case 'instagram':
                    window.open('https://www.instagram.com', '_blank');
                    break;
                case 'copy_whatsapp':
                    copyTextToClipboard(text);
                    shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
                    window.open(shareUrl, '_blank');
                    break;
            }
        }

        function populateCountryCodes() {
            const countries = [
                { code: "+60", name: "Malaysia" },
                { code: "+65", name: "Singapore" },
                { code: "+86", name: "China" },
                { code: "+91", name: "India" },
                { code: "+61", name: "Australia" },
                { code: "+44", name: "United Kingdom" },
                { code: "+1", name: "USA / Canada" },
                { code: "+81", name: "Japan" },
                { code: "+82", name: "South Korea" },
            ];
            const select = document.getElementById('country-code');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = `${country.name} (${country.code})`;
                if (country.code === "+60") {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function showGenericModal(type, customContent = '') {
            let title = '';
            let content = '';

            switch(type) {
                case 'tnc':
                    title = langData[currentLang]["Terms & Conditions"];
                    content = currentLang === 'zh' ? 
                    `<p>1. 所有奖品不可兑换现金。</p><p>2. 线上代金券需下载'1602craftbeer' App使用。</p><p>3. 现金券仅限活动现场使用。</p><p>4. 1602保留对活动的最终解释权。</p><p class="mt-4">想了解更多？请游览官网: <a href="https://www.1602craftbeer.com" target="_blank" class="text-yellow-400 hover:underline">1602craftbeer.com</a></p>` :
                    `<p>1. All prizes are non-exchangeable for cash.</p><p>2. Online vouchers must be redeemed via the '1602craftbeer' app.</p><p>3. Cash vouchers are only valid for use at the event.</p><p>4. 1602 reserves the right for the final interpretation of the event.</p><p class="mt-4">Want to know more? Visit our official website: <a href="https://www.1602craftbeer.com" target="_blank" class="text-yellow-400 hover:underline">1602craftbeer.com</a></p>`;
                    break;
                case 'packages':
                    title = langData[currentLang]["1602 Packages"];
                    content = currentLang === 'zh' ?
                    `<p><strong>套餐A (RM 80):</strong> 2杯精酿啤酒 + 1份小吃。</p><p><strong>套餐B (RM 150):</strong> 4杯精酿啤酒 + 2份小吃 + 纪念品一份。</p><p><strong>畅饮套餐 (RM 200/人):</strong> 2小时内精酿啤酒无限畅饮。</p>` :
                    `<p><strong>Package A (RM 80):</strong> 2 Craft Beers + 1 Snack.</p><p><strong>Package B (RM 150):</strong> 4 Craft Beers + 2 Snacks + 1 Souvenir.</p><p><strong>Free Flow Package (RM 200/pax):</strong> 2 hours of unlimited craft beer.</p>`;
                    break;
                case 'announcement':
                    title = langData[currentLang]["Event Announcement"];
                    content = customContent.replace(/\n/g, '<br/>');
                    break;
            }
            
            genericModalTitle.textContent = title;
            genericModalContent.innerHTML = content;
            genericModal.classList.remove('hidden');
        }

        async function handleBeerRecommendation(flavor) {
            try {
                const recommendationText = await geminiAI.getBeerRecommendation(flavor, currentLang);
                beerRecommendation.textContent = recommendationText;
                beerRecommendation.classList.remove('hidden');
            } catch (error) {
                console.error("Beer recommendation error:", error);
                const fallbackText = currentLang === 'zh' 
                    ? "抱歉，AI 品酒师暂时不在，请稍后再试。" 
                    : "Sorry, our AI sommelier is taking a break. Please try again later.";
                beerRecommendation.textContent = fallbackText;
                beerRecommendation.classList.remove('hidden');
            }
        }

        function createParticles() {
            const container = document.getElementById('particles-container');
            const particleCount = 30;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 10 + 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 15 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particle.style.setProperty('--x-end', `${Math.random() * 200 - 100}px`);
                container.appendChild(particle);
            }
        }
        
        async function fetchSettings() {
            try {
                // 获取最新的活跃公告
                const { data: announcementData, error: announcementError } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (announcementData && announcementData.length > 0 && !announcementError) {
                    const announcement = announcementData[0];
                    showAnnouncementModal(announcement);
                }
                
                // 获取产品知识库内容
                const { data: knowledgeData, error: knowledgeError } = await supabase
                    .from('product_knowledge')
                    .select('*')
                    .eq('is_active', true);
                
                if (knowledgeData && !knowledgeError) {
                    // 将知识库内容格式化为AI可用的文本
                    knowledgeBaseContent = knowledgeData.map(item => 
                        `产品名称: ${item.name}\n分类: ${item.category}\n描述: ${item.description}\n特点: ${item.features}\n价格: ${item.price}`
                    ).join('\n\n');
                    console.log("AI Knowledge Base loaded with", knowledgeData.length, "products.");
                }
                
                // 获取奖品配置
                const { data: prizesData, error: prizesError } = await supabase
                    .from('settings')
                    .select('content')
                    .eq('key', 'prizes_config')
                    .single();
                
                if (prizesData && !prizesError && prizesData.content && prizesData.content.prizes) {
                    // 更新奖品配置
                    prizes = prizesData.content.prizes.map(prize => ({
                        text: prize.text || prize.name,
                        color: prize.color,
                        percentage: prize.percentage
                    }));
                    
                    // 重新计算奖品段落
                    updatePrizeSegments();
                    
                    // 重新绘制转盘
                    drawWheel();
                    
                    console.log("Prizes configuration loaded from backend:", prizes.length, "prizes");
                } else {
                    console.log("Using default prizes configuration");
                }
            } catch (error) {
                console.error("Error fetching settings:", error);
            }
        }

        // 显示公告弹窗
        function showAnnouncementModal(announcement) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 w-full h-full flex items-center justify-center modal-bg z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 text-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-auto">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4 text-yellow-300">${announcement.title}</h3>
                        ${announcement.image_url ? `<img src="${announcement.image_url}" alt="公告图片" class="w-full h-48 object-cover rounded-lg mb-4">` : ''}
                        <div class="text-left mb-6">
                            <p class="text-gray-300 whitespace-pre-wrap">${announcement.content}</p>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                            ${currentLang === 'zh' ? '我知道了' : 'Got it'}
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 自动关闭功能（可选）
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 30000); // 30秒后自动关闭
        }
        
        // 离线模式支持
        let isOfflineMode = false;
        let offlineUserData = null;

        function enableOfflineMode() {
            isOfflineMode = true;
            console.log("Running in offline mode");
            
            // 显示离线提示
            const offlineNotice = document.createElement('div');
            offlineNotice.className = 'fixed top-0 left-0 right-0 bg-yellow-600 text-white text-center py-2 text-sm z-50';
            offlineNotice.innerHTML = '⚠️ 离线模式 - 数据将在连接恢复后同步';
            document.body.appendChild(offlineNotice);
        }

        async function initApp() {
            try {
                // 设置基本UI
                switchLanguage('zh');
                createParticles();
                populateCountryCodes();
                drawWheel();
                
                // 设置事件监听器
                registerForm.addEventListener('submit', handleRegistration);
                spinBtn.addEventListener('click', spin);
                document.getElementById('tnc-btn').addEventListener('click', () => showGenericModal('tnc'));
                document.getElementById('packages-btn').addEventListener('click', () => showGenericModal('packages'));
                genericModalCloseBtn.addEventListener('click', () => genericModal.classList.add('hidden'));
                document.getElementById('fast-track-btn').addEventListener('click', () => {
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                });
                document.getElementById('beer-sommelier-btn').addEventListener('click', () => {
                    beerRecommendation.classList.add('hidden');
                    beerModal.classList.remove('hidden')
                });
                beerModalCloseBtn.addEventListener('click', () => beerModal.classList.add('hidden'));
                document.querySelectorAll('.beer-flavor-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleBeerRecommendation(btn.dataset.flavor));
                });

                // 检查本地存储的离线用户数据
                const savedOfflineUser = localStorage.getItem('offlineUser');
                if (savedOfflineUser) {
                    try {
                        offlineUserData = JSON.parse(savedOfflineUser);
                        console.log("Found offline user data:", offlineUserData);
                    } catch (e) {
                        console.error("Error parsing offline user data:", e);
                        localStorage.removeItem('offlineUser');
                    }
                }

                // 尝试连接 Supabase
                try {
                    // 测试 Supabase 连接
                    const { data, error } = await supabase.from(TABLES.USERS).select('count').limit(1);
                    if (error && error.code !== 'PGRST116') { // PGRST116 是空表错误，可以忽略
                        throw error;
                    }
                    
                    console.log("Connected to Supabase successfully.");
                    await fetchSettings();
                    
                    // 如果有离线用户数据且现在在线，尝试同步
                    if (offlineUserData) {
                        console.log("Attempting to sync offline user data...");
                        try {
                            const { data: existingUser, error: fetchError } = await supabase
                                .from(TABLES.USERS)
                                .select('*')
                                .eq('phone', offlineUserData.phone)
                                .single();
                            
                            if (existingUser && !fetchError) {
                                // 用户已存在，加载在线数据
                                setupUserSession(existingUser);
                            } else {
                                // 用户不存在，上传离线数据
                                const { data: newUser, error: insertError } = await supabase
                                    .from(TABLES.USERS)
                                    .insert([offlineUserData])
                                    .select()
                                    .single();
                                
                                if (insertError) throw insertError;
                                setupUserSession(newUser);
                            }
                            
                            // 清除本地离线数据
                            localStorage.removeItem('offlineUser');
                            offlineUserData = null;
                        } catch (syncError) {
                            console.error("Error syncing offline data:", syncError);
                            // 同步失败，继续使用离线数据
                            enableOfflineMode();
                            setupUserSession(offlineUserData);
                        }
                    }
                } catch (supabaseError) {
                    console.warn("Supabase connection failed, enabling offline mode:", supabaseError);
                    enableOfflineMode();
                    
                    // 如果有离线用户数据，直接使用
                    if (offlineUserData) {
                        setupUserSession(offlineUserData);
                    }
                }

                // 处理URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const source = urlParams.get('source');

                if (source === 'qrcode') {
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                } else {
                    landingPageContainer.classList.remove('hidden');
                    registerPage.classList.add('hidden');
                }

            } catch (error) {
                console.error("App Initialization Error:", error);
                // 即使出错也显示基本界面
                enableOfflineMode();
                
                // 如果有离线用户数据，使用它
                if (offlineUserData) {
                    setupUserSession(offlineUserData);
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const source = urlParams.get('source');

                if (source === 'qrcode') {
                    landingPageContainer.classList.add('hidden');
                    registerPage.classList.remove('hidden');
                } else {
                    landingPageContainer.classList.remove('hidden');
                    registerPage.classList.add('hidden');
                }
            }
        }

        initApp();
    </script>
</body>
</html>

</html>

