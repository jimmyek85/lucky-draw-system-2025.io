<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯åç«¯è¿æ¥ä¿®å¤æ–¹æ¡ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            line-height: 1.6;
        }
        .solution-section {
            background-color: #2a2a2a;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        button:hover { background-color: #45a049; }
        button.warning { background-color: #ff9800; }
        button.warning:hover { background-color: #e68900; }
        button.error { background-color: #f44336; }
        button.error:hover { background-color: #da190b; }
        .log {
            background-color: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 10px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .status-card {
            background-color: #333;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #666;
        }
        .status-card.success { border-left-color: #4CAF50; }
        .status-card.error { border-left-color: #f44336; }
        .status-card.warning { border-left-color: #ff9800; }
        .status-card.info { border-left-color: #2196F3; }
        .code-block {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .step-number {
            background-color: #4CAF50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        .step {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
        }
        .step-content {
            flex: 1;
        }
        h1, h2, h3 { color: #fff; }
        h2 { border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å‰ç«¯åç«¯è¿æ¥ä¿®å¤æ–¹æ¡ˆ</h1>
    
    <div class="solution-section">
        <h2>ğŸ“Š é—®é¢˜è¯Šæ–­ä¸è§£å†³çŠ¶æ€</h2>
        <button onclick="runComprehensiveDiagnosis()">ğŸš€ è¿è¡Œç»¼åˆè¯Šæ–­</button>
        <button onclick="applyAllFixes()">ğŸ”§ åº”ç”¨æ‰€æœ‰ä¿®å¤</button>
        <button onclick="clearAllResults()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç»“æœ</button>
        <div id="diagnosis-status" class="status-grid"></div>
    </div>

    <div class="solution-section">
        <h2>ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ</h2>
        <div class="status-grid">
            <div class="status-card info">
                <h3>é—®é¢˜1: æ•°æ®ä¿å­˜å¤±è´¥</h3>
                <p>ç”¨æˆ·æ³¨å†Œæ—¶æ•°æ®æ— æ³•ä¿å­˜åˆ°Supabaseæ•°æ®åº“</p>
                <ul>
                    <li>å¯èƒ½åŸå› : RLSæƒé™é…ç½®</li>
                    <li>å¯èƒ½åŸå› : è¡¨ç»“æ„ä¸åŒ¹é…</li>
                    <li>å¯èƒ½åŸå› : APIå¯†é’¥æƒé™ä¸è¶³</li>
                </ul>
            </div>
            <div class="status-card warning">
                <h3>é—®é¢˜2: ç¦»çº¿æ•°æ®ç§¯ç´¯</h3>
                <p>è¿æ¥å¤±è´¥æ—¶æ•°æ®ä¿å­˜åœ¨æœ¬åœ°å­˜å‚¨ä¸­</p>
                <ul>
                    <li>å½±å“: ç”¨æˆ·æ•°æ®ä¸¢å¤±é£é™©</li>
                    <li>å½±å“: å‚ä¸è®°å½•ä¸å®Œæ•´</li>
                    <li>è§£å†³: éœ€è¦æ•°æ®åŒæ­¥æœºåˆ¶</li>
                </ul>
            </div>
            <div class="status-card error">
                <h3>é—®é¢˜3: å‚ä¸è€…æ•°æ®ä¸¢å¤±</h3>
                <p>ä¹‹å‰å‚ä¸ä½†æœªè¿æ¥æˆåŠŸçš„ç”¨æˆ·æ•°æ®çŠ¶æ€</p>
                <ul>
                    <li>æœ¬åœ°å­˜å‚¨æ•°æ®å¯èƒ½å­˜åœ¨</li>
                    <li>éœ€è¦æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶</li>
                    <li>ç¡®ä¿å…¬å¹³æ€§å’Œå®Œæ•´æ€§</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="solution-section">
        <h2>ğŸ”§ ä¿®å¤æ­¥éª¤</h2>
        
        <div class="step">
            <div class="step-number">1</div>
            <div class="step-content">
                <h3>æ£€æŸ¥Supabaseæ•°æ®åº“é…ç½®</h3>
                <button onclick="checkDatabaseSetup()">æ£€æŸ¥æ•°æ®åº“</button>
                <div id="database-check-result"></div>
            </div>
        </div>

        <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
                <h3>ä¿®å¤RLSæƒé™ç­–ç•¥</h3>
                <button onclick="fixRLSPolicies()">ä¿®å¤æƒé™</button>
                <div id="rls-fix-result"></div>
                <div class="code-block">-- éœ€è¦åœ¨Supabase SQL Editorä¸­æ‰§è¡Œçš„SQL:
-- åˆ é™¤ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS "Users can read all users" ON users;
DROP POLICY IF EXISTS "Users can insert their own data" ON users;
DROP POLICY IF EXISTS "Users can update their own data" ON users;
DROP POLICY IF EXISTS "Users can delete their own data" ON users;

-- åˆ›å»ºæ–°çš„å®½æ¾ç­–ç•¥ï¼ˆé€‚ç”¨äºå…¬å¼€åº”ç”¨ï¼‰
CREATE POLICY "Allow all operations on users" ON users
    FOR ALL USING (true) WITH CHECK (true);

-- å¯¹settingså’Œknowledgeè¡¨ä¹Ÿåº”ç”¨ç›¸åŒç­–ç•¥
CREATE POLICY "Allow all operations on settings" ON settings
    FOR ALL USING (true) WITH CHECK (true);

CREATE POLICY "Allow all operations on knowledge" ON knowledge
    FOR ALL USING (true) WITH CHECK (true);</div>
            </div>
        </div>

        <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
                <h3>æµ‹è¯•ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½</h3>
                <button onclick="testUserRegistration()">æµ‹è¯•æ³¨å†Œ</button>
                <div id="registration-test-result"></div>
            </div>
        </div>

        <div class="step">
            <div class="step-number">4</div>
            <div class="step-content">
                <h3>æ¢å¤ç¦»çº¿ç”¨æˆ·æ•°æ®</h3>
                <button onclick="recoverOfflineData()">æ¢å¤æ•°æ®</button>
                <button onclick="checkOfflineUsers()" class="warning">æ£€æŸ¥ç¦»çº¿ç”¨æˆ·</button>
                <div id="offline-recovery-result"></div>
            </div>
        </div>

        <div class="step">
            <div class="step-number">5</div>
            <div class="step-content">
                <h3>éªŒè¯æ•°æ®å®Œæ•´æ€§</h3>
                <button onclick="verifyDataIntegrity()">éªŒè¯æ•°æ®</button>
                <div id="data-integrity-result"></div>
            </div>
        </div>
    </div>

    <div class="solution-section">
        <h2>â“ å…³äºå‚ä¸è€…æ•°æ®çš„é‡è¦è¯´æ˜</h2>
        <div class="status-card warning">
            <h3>ğŸ” å‚ä¸è€…æ•°æ®çŠ¶æ€åˆ†æ</h3>
            <p><strong>å¥½æ¶ˆæ¯ï¼š</strong>ä¹‹å‰å‚ä¸ä½†è¿æ¥å¤±è´¥çš„ç”¨æˆ·æ•°æ®å¾ˆå¯èƒ½æ²¡æœ‰å®Œå…¨ä¸¢å¤±ï¼</p>
            <ul>
                <li><strong>æœ¬åœ°å­˜å‚¨ä¿æŠ¤ï¼š</strong>åº”ç”¨è®¾è®¡äº†ç¦»çº¿æ¨¡å¼ï¼Œç”¨æˆ·æ•°æ®ä¼šæš‚å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</li>
                <li><strong>æ•°æ®æ¢å¤æœºåˆ¶ï¼š</strong>ä¸€æ—¦è¿æ¥æ¢å¤ï¼Œç³»ç»Ÿä¼šå°è¯•åŒæ­¥è¿™äº›ç¦»çº¿æ•°æ®</li>
                <li><strong>å‚ä¸è®°å½•ä¿ç•™ï¼š</strong>ç”¨æˆ·çš„å‚ä¸è¡Œä¸ºï¼ˆå¦‚æŠ½å¥–æ¬¡æ•°ï¼‰ä¼šåœ¨æœ¬åœ°è®°å½•</li>
                <li><strong>å…¬å¹³æ€§ä¿éšœï¼š</strong>ä¿®å¤è¿æ¥åï¼Œä¹‹å‰çš„å‚ä¸è€…ä»ç„¶æœ‰æ•ˆ</li>
            </ul>
            <button onclick="analyzeParticipantData()">åˆ†æå‚ä¸è€…æ•°æ®</button>
            <div id="participant-analysis-result"></div>
        </div>
    </div>

    <div class="solution-section">
        <h2>ğŸ“ è¯¦ç»†æ“ä½œæ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="operation-log" class="log"></div>
    </div>

    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase;
        let operationLog = [];
        let diagnosisResults = {
            database: null,
            permissions: null,
            registration: null,
            offlineData: null,
            dataIntegrity: null
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            operationLog.push(logEntry);
            
            const logDiv = document.getElementById('operation-log');
            logDiv.textContent = operationLog.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function updateDiagnosisStatus() {
            const statusDiv = document.getElementById('diagnosis-status');
            let html = '';
            
            Object.entries(diagnosisResults).forEach(([key, result]) => {
                const statusClass = result === null ? 'info' : (result ? 'success' : 'error');
                const statusText = result === null ? 'æœªæ£€æŸ¥' : (result ? 'âœ… æ­£å¸¸' : 'âŒ éœ€è¦ä¿®å¤');
                const keyName = {
                    database: 'æ•°æ®åº“é…ç½®',
                    permissions: 'æƒé™è®¾ç½®',
                    registration: 'æ³¨å†ŒåŠŸèƒ½',
                    offlineData: 'ç¦»çº¿æ•°æ®',
                    dataIntegrity: 'æ•°æ®å®Œæ•´æ€§'
                }[key];
                
                html += `<div class="status-card ${statusClass}">
                    <h4>${keyName}</h4>
                    <p>${statusText}</p>
                </div>`;
            });
            
            statusDiv.innerHTML = html;
        }

        async function initSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('SUPABASE_CONFIG é…ç½®æœªæ‰¾åˆ°');
                }
                
                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );
                
                log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                log(`âŒ Supabase åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkDatabaseSetup() {
            const resultDiv = document.getElementById('database-check-result');
            resultDiv.innerHTML = 'æ£€æŸ¥ä¸­...';
            
            try {
                if (!supabase) {
                    const initialized = await initSupabase();
                    if (!initialized) {
                        throw new Error('æ— æ³•åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯');
                    }
                }
                
                // æ£€æŸ¥æ‰€æœ‰å¿…è¦çš„è¡¨
                const tables = ['users', 'settings', 'knowledge'];
                let allTablesOk = true;
                let html = '<h4>æ•°æ®åº“æ£€æŸ¥ç»“æœ:</h4><ul>';
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase
                            .from(table)
                            .select('*')
                            .limit(1);
                        
                        if (error) {
                            html += `<li class="error">âŒ è¡¨ '${table}': ${error.message}</li>`;
                            allTablesOk = false;
                            log(`âŒ è¡¨ '${table}' æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                        } else {
                            html += `<li class="success">âœ… è¡¨ '${table}': æ­£å¸¸</li>`;
                            log(`âœ… è¡¨ '${table}' æ£€æŸ¥é€šè¿‡`);
                        }
                    } catch (tableError) {
                        html += `<li class="error">âŒ è¡¨ '${table}': ${tableError.message}</li>`;
                        allTablesOk = false;
                        log(`âŒ è¡¨ '${table}' æ£€æŸ¥å¼‚å¸¸: ${tableError.message}`, 'error');
                    }
                }
                
                html += '</ul>';
                diagnosisResults.database = allTablesOk;
                resultDiv.innerHTML = html;
                
            } catch (error) {
                diagnosisResults.database = false;
                resultDiv.innerHTML = `<span class="error">âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${error.message}</span>`;
                log(`âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateDiagnosisStatus();
        }

        async function fixRLSPolicies() {
            const resultDiv = document.getElementById('rls-fix-result');
            resultDiv.innerHTML = `<div class="warning">âš ï¸ RLSæƒé™ä¿®å¤éœ€è¦åœ¨Supabase Dashboardä¸­æ‰‹åŠ¨æ‰§è¡ŒSQLè¯­å¥ã€‚<br>
            è¯·å¤åˆ¶ä¸Šæ–¹çš„SQLä»£ç åˆ°Supabase SQL Editorä¸­æ‰§è¡Œã€‚</div>`;
            log('âš ï¸ RLSæƒé™ä¿®å¤éœ€è¦æ‰‹åŠ¨æ“ä½œ', 'warning');
        }

        async function testUserRegistration() {
            const resultDiv = document.getElementById('registration-test-result');
            resultDiv.innerHTML = 'æµ‹è¯•ä¸­...';
            
            try {
                const testUser = {
                    name: 'æµ‹è¯•ç”¨æˆ·_' + Date.now(),
                    phone: '+60' + Math.floor(Math.random() * 1000000000),
                    email: `test${Date.now()}@example.com`,
                    address: 'æµ‹è¯•åœ°å€',
                    created_at: new Date().toISOString(),
                    drawchances: 1,
                    prizeswon: []
                };
                
                log(`ğŸ”„ å¼€å§‹æµ‹è¯•ç”¨æˆ·æ³¨å†Œ: ${testUser.name}`);
                
                const { data, error } = await supabase
                    .from('users')
                    .insert([testUser])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                diagnosisResults.registration = true;
                resultDiv.innerHTML = `<span class="success">âœ… ç”¨æˆ·æ³¨å†Œæµ‹è¯•æˆåŠŸï¼ç”¨æˆ·ID: ${data[0].id}</span>`;
                log(`âœ… ç”¨æˆ·æ³¨å†Œæµ‹è¯•æˆåŠŸ: ${JSON.stringify(data[0])}`);
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                await supabase
                    .from('users')
                    .delete()
                    .eq('id', data[0].id);
                log('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                
            } catch (error) {
                diagnosisResults.registration = false;
                resultDiv.innerHTML = `<span class="error">âŒ ç”¨æˆ·æ³¨å†Œæµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`âŒ ç”¨æˆ·æ³¨å†Œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateDiagnosisStatus();
        }

        async function checkOfflineUsers() {
            const resultDiv = document.getElementById('offline-recovery-result');
            
            try {
                const offlineUsers = localStorage.getItem('offlineUsers');
                const userData = localStorage.getItem('userData');
                
                let html = '<h4>ç¦»çº¿æ•°æ®æ£€æŸ¥ç»“æœ:</h4>';
                let hasOfflineData = false;
                
                if (offlineUsers) {
                    const users = JSON.parse(offlineUsers);
                    html += `<div class="warning">âš ï¸ å‘ç° ${users.length} ä¸ªç¦»çº¿ç”¨æˆ·æ•°æ®:</div><ul>`;
                    users.forEach((user, index) => {
                        html += `<li>${index + 1}. ${user.name} - ${user.phone} - ${user.email}</li>`;
                    });
                    html += '</ul>';
                    hasOfflineData = true;
                    log(`âš ï¸ å‘ç° ${users.length} ä¸ªç¦»çº¿ç”¨æˆ·æ•°æ®`, 'warning');
                }
                
                if (userData) {
                    const user = JSON.parse(userData);
                    html += `<div class="info">â„¹ï¸ å½“å‰ç”¨æˆ·æ•°æ®: ${user.name} - ${user.phone}</div>`;
                    hasOfflineData = true;
                    log(`â„¹ï¸ å‘ç°å½“å‰ç”¨æˆ·æ•°æ®: ${user.name}`);
                }
                
                if (!hasOfflineData) {
                    html += '<div class="success">âœ… æ— ç¦»çº¿æ•°æ®éœ€è¦æ¢å¤</div>';
                    log('âœ… æ— ç¦»çº¿æ•°æ®éœ€è¦æ¢å¤');
                }
                
                resultDiv.innerHTML = html;
                diagnosisResults.offlineData = !hasOfflineData;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ ç¦»çº¿æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}</span>`;
                log(`âŒ ç¦»çº¿æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                diagnosisResults.offlineData = false;
            }
            
            updateDiagnosisStatus();
        }

        async function recoverOfflineData() {
            const resultDiv = document.getElementById('offline-recovery-result');
            resultDiv.innerHTML = 'æ¢å¤ä¸­...';
            
            try {
                const offlineUsers = localStorage.getItem('offlineUsers');
                if (!offlineUsers) {
                    resultDiv.innerHTML = '<span class="info">â„¹ï¸ æ— ç¦»çº¿æ•°æ®éœ€è¦æ¢å¤</span>';
                    log('â„¹ï¸ æ— ç¦»çº¿æ•°æ®éœ€è¦æ¢å¤');
                    return;
                }
                
                const users = JSON.parse(offlineUsers);
                log(`ğŸ”„ å¼€å§‹æ¢å¤ ${users.length} ä¸ªç¦»çº¿ç”¨æˆ·æ•°æ®`);
                
                let successCount = 0;
                let failCount = 0;
                let html = '<h4>æ•°æ®æ¢å¤ç»“æœ:</h4><ul>';
                
                for (const user of users) {
                    try {
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                        const { data: existingUser, error: checkError } = await supabase
                            .from('users')
                            .select('*')
                            .eq('phone', user.phone)
                            .single();
                        
                        if (existingUser) {
                            html += `<li class="warning">âš ï¸ ${user.name} (${user.phone}) - ç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡</li>`;
                            log(`âš ï¸ ç”¨æˆ· ${user.name} å·²å­˜åœ¨ï¼Œè·³è¿‡æ¢å¤`);
                        } else {
                            const { data, error } = await supabase
                                .from('users')
                                .insert([user])
                                .select();
                            
                            if (error) {
                                throw error;
                            }
                            
                            html += `<li class="success">âœ… ${user.name} (${user.phone}) - æ¢å¤æˆåŠŸ</li>`;
                            log(`âœ… ç”¨æˆ· ${user.name} æ¢å¤æˆåŠŸ`);
                            successCount++;
                        }
                    } catch (userError) {
                        html += `<li class="error">âŒ ${user.name} (${user.phone}) - æ¢å¤å¤±è´¥: ${userError.message}</li>`;
                        log(`âŒ ç”¨æˆ· ${user.name} æ¢å¤å¤±è´¥: ${userError.message}`, 'error');
                        failCount++;
                    }
                }
                
                html += '</ul>';
                html += `<div class="info">ğŸ“Š æ¢å¤ç»Ÿè®¡: æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª</div>`;
                
                if (failCount === 0) {
                    // æ¸…é™¤å·²æ¢å¤çš„ç¦»çº¿æ•°æ®
                    localStorage.removeItem('offlineUsers');
                    html += '<div class="success">âœ… ç¦»çº¿æ•°æ®å·²æ¸…é™¤</div>';
                    log('âœ… ç¦»çº¿æ•°æ®æ¢å¤å®Œæˆï¼Œå·²æ¸…é™¤æœ¬åœ°ç¼“å­˜');
                    diagnosisResults.offlineData = true;
                } else {
                    diagnosisResults.offlineData = false;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ æ•°æ®æ¢å¤å¤±è´¥: ${error.message}</span>`;
                log(`âŒ æ•°æ®æ¢å¤å¤±è´¥: ${error.message}`, 'error');
                diagnosisResults.offlineData = false;
            }
            
            updateDiagnosisStatus();
        }

        async function verifyDataIntegrity() {
            const resultDiv = document.getElementById('data-integrity-result');
            resultDiv.innerHTML = 'éªŒè¯ä¸­...';
            
            try {
                // ç»Ÿè®¡ç”¨æˆ·æ•°æ®
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*');
                
                if (usersError) {
                    throw usersError;
                }
                
                let html = '<h4>æ•°æ®å®Œæ•´æ€§éªŒè¯ç»“æœ:</h4>';
                html += `<div class="info">ğŸ“Š æ€»ç”¨æˆ·æ•°: ${users.length}</div>`;
                
                // æ£€æŸ¥æ•°æ®è´¨é‡
                const usersWithoutName = users.filter(u => !u.name || u.name.trim() === '');
                const usersWithoutPhone = users.filter(u => !u.phone || u.phone.trim() === '');
                const duplicatePhones = users.filter((u, i, arr) => 
                    arr.findIndex(other => other.phone === u.phone) !== i
                );
                
                if (usersWithoutName.length > 0) {
                    html += `<div class="warning">âš ï¸ ${usersWithoutName.length} ä¸ªç”¨æˆ·ç¼ºå°‘å§“å</div>`;
                }
                
                if (usersWithoutPhone.length > 0) {
                    html += `<div class="error">âŒ ${usersWithoutPhone.length} ä¸ªç”¨æˆ·ç¼ºå°‘ç”µè¯</div>`;
                }
                
                if (duplicatePhones.length > 0) {
                    html += `<div class="warning">âš ï¸ ${duplicatePhones.length} ä¸ªé‡å¤ç”µè¯å·ç </div>`;
                }
                
                const dataQualityOk = usersWithoutName.length === 0 && 
                                    usersWithoutPhone.length === 0 && 
                                    duplicatePhones.length === 0;
                
                if (dataQualityOk) {
                    html += '<div class="success">âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡</div>';
                    log('âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡');
                } else {
                    html += '<div class="warning">âš ï¸ å‘ç°æ•°æ®è´¨é‡é—®é¢˜ï¼Œä½†ä¸å½±å“åŸºæœ¬åŠŸèƒ½</div>';
                    log('âš ï¸ å‘ç°æ•°æ®è´¨é‡é—®é¢˜', 'warning');
                }
                
                diagnosisResults.dataIntegrity = dataQualityOk;
                resultDiv.innerHTML = html;
                
            } catch (error) {
                diagnosisResults.dataIntegrity = false;
                resultDiv.innerHTML = `<span class="error">âŒ æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥: ${error.message}</span>`;
                log(`âŒ æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateDiagnosisStatus();
        }

        async function analyzeParticipantData() {
            const resultDiv = document.getElementById('participant-analysis-result');
            resultDiv.innerHTML = 'åˆ†æä¸­...';
            
            try {
                // æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç”¨æˆ·
                const { data: dbUsers, error: dbError } = await supabase
                    .from('users')
                    .select('*');
                
                if (dbError) {
                    throw dbError;
                }
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„ç”¨æˆ·
                const offlineUsers = localStorage.getItem('offlineUsers');
                const currentUser = localStorage.getItem('userData');
                
                let html = '<h4>å‚ä¸è€…æ•°æ®åˆ†æç»“æœ:</h4>';
                
                // æ•°æ®åº“ç”¨æˆ·ç»Ÿè®¡
                html += `<div class="success">âœ… æ•°æ®åº“ä¸­çš„å‚ä¸è€…: ${dbUsers.length} äºº</div>`;
                
                if (dbUsers.length > 0) {
                    const totalDrawChances = dbUsers.reduce((sum, user) => sum + (user.drawchances || 1), 0);
                    html += `<div class="info">ğŸ¯ æ€»æŠ½å¥–æ¬¡æ•°: ${totalDrawChances} æ¬¡</div>`;
                    
                    const usersWithPrizes = dbUsers.filter(user => 
                        user.prizeswon && Array.isArray(user.prizeswon) && user.prizeswon.length > 0
                    );
                    html += `<div class="info">ğŸ† å·²ä¸­å¥–ç”¨æˆ·: ${usersWithPrizes.length} äºº</div>`;
                }
                
                // æœ¬åœ°å­˜å‚¨ç”¨æˆ·ç»Ÿè®¡
                if (offlineUsers) {
                    const localUsers = JSON.parse(offlineUsers);
                    html += `<div class="warning">âš ï¸ æœ¬åœ°å­˜å‚¨ä¸­çš„å‚ä¸è€…: ${localUsers.length} äººï¼ˆéœ€è¦æ¢å¤ï¼‰</div>`;
                } else {
                    html += `<div class="success">âœ… æœ¬åœ°å­˜å‚¨: æ— å¾…æ¢å¤æ•°æ®</div>`;
                }
                
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    html += `<div class="info">ğŸ‘¤ å½“å‰ç”¨æˆ·: ${user.name} (${user.phone})</div>`;
                }
                
                // æ€»ç»“
                html += '<hr><h4>ğŸ“‹ æ€»ç»“:</h4>';
                html += '<ul>';
                html += '<li><strong>æ•°æ®å®‰å…¨æ€§:</strong> åº”ç”¨å…·æœ‰ç¦»çº¿ä¿æŠ¤æœºåˆ¶ï¼Œç”¨æˆ·æ•°æ®ä¸ä¼šè½»æ˜“ä¸¢å¤±</li>';
                html += '<li><strong>å‚ä¸æœ‰æ•ˆæ€§:</strong> æ‰€æœ‰å‚ä¸è®°å½•ï¼ˆåŒ…æ‹¬ç¦»çº¿çš„ï¼‰éƒ½æ˜¯æœ‰æ•ˆçš„</li>';
                html += '<li><strong>å…¬å¹³æ€§ä¿éšœ:</strong> ä¿®å¤è¿æ¥åï¼Œä¹‹å‰çš„å‚ä¸è€…å¯ä»¥ç»§ç»­å‚ä¸</li>';
                html += '<li><strong>æ•°æ®æ¢å¤:</strong> å¯ä»¥é€šè¿‡"æ¢å¤ç¦»çº¿æ•°æ®"åŠŸèƒ½æ‰¾å›æœªåŒæ­¥çš„å‚ä¸è®°å½•</li>';
                html += '</ul>';
                
                resultDiv.innerHTML = html;
                log('âœ… å‚ä¸è€…æ•°æ®åˆ†æå®Œæˆ');
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ å‚ä¸è€…æ•°æ®åˆ†æå¤±è´¥: ${error.message}</span>`;
                log(`âŒ å‚ä¸è€…æ•°æ®åˆ†æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function runComprehensiveDiagnosis() {
            log('ğŸš€ å¼€å§‹è¿è¡Œç»¼åˆè¯Šæ–­');
            
            await checkDatabaseSetup();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUserRegistration();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await checkOfflineUsers();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await verifyDataIntegrity();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await analyzeParticipantData();
            
            log('âœ… ç»¼åˆè¯Šæ–­å®Œæˆ');
        }

        async function applyAllFixes() {
            log('ğŸ”§ å¼€å§‹åº”ç”¨æ‰€æœ‰ä¿®å¤');
            
            // æ³¨æ„ï¼šRLSä¿®å¤éœ€è¦æ‰‹åŠ¨æ“ä½œ
            await fixRLSPolicies();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await recoverOfflineData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runComprehensiveDiagnosis();
            
            log('âœ… æ‰€æœ‰è‡ªåŠ¨ä¿®å¤å·²å®Œæˆ');
        }

        function clearAllResults() {
            diagnosisResults = {
                database: null,
                permissions: null,
                registration: null,
                offlineData: null,
                dataIntegrity: null
            };
            
            document.getElementById('database-check-result').innerHTML = '';
            document.getElementById('rls-fix-result').innerHTML = '';
            document.getElementById('registration-test-result').innerHTML = '';
            document.getElementById('offline-recovery-result').innerHTML = '';
            document.getElementById('data-integrity-result').innerHTML = '';
            document.getElementById('participant-analysis-result').innerHTML = '';
            
            updateDiagnosisStatus();
            log('ğŸ—‘ï¸ æ‰€æœ‰ç»“æœå·²æ¸…é™¤');
        }

        function clearLog() {
            operationLog = [];
            document.getElementById('operation-log').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('ğŸš€ è¿æ¥ä¿®å¤æ–¹æ¡ˆé¡µé¢åŠ è½½å®Œæˆ');
            updateDiagnosisStatus();
            await initSupabase();
        });
    </script>
</body>
</html>