<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 连接错误修复测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-success { 
            color: rgb(22 163 74); /* text-green-600 */
            background-color: rgb(240 253 244); /* bg-green-50 */
            border-color: rgb(187 247 208); /* border-green-200 */
        }
        .status-error { 
            color: rgb(220 38 38); /* text-red-600 */
            background-color: rgb(254 242 242); /* bg-red-50 */
            border-color: rgb(254 202 202); /* border-red-200 */
        }
        .status-warning { 
            color: rgb(202 138 4); /* text-yellow-600 */
            background-color: rgb(254 252 232); /* bg-yellow-50 */
            border-color: rgb(254 240 138); /* border-yellow-200 */
        }
        .status-info { 
            color: rgb(37 99 235); /* text-blue-600 */ 
            background-color: rgb(239 246 255); /* bg-blue-50 */
            border-color: rgb(191 219 254); /* border-blue-200 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- 标题 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    🔧 Supabase 连接错误修复测试
                </h1>
                <p class="text-gray-600">
                    专门解决 net::ERR_ABORTED 错误的诊断和修复工具
                </p>
            </div>

            <!-- 控制面板 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🎛️ 控制面板</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="diagnose-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        🔍 开始诊断
                    </button>
                    <button id="fix-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        🔧 应用修复
                    </button>
                    <button id="test-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                        🧪 测试连接
                    </button>
                </div>
                <div class="mt-4">
                    <button id="auto-fix-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-colors w-full">
                        🚀 一键自动修复
                    </button>
                </div>
            </div>

            <!-- 状态显示 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">📊 当前状态</h2>
                <div id="status-display" class="space-y-2">
                    <div class="status-info border rounded-lg p-3">
                        ⏳ 等待开始诊断...
                    </div>
                </div>
            </div>

            <!-- 诊断结果 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🔍 诊断结果</h2>
                <div id="diagnostics-display" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">
                        暂无诊断结果
                    </div>
                </div>
            </div>

            <!-- 修复记录 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🔧 修复记录</h2>
                <div id="fixes-display" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">
                        暂无修复记录
                    </div>
                </div>
            </div>

            <!-- 测试结果 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">🧪 测试结果</h2>
                <div id="test-display" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">
                        暂无测试结果
                    </div>
                </div>
            </div>

            <!-- 详细日志 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">📝 详细日志</h2>
                <div id="log-display" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto">
                    <div class="text-gray-500">等待日志输出...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本引用 -->
    <script src="supabase-config.js"></script>
    <script src="supabase-connection.js"></script>
    <script src="supabase-connection-fix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // DOM 元素
        const diagnoseBtn = document.getElementById('diagnose-btn');
        const fixBtn = document.getElementById('fix-btn');
        const testBtn = document.getElementById('test-btn');
        const autoFixBtn = document.getElementById('auto-fix-btn');
        const statusDisplay = document.getElementById('status-display');
        const diagnosticsDisplay = document.getElementById('diagnostics-display');
        const fixesDisplay = document.getElementById('fixes-display');
        const testDisplay = document.getElementById('test-display');
        const logDisplay = document.getElementById('log-display');

        let fixer = null;

        // 日志函数
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            logDisplay.appendChild(logEntry);
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        // 更新状态显示
        function updateStatus(message, type = 'info') {
            statusDisplay.innerHTML = `
                <div class="status-${type} border rounded-lg p-3">
                    ${message}
                </div>
            `;
        }

        // 显示诊断结果
        function displayDiagnostics(diagnostics) {
            if (!diagnostics || diagnostics.length === 0) {
                diagnosticsDisplay.innerHTML = '<div class="text-gray-500 text-center py-4">暂无诊断结果</div>';
                return;
            }

            const html = diagnostics.map(d => `
                <div class="status-${d.type} border rounded-lg p-3">
                    <div class="font-semibold">${d.category.toUpperCase()}</div>
                    <div>${d.message}</div>
                </div>
            `).join('');

            diagnosticsDisplay.innerHTML = html;
        }

        // 显示修复记录
        function displayFixes(fixes) {
            if (!fixes || fixes.length === 0) {
                fixesDisplay.innerHTML = '<div class="text-gray-500 text-center py-4">暂无修复记录</div>';
                return;
            }

            const html = fixes.map(f => `
                <div class="status-${f.type} border rounded-lg p-3">
                    <div class="font-semibold">${f.category.toUpperCase()}</div>
                    <div>${f.message}</div>
                </div>
            `).join('');

            fixesDisplay.innerHTML = html;
        }

        // 显示测试结果
        function displayTestResult(result) {
            if (!result) {
                testDisplay.innerHTML = '<div class="text-gray-500 text-center py-4">暂无测试结果</div>';
                return;
            }

            const type = result.success ? 'success' : 'error';
            testDisplay.innerHTML = `
                <div class="status-${type} border rounded-lg p-3">
                    <div class="font-semibold">${result.success ? '✅ 测试成功' : '❌ 测试失败'}</div>
                    <div>${result.message}</div>
                    ${result.data ? `<div class="mt-2 text-sm">数据: ${JSON.stringify(result.data, null, 2)}</div>` : ''}
                </div>
            `;
        }

        // 诊断按钮
        diagnoseBtn.addEventListener('click', async () => {
            addLog('开始诊断连接问题...');
            updateStatus('🔍 正在诊断...', 'info');
            
            try {
                fixer = new SupabaseConnectionFix();
                const diagnostics = await fixer.diagnoseConnection();
                
                displayDiagnostics(diagnostics);
                addLog(`诊断完成，发现 ${diagnostics.filter(d => d.type === 'error').length} 个错误`);
                updateStatus('✅ 诊断完成', 'success');
            } catch (error) {
                addLog(`诊断失败: ${error.message}`, 'error');
                updateStatus('❌ 诊断失败', 'error');
            }
        });

        // 修复按钮
        fixBtn.addEventListener('click', async () => {
            if (!fixer) {
                addLog('请先运行诊断', 'warning');
                return;
            }

            addLog('开始应用修复...');
            updateStatus('🔧 正在修复...', 'info');
            
            try {
                const fixes = await fixer.applyFixes();
                displayFixes(fixes);
                addLog(`修复完成，应用了 ${fixes.length} 个修复`);
                updateStatus('✅ 修复完成', 'success');
            } catch (error) {
                addLog(`修复失败: ${error.message}`, 'error');
                updateStatus('❌ 修复失败', 'error');
            }
        });

        // 测试按钮
        testBtn.addEventListener('click', async () => {
            addLog('开始测试连接...');
            updateStatus('🧪 正在测试...', 'info');
            
            try {
                if (!fixer) {
                    fixer = new SupabaseConnectionFix();
                }
                
                const result = await fixer.testConnection();
                displayTestResult(result);
                addLog(`测试完成: ${result.success ? '成功' : '失败'}`);
                updateStatus(result.success ? '✅ 测试成功' : '❌ 测试失败', result.success ? 'success' : 'error');
            } catch (error) {
                addLog(`测试失败: ${error.message}`, 'error');
                updateStatus('❌ 测试失败', 'error');
            }
        });

        // 自动修复按钮
        autoFixBtn.addEventListener('click', async () => {
            addLog('开始自动修复流程...');
            updateStatus('🚀 正在自动修复...', 'info');
            
            try {
                const result = await autoFixSupabaseConnection();
                
                displayDiagnostics(result.report.diagnostics);
                displayFixes(result.report.fixes);
                displayTestResult(result.testResult);
                
                addLog(`自动修复完成: ${result.success ? '成功' : '失败'}`);
                updateStatus(result.success ? '✅ 自动修复成功' : '❌ 自动修复失败', result.success ? 'success' : 'error');
            } catch (error) {
                addLog(`自动修复失败: ${error.message}`, 'error');
                updateStatus('❌ 自动修复失败', 'error');
            }
        });

        // 页面加载完成后的初始化
        window.addEventListener('DOMContentLoaded', () => {
            addLog('页面加载完成，连接修复工具已就绪');
            updateStatus('⚡ 工具已就绪，点击按钮开始操作', 'info');
        });

        // 拦截控制台输出
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            addLog(args.join(' '), 'info');
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            addLog(args.join(' '), 'error');
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            addLog(args.join(' '), 'warning');
            originalConsoleWarn.apply(console, args);
        };
    </script>
</body>
</html>