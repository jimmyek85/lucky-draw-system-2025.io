<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è¿æ¥é”™è¯¯ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-success { 
            color: rgb(22 163 74); /* text-green-600 */
            background-color: rgb(240 253 244); /* bg-green-50 */
            border-color: rgb(187 247 208); /* border-green-200 */
        }
        .status-error { 
            color: rgb(220 38 38); /* text-red-600 */
            background-color: rgb(254 242 242); /* bg-red-50 */
            border-color: rgb(254 202 202); /* border-red-200 */
        }
        .status-warning { 
            color: rgb(202 138 4); /* text-yellow-600 */
            background-color: rgb(254 252 232); /* bg-yellow-50 */
            border-color: rgb(254 240 138); /* border-yellow-200 */
        }
        .status-info { 
            color: rgb(37 99 235); /* text-blue-600 */ 
            background-color: rgb(239 246 255); /* bg-blue-50 */
            border-color: rgb(191 219 254); /* border-blue-200 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- æ ‡é¢˜ -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    ğŸ”§ Supabase è¿æ¥é”™è¯¯ä¿®å¤æµ‹è¯•
                </h1>
                <p class="text-gray-600">
                    ä¸“é—¨è§£å†³ net::ERR_ABORTED é”™è¯¯çš„è¯Šæ–­å’Œä¿®å¤å·¥å…·
                </p>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ›ï¸ æ§åˆ¶é¢æ¿</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="diagnose-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ğŸ” å¼€å§‹è¯Šæ–­
                    </button>
                    <button id="fix-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ğŸ”§ åº”ç”¨ä¿®å¤
                    </button>
                    <button id="test-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ğŸ§ª æµ‹è¯•è¿æ¥
                    </button>
                </div>
                <div class="mt-4">
                    <button id="auto-fix-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-colors w-full">
                        ğŸš€ ä¸€é”®è‡ªåŠ¨ä¿®å¤
                    </button>
                </div>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“Š å½“å‰çŠ¶æ€</h2>
                <div id="status-display" class="space-y-2">
                    <div class="status-info border rounded-lg p-3">
                        â³ ç­‰å¾…å¼€å§‹è¯Šæ–­...
                    </div>
                </div>
            </div>

            <!-- è¯Šæ–­ç»“æœ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ” è¯Šæ–­ç»“æœ</h2>
                <div id="diagnostics-display" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">
                        æš‚æ— è¯Šæ–­ç»“æœ
                    </div>
                </div>
            </div>

            <!-- ä¿®å¤è®°å½• -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ”§ ä¿®å¤è®°å½•</h2>
                <div id="fixes-display" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">
                        æš‚æ— ä¿®å¤è®°å½•
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•ç»“æœ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ§ª æµ‹è¯•ç»“æœ</h2>
                <div id="test-display" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">
                        æš‚æ— æµ‹è¯•ç»“æœ
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†æ—¥å¿— -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
                <div id="log-display" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto">
                    <div class="text-gray-500">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬å¼•ç”¨ -->
    <script src="supabase-config.js"></script>
    <script src="supabase-connection.js"></script>
    <script src="supabase-connection-fix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // DOM å…ƒç´ 
        const diagnoseBtn = document.getElementById('diagnose-btn');
        const fixBtn = document.getElementById('fix-btn');
        const testBtn = document.getElementById('test-btn');
        const autoFixBtn = document.getElementById('auto-fix-btn');
        const statusDisplay = document.getElementById('status-display');
        const diagnosticsDisplay = document.getElementById('diagnostics-display');
        const fixesDisplay = document.getElementById('fixes-display');
        const testDisplay = document.getElementById('test-display');
        const logDisplay = document.getElementById('log-display');

        let fixer = null;

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            logDisplay.appendChild(logEntry);
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            statusDisplay.innerHTML = `
                <div class="status-${type} border rounded-lg p-3">
                    ${message}
                </div>
            `;
        }

        // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
        function displayDiagnostics(diagnostics) {
            if (!diagnostics || diagnostics.length === 0) {
                diagnosticsDisplay.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— è¯Šæ–­ç»“æœ</div>';
                return;
            }

            const html = diagnostics.map(d => `
                <div class="status-${d.type} border rounded-lg p-3">
                    <div class="font-semibold">${d.category.toUpperCase()}</div>
                    <div>${d.message}</div>
                </div>
            `).join('');

            diagnosticsDisplay.innerHTML = html;
        }

        // æ˜¾ç¤ºä¿®å¤è®°å½•
        function displayFixes(fixes) {
            if (!fixes || fixes.length === 0) {
                fixesDisplay.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— ä¿®å¤è®°å½•</div>';
                return;
            }

            const html = fixes.map(f => `
                <div class="status-${f.type} border rounded-lg p-3">
                    <div class="font-semibold">${f.category.toUpperCase()}</div>
                    <div>${f.message}</div>
                </div>
            `).join('');

            fixesDisplay.innerHTML = html;
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function displayTestResult(result) {
            if (!result) {
                testDisplay.innerHTML = '<div class="text-gray-500 text-center py-4">æš‚æ— æµ‹è¯•ç»“æœ</div>';
                return;
            }

            const type = result.success ? 'success' : 'error';
            testDisplay.innerHTML = `
                <div class="status-${type} border rounded-lg p-3">
                    <div class="font-semibold">${result.success ? 'âœ… æµ‹è¯•æˆåŠŸ' : 'âŒ æµ‹è¯•å¤±è´¥'}</div>
                    <div>${result.message}</div>
                    ${result.data ? `<div class="mt-2 text-sm">æ•°æ®: ${JSON.stringify(result.data, null, 2)}</div>` : ''}
                </div>
            `;
        }

        // è¯Šæ–­æŒ‰é’®
        diagnoseBtn.addEventListener('click', async () => {
            addLog('å¼€å§‹è¯Šæ–­è¿æ¥é—®é¢˜...');
            updateStatus('ğŸ” æ­£åœ¨è¯Šæ–­...', 'info');
            
            try {
                fixer = new SupabaseConnectionFix();
                const diagnostics = await fixer.diagnoseConnection();
                
                displayDiagnostics(diagnostics);
                addLog(`è¯Šæ–­å®Œæˆï¼Œå‘ç° ${diagnostics.filter(d => d.type === 'error').length} ä¸ªé”™è¯¯`);
                updateStatus('âœ… è¯Šæ–­å®Œæˆ', 'success');
            } catch (error) {
                addLog(`è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ è¯Šæ–­å¤±è´¥', 'error');
            }
        });

        // ä¿®å¤æŒ‰é’®
        fixBtn.addEventListener('click', async () => {
            if (!fixer) {
                addLog('è¯·å…ˆè¿è¡Œè¯Šæ–­', 'warning');
                return;
            }

            addLog('å¼€å§‹åº”ç”¨ä¿®å¤...');
            updateStatus('ğŸ”§ æ­£åœ¨ä¿®å¤...', 'info');
            
            try {
                const fixes = await fixer.applyFixes();
                displayFixes(fixes);
                addLog(`ä¿®å¤å®Œæˆï¼Œåº”ç”¨äº† ${fixes.length} ä¸ªä¿®å¤`);
                updateStatus('âœ… ä¿®å¤å®Œæˆ', 'success');
            } catch (error) {
                addLog(`ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ ä¿®å¤å¤±è´¥', 'error');
            }
        });

        // æµ‹è¯•æŒ‰é’®
        testBtn.addEventListener('click', async () => {
            addLog('å¼€å§‹æµ‹è¯•è¿æ¥...');
            updateStatus('ğŸ§ª æ­£åœ¨æµ‹è¯•...', 'info');
            
            try {
                if (!fixer) {
                    fixer = new SupabaseConnectionFix();
                }
                
                const result = await fixer.testConnection();
                displayTestResult(result);
                addLog(`æµ‹è¯•å®Œæˆ: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                updateStatus(result.success ? 'âœ… æµ‹è¯•æˆåŠŸ' : 'âŒ æµ‹è¯•å¤±è´¥', result.success ? 'success' : 'error');
            } catch (error) {
                addLog(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ æµ‹è¯•å¤±è´¥', 'error');
            }
        });

        // è‡ªåŠ¨ä¿®å¤æŒ‰é’®
        autoFixBtn.addEventListener('click', async () => {
            addLog('å¼€å§‹è‡ªåŠ¨ä¿®å¤æµç¨‹...');
            updateStatus('ğŸš€ æ­£åœ¨è‡ªåŠ¨ä¿®å¤...', 'info');
            
            try {
                const result = await autoFixSupabaseConnection();
                
                displayDiagnostics(result.report.diagnostics);
                displayFixes(result.report.fixes);
                displayTestResult(result.testResult);
                
                addLog(`è‡ªåŠ¨ä¿®å¤å®Œæˆ: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                updateStatus(result.success ? 'âœ… è‡ªåŠ¨ä¿®å¤æˆåŠŸ' : 'âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥', result.success ? 'success' : 'error');
            } catch (error) {
                addLog(`è‡ªåŠ¨ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ è‡ªåŠ¨ä¿®å¤å¤±è´¥', 'error');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œè¿æ¥ä¿®å¤å·¥å…·å·²å°±ç»ª');
            updateStatus('âš¡ å·¥å…·å·²å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æ“ä½œ', 'info');
        });

        // æ‹¦æˆªæ§åˆ¶å°è¾“å‡º
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            addLog(args.join(' '), 'info');
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            addLog(args.join(' '), 'error');
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            addLog(args.join(' '), 'warning');
            originalConsoleWarn.apply(console, args);
        };
    </script>
</body>
</html>