<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1602 å¹¸è¿è½®ç›˜ - ç³»ç»Ÿæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .test-section h2 {
            color: #555;
            margin-bottom: 15px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ 1602 å¹¸è¿è½®ç›˜ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“¡ è¿æ¥çŠ¶æ€æ£€æŸ¥</h2>
            <button class="test-button" onclick="testConnection()">æµ‹è¯• Supabase è¿æ¥</button>
            <button class="test-button" onclick="testConfiguration()">æ£€æŸ¥é…ç½®</button>
            <div id="connection-result" class="result"></div>
        </div>

        <div class="grid">
            <div class="test-section">
                <h2>ğŸ‘¥ ç”¨æˆ·ç³»ç»Ÿæµ‹è¯•</h2>
                <button class="test-button" onclick="testUserOperations()">æµ‹è¯•ç”¨æˆ·æ“ä½œ</button>
                <button class="test-button" onclick="getUserStats()">è·å–ç”¨æˆ·ç»Ÿè®¡</button>
                <div id="user-result" class="result"></div>
            </div>

            <div class="test-section">
                <h2>âš™ï¸ è®¾ç½®ç³»ç»Ÿæµ‹è¯•</h2>
                <button class="test-button" onclick="testSettingsOperations()">æµ‹è¯•è®¾ç½®æ“ä½œ</button>
                <button class="test-button" onclick="loadAllSettings()">åŠ è½½æ‰€æœ‰è®¾ç½®</button>
                <div id="settings-result" class="result"></div>
            </div>

            <div class="test-section">
                <h2>ğŸ“š çŸ¥è¯†åº“æµ‹è¯•</h2>
                <button class="test-button" onclick="testKnowledgeOperations()">æµ‹è¯•çŸ¥è¯†åº“æ“ä½œ</button>
                <button class="test-button" onclick="loadAllKnowledge()">åŠ è½½æ‰€æœ‰çŸ¥è¯†</button>
                <div id="knowledge-result" class="result"></div>
            </div>

            <div class="test-section">
                <h2>ğŸ² æŠ½å¥–ç³»ç»Ÿæµ‹è¯•</h2>
                <button class="test-button" onclick="testDrawOperations()">æµ‹è¯•æŠ½å¥–æ“ä½œ</button>
                <button class="test-button" onclick="getDrawStats()">è·å–æŠ½å¥–ç»Ÿè®¡</button>
                <div id="draw-result" class="result"></div>
            </div>

            <div class="test-section">
                <h2>ğŸ“¢ å…¬å‘Šç³»ç»Ÿæµ‹è¯•</h2>
                <button class="test-button" onclick="testAnnouncementOperations()">æµ‹è¯•å…¬å‘Šæ“ä½œ</button>
                <button class="test-button" onclick="loadAllAnnouncements()">åŠ è½½æ‰€æœ‰å…¬å‘Š</button>
                <div id="announcement-result" class="result"></div>
            </div>

            <div class="test-section">
                <h2>ğŸº äº§å“çŸ¥è¯†åº“æµ‹è¯•</h2>
                <button class="test-button" onclick="testProductKnowledgeOperations()">æµ‹è¯•äº§å“çŸ¥è¯†åº“</button>
                <button class="test-button" onclick="loadAllProducts()">åŠ è½½æ‰€æœ‰äº§å“</button>
                <div id="product-result" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ”„ å®æ—¶åŠŸèƒ½æµ‹è¯•</h2>
            <button class="test-button" onclick="testRealtimeSubscription()">æµ‹è¯•å®æ—¶è®¢é˜…</button>
            <button class="test-button" onclick="stopRealtimeSubscription()">åœæ­¢å®æ—¶è®¢é˜…</button>
            <div id="realtime-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š ç³»ç»Ÿå¥åº·æ£€æŸ¥</h2>
            <button class="test-button" onclick="runSystemHealthCheck()">è¿è¡Œå¥åº·æ£€æŸ¥</button>
            <button class="test-button" onclick="runFullSystemTest()">è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•</button>
            <div id="health-result" class="result"></div>
        </div>
    </div>

    <script>
        let supabase;
        let realtimeSubscription;

        // åˆå§‹åŒ– Supabase
        async function initializeSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase é…ç½®æœªæ‰¾åˆ°');
                }

                supabase = window.supabase.createClient(
                    window.SUPABASE_CONFIG.SUPABASE_URL,
                    window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                );

                return true;
            } catch (error) {
                console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            showResult('connection-result', 'æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
            
            try {
                const initialized = await initializeSupabase();
                if (!initialized) {
                    throw new Error('Supabase åˆå§‹åŒ–å¤±è´¥');
                }

                // æµ‹è¯•ç®€å•æŸ¥è¯¢
                const { data, error } = await supabase
                    .from('settings')
                    .select('count')
                    .limit(1);

                if (error) throw error;

                showResult('connection-result', 'âœ… Supabase è¿æ¥æˆåŠŸï¼\næ•°æ®åº“å“åº”æ­£å¸¸', 'success');
            } catch (error) {
                showResult('connection-result', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥é…ç½®
        async function testConfiguration() {
            showResult('connection-result', 'æ­£åœ¨æ£€æŸ¥é…ç½®...', 'info');
            
            try {
                const config = window.SUPABASE_CONFIG;
                let result = 'ğŸ“‹ é…ç½®æ£€æŸ¥ç»“æœ:\n\n';
                
                result += `URL: ${config.SUPABASE_URL}\n`;
                result += `URL æ ¼å¼: ${config.SUPABASE_URL.includes('.supabase.co') ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}\n`;
                result += `API Key: ${config.SUPABASE_ANON_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;
                result += `Key æ ¼å¼: ${config.SUPABASE_ANON_KEY.startsWith('eyJ') ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}\n`;
                result += `è¡¨é…ç½®: ${Object.keys(config.TABLES).length} ä¸ªè¡¨\n`;
                result += `å®æ—¶åŠŸèƒ½: ${config.REALTIME_CONFIG.ENABLED ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}\n`;

                showResult('connection-result', result, 'success');
            } catch (error) {
                showResult('connection-result', `âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·æ“ä½œ
        async function testUserOperations() {
            showResult('user-result', 'æ­£åœ¨æµ‹è¯•ç”¨æˆ·æ“ä½œ...', 'info');
            
            try {
                await initializeSupabase();
                
                // æµ‹è¯•æ’å…¥ç”¨æˆ·
                const testUser = {
                    name: 'æµ‹è¯•ç”¨æˆ·_' + Date.now(),
                    phone: '+60' + Date.now(),
                    email: 'test@example.com',
                    address: 'æµ‹è¯•åœ°å€'
                };

                const { data: insertData, error: insertError } = await supabase
                    .from('users')
                    .insert([testUser])
                    .select();

                if (insertError) throw insertError;

                // æµ‹è¯•æŸ¥è¯¢ç”¨æˆ·
                const { data: selectData, error: selectError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', testUser.phone);

                if (selectError) throw selectError;

                // æ¸…ç†æµ‹è¯•æ•°æ®
                await supabase
                    .from('users')
                    .delete()
                    .eq('phone', testUser.phone);

                showResult('user-result', `âœ… ç”¨æˆ·æ“ä½œæµ‹è¯•æˆåŠŸï¼\næ’å…¥ç”¨æˆ·: ${insertData[0].name}\næŸ¥è¯¢ç»“æœ: ${selectData.length} æ¡è®°å½•`, 'success');
            } catch (error) {
                showResult('user-result', `âŒ ç”¨æˆ·æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–ç”¨æˆ·ç»Ÿè®¡
        async function getUserStats() {
            showResult('user-result', 'æ­£åœ¨è·å–ç”¨æˆ·ç»Ÿè®¡...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('user_stats_view')
                    .select('*');

                if (error) throw error;

                const stats = data[0];
                let result = 'ğŸ“Š ç”¨æˆ·ç»Ÿè®¡:\n\n';
                result += `æ€»ç”¨æˆ·æ•°: ${stats.total_users}\n`;
                result += `æœ‰æŠ½å¥–æœºä¼šçš„ç”¨æˆ·: ${stats.users_with_chances}\n`;
                result += `å·²æŠ½å¥–ç”¨æˆ·: ${stats.users_who_drew}\n`;
                result += `æ€»æŠ½å¥–æ¬¡æ•°: ${stats.total_draws}\n`;
                result += `ä¸­å¥–ç”¨æˆ·æ•°: ${stats.winners_count}\n`;
                result += `ä»Šæ—¥æ³¨å†Œ: ${stats.today_registrations}\n`;
                result += `ä»Šæ—¥å‚ä¸: ${stats.today_participants}`;

                showResult('user-result', result, 'success');
            } catch (error) {
                showResult('user-result', `âŒ è·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è®¾ç½®æ“ä½œ
        async function testSettingsOperations() {
            showResult('settings-result', 'æ­£åœ¨æµ‹è¯•è®¾ç½®æ“ä½œ...', 'info');
            
            try {
                await initializeSupabase();
                
                // æµ‹è¯•è¯»å–è®¾ç½®
                const { data: readData, error: readError } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'app_name');

                if (readError) throw readError;

                // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°è®¾ç½®è®°å½•
                if (!readData || readData.length === 0) {
                    throw new Error('æœªæ‰¾åˆ° app_name è®¾ç½®é¡¹ï¼Œè¯·å…ˆæ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬');
                }

                // æ£€æŸ¥è®¾ç½®è®°å½•æ˜¯å¦æœ‰æ•ˆ
                if (!readData[0] || readData[0].content === undefined) {
                    throw new Error('app_name è®¾ç½®é¡¹æ•°æ®æ— æ•ˆï¼Œcontent å­—æ®µç¼ºå¤±');
                }

                const originalValue = readData[0].content;

                // æµ‹è¯•æ›´æ–°è®¾ç½®
                const testValue = 'æµ‹è¯•åº”ç”¨_' + Date.now();
                const { data: updateData, error: updateError } = await supabase
                    .from('settings')
                    .update({ content: testValue })
                    .eq('key', 'app_name')
                    .select();

                if (updateError) throw updateError;

                // æ£€æŸ¥æ›´æ–°ç»“æœ
                if (!updateData || updateData.length === 0 || !updateData[0]) {
                    throw new Error('è®¾ç½®æ›´æ–°å¤±è´¥ï¼Œæœªè¿”å›æœ‰æ•ˆæ•°æ®');
                }

                // æ¢å¤åŸå€¼
                const { error: restoreError } = await supabase
                    .from('settings')
                    .update({ content: originalValue })
                    .eq('key', 'app_name');

                if (restoreError) {
                    console.warn('æ¢å¤åŸå€¼æ—¶å‡ºç°è­¦å‘Š:', restoreError.message);
                }

                showResult('settings-result', `âœ… è®¾ç½®æ“ä½œæµ‹è¯•æˆåŠŸï¼\nåŸå€¼: ${originalValue}\næµ‹è¯•å€¼: ${updateData[0].content}\nå·²æ¢å¤åŸå€¼`, 'success');
            } catch (error) {
                showResult('settings-result', `âŒ è®¾ç½®æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰è®¾ç½®
        async function loadAllSettings() {
            showResult('settings-result', 'æ­£åœ¨åŠ è½½æ‰€æœ‰è®¾ç½®...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('settings')
                    .select('*')
                    .order('key');

                if (error) throw error;

                if (!data || data.length === 0) {
                    showResult('settings-result', 'âŒ æœªæ‰¾åˆ°ä»»ä½•è®¾ç½®é¡¹ï¼Œè¯·å…ˆæ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬', 'error');
                    return;
                }

                let result = `ğŸ“‹ è®¾ç½®åˆ—è¡¨ (${data.length} é¡¹):\n\n`;
                data.forEach(setting => {
                    const content = setting.content || '(ç©ºå€¼)';
                    const displayContent = content.length > 50 ? content.substring(0, 50) + '...' : content;
                    result += `${setting.key}: ${displayContent}\n`;
                });

                showResult('settings-result', result, 'success');
            } catch (error) {
                showResult('settings-result', `âŒ åŠ è½½è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•çŸ¥è¯†åº“æ“ä½œ
        async function testKnowledgeOperations() {
            showResult('knowledge-result', 'æ­£åœ¨æµ‹è¯•çŸ¥è¯†åº“æ“ä½œ...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('knowledge')
                    .select('*')
                    .limit(5);

                if (error) throw error;

                showResult('knowledge-result', `âœ… çŸ¥è¯†åº“æ“ä½œæµ‹è¯•æˆåŠŸï¼\næ‰¾åˆ° ${data.length} æ¡çŸ¥è¯†åº“è®°å½•`, 'success');
            } catch (error) {
                showResult('knowledge-result', `âŒ çŸ¥è¯†åº“æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰çŸ¥è¯†
        async function loadAllKnowledge() {
            showResult('knowledge-result', 'æ­£åœ¨åŠ è½½æ‰€æœ‰çŸ¥è¯†...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('knowledge')
                    .select('*')
                    .order('key');

                if (error) throw error;

                let result = `ğŸ“š çŸ¥è¯†åº“åˆ—è¡¨ (${data.length} é¡¹):\n\n`;
                data.forEach(item => {
                    result += `${item.key}: ${item.title || 'æ— æ ‡é¢˜'}\n`;
                });

                showResult('knowledge-result', result, 'success');
            } catch (error) {
                showResult('knowledge-result', `âŒ åŠ è½½çŸ¥è¯†åº“å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æŠ½å¥–æ“ä½œ
        async function testDrawOperations() {
            showResult('draw-result', 'æ­£åœ¨æµ‹è¯•æŠ½å¥–æ“ä½œ...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('draw_history')
                    .select('*')
                    .limit(5)
                    .order('draw_date', { ascending: false });

                if (error) throw error;

                showResult('draw-result', `âœ… æŠ½å¥–æ“ä½œæµ‹è¯•æˆåŠŸï¼\næœ€è¿‘ ${data.length} æ¡æŠ½å¥–è®°å½•å·²åŠ è½½`, 'success');
            } catch (error) {
                showResult('draw-result', `âŒ æŠ½å¥–æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–æŠ½å¥–ç»Ÿè®¡
        async function getDrawStats() {
            showResult('draw-result', 'æ­£åœ¨è·å–æŠ½å¥–ç»Ÿè®¡...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('draw_stats_view')
                    .select('*');

                if (error) throw error;

                const stats = data[0];
                let result = 'ğŸ² æŠ½å¥–ç»Ÿè®¡:\n\n';
                result += `æ€»æŠ½å¥–æ¬¡æ•°: ${stats.total_draws}\n`;
                result += `ä»Šæ—¥æŠ½å¥–: ${stats.today_draws}\n`;
                result += `å‚ä¸ç”¨æˆ·: ${stats.unique_participants}\n`;
                result += `æ€»ä¸­å¥–æ¬¡æ•°: ${stats.total_wins}\n`;
                result += `ä»Šæ—¥ä¸­å¥–: ${stats.today_wins}`;

                showResult('draw-result', result, 'success');
            } catch (error) {
                showResult('draw-result', `âŒ è·å–æŠ½å¥–ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å…¬å‘Šæ“ä½œ
        async function testAnnouncementOperations() {
            showResult('announcement-result', 'æ­£åœ¨æµ‹è¯•å…¬å‘Šæ“ä½œ...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('is_active', true)
                    .order('priority', { ascending: false });

                if (error) throw error;

                showResult('announcement-result', `âœ… å…¬å‘Šæ“ä½œæµ‹è¯•æˆåŠŸï¼\næ‰¾åˆ° ${data.length} æ¡æ´»è·ƒå…¬å‘Š`, 'success');
            } catch (error) {
                showResult('announcement-result', `âŒ å…¬å‘Šæ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰å…¬å‘Š
        async function loadAllAnnouncements() {
            showResult('announcement-result', 'æ­£åœ¨åŠ è½½æ‰€æœ‰å…¬å‘Š...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let result = `ğŸ“¢ å…¬å‘Šåˆ—è¡¨ (${data.length} é¡¹):\n\n`;
                data.forEach(item => {
                    result += `${item.title} (${item.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'})\n`;
                });

                showResult('announcement-result', result, 'success');
            } catch (error) {
                showResult('announcement-result', `âŒ åŠ è½½å…¬å‘Šå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•äº§å“çŸ¥è¯†åº“æ“ä½œ
        async function testProductKnowledgeOperations() {
            showResult('product-result', 'æ­£åœ¨æµ‹è¯•äº§å“çŸ¥è¯†åº“æ“ä½œ...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('product_knowledge')
                    .select('*')
                    .eq('is_active', true);

                if (error) throw error;

                showResult('product-result', `âœ… äº§å“çŸ¥è¯†åº“æ“ä½œæµ‹è¯•æˆåŠŸï¼\næ‰¾åˆ° ${data.length} æ¡äº§å“è®°å½•`, 'success');
            } catch (error) {
                showResult('product-result', `âŒ äº§å“çŸ¥è¯†åº“æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰äº§å“
        async function loadAllProducts() {
            showResult('product-result', 'æ­£åœ¨åŠ è½½æ‰€æœ‰äº§å“...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .from('product_knowledge')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let result = `ğŸº äº§å“åˆ—è¡¨ (${data.length} é¡¹):\n\n`;
                data.forEach(item => {
                    result += `${item.title} - ${item.category} (${item.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'})\n`;
                });

                showResult('product-result', result, 'success');
            } catch (error) {
                showResult('product-result', `âŒ åŠ è½½äº§å“å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å®æ—¶è®¢é˜…
        async function testRealtimeSubscription() {
            showResult('realtime-result', 'æ­£åœ¨æµ‹è¯•å®æ—¶è®¢é˜…...', 'info');
            
            try {
                await initializeSupabase();
                
                realtimeSubscription = supabase
                    .channel('test-channel')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'users' },
                        (payload) => {
                            showResult('realtime-result', `ğŸ”„ å®æ—¶æ›´æ–°æ£€æµ‹åˆ°:\näº‹ä»¶: ${payload.eventType}\nè¡¨: ${payload.table}\næ—¶é—´: ${new Date().toLocaleString()}`, 'info');
                        }
                    )
                    .subscribe();

                showResult('realtime-result', 'âœ… å®æ—¶è®¢é˜…å·²å¯åŠ¨ï¼\nç›‘å¬ç”¨æˆ·è¡¨çš„å˜åŒ–...', 'success');
            } catch (error) {
                showResult('realtime-result', `âŒ å®æ—¶è®¢é˜…å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åœæ­¢å®æ—¶è®¢é˜…
        async function stopRealtimeSubscription() {
            if (realtimeSubscription) {
                await supabase.removeChannel(realtimeSubscription);
                realtimeSubscription = null;
                showResult('realtime-result', 'â¹ï¸ å®æ—¶è®¢é˜…å·²åœæ­¢', 'info');
            } else {
                showResult('realtime-result', 'âš ï¸ æ²¡æœ‰æ´»è·ƒçš„å®æ—¶è®¢é˜…', 'info');
            }
        }

        // è¿è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥
        async function runSystemHealthCheck() {
            showResult('health-result', 'æ­£åœ¨è¿è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥...', 'info');
            
            try {
                await initializeSupabase();
                
                const { data, error } = await supabase
                    .rpc('system_health_check');

                if (error) throw error;

                let result = 'ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥ç»“æœ:\n\n';
                
                // æ£€æŸ¥ data æ˜¯å¦ä¸ºæ•°ç»„
                if (!data) {
                    throw new Error('ç³»ç»Ÿå¥åº·æ£€æŸ¥å‡½æ•°è¿”å›ç©ºæ•°æ®');
                }
                
                if (!Array.isArray(data)) {
                    throw new Error(`ç³»ç»Ÿå¥åº·æ£€æŸ¥å‡½æ•°è¿”å›çš„æ•°æ®æ ¼å¼é”™è¯¯ï¼ŒæœŸæœ›æ•°ç»„ä½†å¾—åˆ°: ${typeof data}`);
                }
                
                if (data.length === 0) {
                    result += 'âš ï¸ æ²¡æœ‰æ£€æŸ¥é¡¹ç›®è¿”å›\n';
                } else {
                    data.forEach(check => {
                        // ç¡®ä¿ check å¯¹è±¡å­˜åœ¨å¿…è¦çš„å±æ€§
                        if (!check || typeof check !== 'object') {
                            result += 'âŒ æ£€æŸ¥é¡¹æ ¼å¼é”™è¯¯\n';
                            return;
                        }
                        
                        const checkName = check.check_name || 'æœªçŸ¥æ£€æŸ¥é¡¹';
                        const status = check.status || 'UNKNOWN';
                        const details = check.details || 'æ— è¯¦ç»†ä¿¡æ¯';
                        
                        const statusIcon = status === 'OK' ? 'âœ…' : 
                                         status === 'WARNING' ? 'âš ï¸' : 
                                         status === 'ACTIVE' ? 'ğŸŸ¢' : 
                                         status === 'INFO' ? 'â„¹ï¸' :
                                         status === 'QUIET' ? 'ğŸ˜´' : 'ğŸ“Š';
                        result += `${statusIcon} ${checkName}: ${status}\n   ${details}\n\n`;
                    });
                }

                showResult('health-result', result, 'success');
            } catch (error) {
                console.error('ç³»ç»Ÿå¥åº·æ£€æŸ¥è¯¦ç»†é”™è¯¯:', error);
                showResult('health-result', `âŒ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•
        async function runFullSystemTest() {
            showResult('health-result', 'æ­£åœ¨è¿è¡Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•...', 'info');
            
            try {
                let result = 'ğŸ” å®Œæ•´ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š:\n\n';
                
                // æµ‹è¯•è¿æ¥
                await initializeSupabase();
                result += 'âœ… Supabase è¿æ¥: æ­£å¸¸\n';
                
                // æµ‹è¯•å„ä¸ªè¡¨
                const tables = ['users', 'settings', 'knowledge', 'draw_history', 'announcements', 'product_knowledge'];
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase
                            .from(table)
                            .select('count')
                            .limit(1);
                        
                        if (error) throw error;
                        result += `âœ… ${table} è¡¨: å¯è®¿é—®\n`;
                    } catch (error) {
                        result += `âŒ ${table} è¡¨: ${error.message}\n`;
                    }
                }
                
                // æµ‹è¯•è§†å›¾
                try {
                    const { data, error } = await supabase
                        .from('user_stats_view')
                        .select('*');
                    
                    if (error) throw error;
                    result += 'âœ… ç”¨æˆ·ç»Ÿè®¡è§†å›¾: æ­£å¸¸\n';
                } catch (error) {
                    result += `âŒ ç”¨æˆ·ç»Ÿè®¡è§†å›¾: ${error.message}\n`;
                }
                
                try {
                    const { data, error } = await supabase
                        .from('draw_stats_view')
                        .select('*');
                    
                    if (error) throw error;
                    result += 'âœ… æŠ½å¥–ç»Ÿè®¡è§†å›¾: æ­£å¸¸\n';
                } catch (error) {
                    result += `âŒ æŠ½å¥–ç»Ÿè®¡è§†å›¾: ${error.message}\n`;
                }
                
                // æµ‹è¯•å‡½æ•°
                try {
                    const { data, error } = await supabase
                        .rpc('system_health_check');
                    
                    if (error) throw error;
                    result += 'âœ… ç³»ç»Ÿå‡½æ•°: æ­£å¸¸\n';
                } catch (error) {
                    result += `âŒ ç³»ç»Ÿå‡½æ•°: ${error.message}\n`;
                }
                
                result += '\nğŸ‰ å®Œæ•´ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼';
                showResult('health-result', result, 'success');
            } catch (error) {
                showResult('health-result', `âŒ å®Œæ•´ç³»ç»Ÿæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>