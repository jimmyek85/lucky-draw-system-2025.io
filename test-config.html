<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .warning {
            border-left-color: #ff9800;
        }
        .result {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>🔍 抽奖配置测试页面</h1>
    
    <div class="test-section">
        <h2>1. 配置文件检查</h2>
        <button onclick="testConfigFile()">测试 config.js</button>
        <div id="config-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. 新用户注册测试</h2>
        <button onclick="testNewUserRegistration()">模拟新用户注册</button>
        <div id="registration-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. 抽奖配置获取测试</h2>
        <button onclick="testLotteryConfig()">测试抽奖配置获取</button>
        <div id="lottery-config-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. 数据库连接测试</h2>
        <button onclick="testDatabaseConnection()">测试数据库连接</button>
        <div id="db-result" class="result"></div>
    </div>

    <script src="config.js"></script>
    <script>
        // 测试配置文件
        function testConfigFile() {
            const result = document.getElementById('config-result');
            try {
                if (typeof LOTTERY_CONFIG !== 'undefined') {
                    result.innerHTML = `
                        <strong>✅ config.js 加载成功</strong><br>
                        INITIAL_CHANCES: ${LOTTERY_CONFIG.INITIAL_CHANCES}<br>
                        SPIN_AGAIN_BONUS: ${LOTTERY_CONFIG.SPIN_AGAIN_BONUS}<br>
                        MAX_ACCUMULATED_CHANCES: ${LOTTERY_CONFIG.MAX_ACCUMULATED_CHANCES}<br>
                        DAILY_FREE_CHANCES: ${LOTTERY_CONFIG.DAILY_FREE_CHANCES}<br>
                        <br>
                        ${LOTTERY_CONFIG.INITIAL_CHANCES === 1 ? 
                          '<span style="color: #4CAF50;">✅ 新用户初始机会正确设置为 1</span>' : 
                          '<span style="color: #f44336;">❌ 新用户初始机会应该为 1，当前为 ' + LOTTERY_CONFIG.INITIAL_CHANCES + '</span>'}
                    `;
                } else {
                    result.innerHTML = '<span style="color: #f44336;">❌ LOTTERY_CONFIG 未定义</span>';
                }
            } catch (error) {
                result.innerHTML = `<span style="color: #f44336;">❌ 错误: ${error.message}</span>`;
            }
        }

        // 测试新用户注册逻辑
        function testNewUserRegistration() {
            const result = document.getElementById('registration-result');
            try {
                // 模拟新用户数据
                const mockUser = {
                    name: '测试用户',
                    phone: '13800138000',
                    isNewUser: true
                };

                // 模拟获取抽奖配置
                const lotteryConfig = LOTTERY_CONFIG || {
                    INITIAL_CHANCES: 3,
                    SPIN_AGAIN_BONUS: 1,
                    MAX_ACCUMULATED_CHANCES: 10
                };

                const initialChances = lotteryConfig.INITIAL_CHANCES || 3;
                
                result.innerHTML = `
                    <strong>📝 新用户注册模拟</strong><br>
                    用户名: ${mockUser.name}<br>
                    手机号: ${mockUser.phone}<br>
                    初始抽奖机会: ${initialChances}<br>
                    <br>
                    ${initialChances === 1 ? 
                      '<span style="color: #4CAF50;">✅ 新用户只获得 1 次免费抽奖机会</span>' : 
                      '<span style="color: #f44336;">❌ 新用户获得了 ' + initialChances + ' 次机会，应该只有 1 次</span>'}
                `;
            } catch (error) {
                result.innerHTML = `<span style="color: #f44336;">❌ 错误: ${error.message}</span>`;
            }
        }

        // 测试抽奖配置获取
        function testLotteryConfig() {
            const result = document.getElementById('lottery-config-result');
            
            // 模拟 getLotteryConfig 函数的逻辑
            function mockGetLotteryConfig() {
                try {
                    // 模拟离线模式
                    const offlineConfig = {
                        INITIAL_CHANCES: LOTTERY_CONFIG?.INITIAL_CHANCES || 1,
                        SPIN_AGAIN_BONUS: LOTTERY_CONFIG?.SPIN_AGAIN_BONUS || 1,
                        MAX_ACCUMULATED_CHANCES: LOTTERY_CONFIG?.MAX_ACCUMULATED_CHANCES || 10,
                        DAILY_FREE_CHANCES: LOTTERY_CONFIG?.DAILY_FREE_CHANCES || 1,
                        ENABLE_DAILY_FREE: LOTTERY_CONFIG?.ENABLE_DAILY_FREE || false,
                        ALLOW_ADMIN_ADD_CHANCES: LOTTERY_CONFIG?.ALLOW_ADMIN_ADD_CHANCES || true
                    };
                    return offlineConfig;
                } catch (error) {
                    // 异常情况下的默认配置
                    return {
                        INITIAL_CHANCES: 1,
                        SPIN_AGAIN_BONUS: 1,
                        MAX_ACCUMULATED_CHANCES: 10,
                        DAILY_FREE_CHANCES: 1,
                        ENABLE_DAILY_FREE: false,
                        ALLOW_ADMIN_ADD_CHANCES: true
                    };
                }
            }

            const config = mockGetLotteryConfig();
            
            result.innerHTML = `
                <strong>⚙️ 抽奖配置获取测试</strong><br>
                INITIAL_CHANCES: ${config.INITIAL_CHANCES}<br>
                SPIN_AGAIN_BONUS: ${config.SPIN_AGAIN_BONUS}<br>
                MAX_ACCUMULATED_CHANCES: ${config.MAX_ACCUMULATED_CHANCES}<br>
                DAILY_FREE_CHANCES: ${config.DAILY_FREE_CHANCES}<br>
                <br>
                ${config.INITIAL_CHANCES === 1 ? 
                  '<span style="color: #4CAF50;">✅ 配置正确：新用户初始机会为 1</span>' : 
                  '<span style="color: #f44336;">❌ 配置错误：新用户初始机会为 ' + config.INITIAL_CHANCES + '，应该为 1</span>'}
            `;
        }

        // 测试数据库连接
        function testDatabaseConnection() {
            const result = document.getElementById('db-result');
            
            if (typeof window.SUPABASE_CONFIG !== 'undefined') {
                const config = window.SUPABASE_CONFIG;
                const isConfigured = config.SUPABASE_URL !== 'https://your-project-id.supabase.co' && 
                                   config.SUPABASE_ANON_KEY !== 'your-supabase-anon-key-here';
                
                result.innerHTML = `
                    <strong>🔗 数据库配置检查</strong><br>
                    Supabase URL: ${config.SUPABASE_URL}<br>
                    API Key: ${config.SUPABASE_ANON_KEY ? '已配置' : '未配置'}<br>
                    <br>
                    ${isConfigured ? 
                      '<span style="color: #4CAF50;">✅ Supabase 配置已设置</span>' : 
                      '<span style="color: #f44336;">❌ Supabase 配置未正确设置</span>'}
                    <br><br>
                    <em>注意：实际连接测试需要在有网络的环境中进行</em>
                `;
            } else {
                result.innerHTML = '<span style="color: #f44336;">❌ SUPABASE_CONFIG 未找到</span>';
            }
        }

        // 页面加载时自动运行所有测试
        window.onload = function() {
            setTimeout(() => {
                testConfigFile();
                testNewUserRegistration();
                testLotteryConfig();
                testDatabaseConnection();
            }, 500);
        };
    </script>
</body>
</html>