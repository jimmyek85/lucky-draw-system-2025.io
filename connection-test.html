<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è¿æ¥æµ‹è¯• - 1602 Lucky Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-loading { 
            background-color: #6b7280; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .test-card {
            transition: all 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ”— Supabase è¿æ¥æµ‹è¯•</h1>
                <p class="text-gray-600">éªŒè¯ 1602 Lucky Draw ç³»ç»Ÿä¸ Supabase äº‘æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€</p>
            </div>

            <!-- Overall Status -->
            <div id="overall-status" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span id="overall-indicator" class="status-indicator status-loading"></span>
                        <h2 class="text-xl font-semibold text-gray-800">ç³»ç»ŸçŠ¶æ€</h2>
                    </div>
                    <button id="refresh-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                        ğŸ”„ åˆ·æ–°æµ‹è¯•
                    </button>
                </div>
                <p id="overall-message" class="text-gray-600 mt-2">æ­£åœ¨æ£€æµ‹è¿æ¥çŠ¶æ€...</p>
            </div>

            <!-- Test Results Grid -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Configuration Test -->
                <div class="test-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span id="config-indicator" class="status-indicator status-loading"></span>
                        <h3 class="text-lg font-semibold text-gray-800">é…ç½®æ£€æŸ¥</h3>
                    </div>
                    <div id="config-details" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Supabase URL:</span>
                            <span id="config-url" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>API Key:</span>
                            <span id="config-key" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>è¡¨é…ç½®:</span>
                            <span id="config-tables" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Connection Test -->
                <div class="test-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span id="connection-indicator" class="status-indicator status-loading"></span>
                        <h3 class="text-lg font-semibold text-gray-800">è¿æ¥æµ‹è¯•</h3>
                    </div>
                    <div id="connection-details" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>ç½‘ç»œè¿æ¥:</span>
                            <span id="network-status" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ•°æ®åº“è¿æ¥:</span>
                            <span id="db-status" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å“åº”æ—¶é—´:</span>
                            <span id="response-time" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Database Tables Test -->
                <div class="test-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span id="tables-indicator" class="status-indicator status-loading"></span>
                        <h3 class="text-lg font-semibold text-gray-800">æ•°æ®è¡¨æ£€æŸ¥</h3>
                    </div>
                    <div id="tables-details" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>users è¡¨:</span>
                            <span id="users-table-status" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>settings è¡¨:</span>
                            <span id="settings-table-status" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>knowledge è¡¨:</span>
                            <span id="knowledge-table-status" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Data Consistency Test -->
                <div class="test-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span id="data-indicator" class="status-indicator status-loading"></span>
                        <h3 class="text-lg font-semibold text-gray-800">æ•°æ®ä¸€è‡´æ€§</h3>
                    </div>
                    <div id="data-details" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>ç”¨æˆ·æ•°æ®:</span>
                            <span id="user-data-count" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>è®¾ç½®åŒæ­¥:</span>
                            <span id="settings-sync" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div class="flex justify-between">
                            <span>çŸ¥è¯†åº“:</span>
                            <span id="knowledge-sync" class="text-gray-600">æ£€æµ‹ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Log -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ è¯¦ç»†æ—¥å¿—</h3>
                <div id="test-log" class="bg-gray-50 rounded-md p-4 h-64 overflow-y-auto text-sm font-mono">
                    <div class="text-gray-600">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex flex-wrap gap-4 justify-center">
                <button id="test-insert-btn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition">
                    ğŸ§ª æµ‹è¯•æ•°æ®æ’å…¥
                </button>
                <button id="test-realtime-btn" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 transition">
                    âš¡ æµ‹è¯•å®æ—¶åŒæ­¥
                </button>
                <button id="clear-log-btn" class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition">
                    ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                </button>
                <a href="index.html" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition inline-block">
                    ğŸ¯ è¿”å›æŠ½å¥–é¡µé¢
                </a>
                <a href="admin.html" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition inline-block">
                    âš™ï¸ ç®¡ç†åå°
                </a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-connection.js"></script>
    <script src="verify-connections.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        class ConnectionTester {
            constructor() {
                this.connectionManager = null;
                this.testResults = {};
                this.logContainer = document.getElementById('test-log');
                this.startTime = null;
                
                this.init();
            }

            async init() {
                this.log('ğŸš€ åˆå§‹åŒ–è¿æ¥æµ‹è¯•å™¨...');
                
                // ç»‘å®šäº‹ä»¶
                document.getElementById('refresh-btn').addEventListener('click', () => this.runAllTests());
                document.getElementById('test-insert-btn').addEventListener('click', () => this.testDataInsert());
                document.getElementById('test-realtime-btn').addEventListener('click', () => this.testRealtime());
                document.getElementById('clear-log-btn').addEventListener('click', () => this.clearLog());
                
                // å¼€å§‹æµ‹è¯•
                await this.runAllTests();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `mb-1 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
                console.log(message);
            }

            clearLog() {
                this.logContainer.innerHTML = '<div class="text-gray-600">æ—¥å¿—å·²æ¸…ç©º</div>';
            }

            updateStatus(elementId, status, message = '') {
                const indicator = document.getElementById(`${elementId}-indicator`);
                const statusClasses = ['status-loading', 'status-success', 'status-error', 'status-warning'];
                
                indicator.classList.remove(...statusClasses);
                indicator.classList.add(`status-${status}`);
                
                if (message) {
                    const messageElement = document.getElementById(`${elementId}-message`);
                    if (messageElement) {
                        messageElement.textContent = message;
                    }
                }
            }

            async runAllTests() {
                this.startTime = Date.now();
                this.log('ğŸ”„ å¼€å§‹å…¨é¢è¿æ¥æµ‹è¯•...');
                
                // é‡ç½®çŠ¶æ€
                this.updateStatus('overall', 'loading');
                this.updateStatus('config', 'loading');
                this.updateStatus('connection', 'loading');
                this.updateStatus('tables', 'loading');
                this.updateStatus('data', 'loading');

                try {
                    // 1. é…ç½®æ£€æŸ¥
                    await this.testConfiguration();
                    
                    // 2. è¿æ¥æµ‹è¯•
                    await this.testConnection();
                    
                    // 3. æ•°æ®è¡¨æ£€æŸ¥
                    await this.testTables();
                    
                    // 4. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
                    await this.testDataConsistency();
                    
                    // æ›´æ–°æ€»ä½“çŠ¶æ€
                    this.updateOverallStatus();
                    
                } catch (error) {
                    this.log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                    this.updateStatus('overall', 'error', 'æµ‹è¯•å¤±è´¥');
                }
            }

            async testConfiguration() {
                this.log('ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶...');
                
                try {
                    // æ£€æŸ¥ Supabase é…ç½®
                    const config = window.SUPABASE_CONFIG;
                    if (!config) {
                        throw new Error('SUPABASE_CONFIG æœªæ‰¾åˆ°');
                    }

                    // æ›´æ–°é…ç½®æ˜¾ç¤º
                    document.getElementById('config-url').textContent = 
                        config.SUPABASE_URL ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®';
                    document.getElementById('config-key').textContent = 
                        config.SUPABASE_ANON_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®';
                    document.getElementById('config-tables').textContent = 
                        config.TABLES ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®';

                    if (window.isSupabaseConfigured && window.isSupabaseConfigured()) {
                        this.updateStatus('config', 'success');
                        this.log('âœ… é…ç½®æ£€æŸ¥é€šè¿‡');
                        this.testResults.config = true;
                    } else {
                        this.updateStatus('config', 'error');
                        this.log('âŒ é…ç½®æ£€æŸ¥å¤±è´¥', 'error');
                        this.testResults.config = false;
                    }
                } catch (error) {
                    this.updateStatus('config', 'error');
                    this.log(`âŒ é…ç½®æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
                    this.testResults.config = false;
                }
            }

            async testConnection() {
                this.log('ğŸ”— æµ‹è¯• Supabase è¿æ¥...');
                
                try {
                    const startTime = Date.now();
                    
                    // åˆå§‹åŒ–è¿æ¥ç®¡ç†å™¨
                    this.connectionManager = new SupabaseConnectionManager();
                    const connected = await this.connectionManager.initialize();
                    
                    const responseTime = Date.now() - startTime;
                    
                    if (connected) {
                        document.getElementById('network-status').textContent = 'âœ… æ­£å¸¸';
                        document.getElementById('db-status').textContent = 'âœ… å·²è¿æ¥';
                        document.getElementById('response-time').textContent = `${responseTime}ms`;
                        
                        this.updateStatus('connection', 'success');
                        this.log(`âœ… è¿æ¥æˆåŠŸ (${responseTime}ms)`);
                        this.testResults.connection = true;
                    } else {
                        throw new Error('è¿æ¥å¤±è´¥');
                    }
                } catch (error) {
                    document.getElementById('network-status').textContent = 'âŒ å¼‚å¸¸';
                    document.getElementById('db-status').textContent = 'âŒ æ–­å¼€';
                    document.getElementById('response-time').textContent = 'è¶…æ—¶';
                    
                    this.updateStatus('connection', 'error');
                    this.log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    this.testResults.connection = false;
                }
            }

            async testTables() {
                this.log('ğŸ“Š æ£€æŸ¥æ•°æ®è¡¨ç»“æ„...');
                
                if (!this.connectionManager || !this.connectionManager.isConnected) {
                    this.updateStatus('tables', 'error');
                    this.log('âŒ æ— æ³•æ£€æŸ¥æ•°æ®è¡¨ï¼šè¿æ¥æœªå»ºç«‹', 'error');
                    return;
                }

                try {
                    const tables = ['users', 'settings', 'knowledge'];
                    const tableResults = {};
                    
                    for (const table of tables) {
                        try {
                            await this.connectionManager.safeQuery(table, { limit: 1 });
                            tableResults[table] = true;
                            document.getElementById(`${table}-table-status`).textContent = 'âœ… æ­£å¸¸';
                            this.log(`âœ… ${table} è¡¨æ£€æŸ¥é€šè¿‡`);
                        } catch (error) {
                            tableResults[table] = false;
                            document.getElementById(`${table}-table-status`).textContent = 'âŒ å¼‚å¸¸';
                            this.log(`âŒ ${table} è¡¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                        }
                    }
                    
                    const allTablesOk = Object.values(tableResults).every(result => result);
                    this.updateStatus('tables', allTablesOk ? 'success' : 'warning');
                    this.testResults.tables = allTablesOk;
                    
                } catch (error) {
                    this.updateStatus('tables', 'error');
                    this.log(`âŒ æ•°æ®è¡¨æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
                    this.testResults.tables = false;
                }
            }

            async testDataConsistency() {
                this.log('ğŸ”„ æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§...');
                
                if (!this.connectionManager || !this.connectionManager.isConnected) {
                    this.updateStatus('data', 'error');
                    this.log('âŒ æ— æ³•æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼šè¿æ¥æœªå»ºç«‹', 'error');
                    return;
                }

                try {
                    // æ£€æŸ¥ç”¨æˆ·æ•°æ®
                    const users = await this.connectionManager.safeQuery('users');
                    document.getElementById('user-data-count').textContent = `${users.length} æ¡è®°å½•`;
                    
                    // æ£€æŸ¥è®¾ç½®æ•°æ®
                    const settings = await this.connectionManager.safeQuery('settings');
                    document.getElementById('settings-sync').textContent = settings.length > 0 ? 'âœ… å·²åŒæ­¥' : 'âš ï¸ æ— æ•°æ®';
                    
                    // æ£€æŸ¥çŸ¥è¯†åº“æ•°æ®
                    const knowledge = await this.connectionManager.safeQuery('knowledge');
                    document.getElementById('knowledge-sync').textContent = knowledge.length > 0 ? 'âœ… å·²åŒæ­¥' : 'âš ï¸ æ— æ•°æ®';
                    
                    this.updateStatus('data', 'success');
                    this.log('âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ');
                    this.testResults.data = true;
                    
                } catch (error) {
                    this.updateStatus('data', 'error');
                    this.log(`âŒ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                    this.testResults.data = false;
                }
            }

            async testDataInsert() {
                this.log('ğŸ§ª æµ‹è¯•æ•°æ®æ’å…¥åŠŸèƒ½...');
                
                if (!this.connectionManager || !this.connectionManager.isConnected) {
                    this.log('âŒ æ— æ³•æµ‹è¯•æ’å…¥ï¼šè¿æ¥æœªå»ºç«‹', 'error');
                    return;
                }

                try {
                    const testUser = {
                        name: `æµ‹è¯•ç”¨æˆ·_${Date.now()}`,
                        phone: `+86${Math.floor(Math.random() * 10000000000)}`,
                        email: `test_${Date.now()}@example.com`,
                        chances: 1,
                        created_at: new Date().toISOString()
                    };
                    
                    const result = await this.connectionManager.safeInsert('users', testUser);
                    
                    if (result && result.length > 0) {
                        this.log(`âœ… æµ‹è¯•æ•°æ®æ’å…¥æˆåŠŸï¼ŒID: ${result[0].id}`);
                        
                        // æ¸…ç†æµ‹è¯•æ•°æ®
                        await this.connectionManager.supabase
                            .from('users')
                            .delete()
                            .eq('id', result[0].id);
                        
                        this.log('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                    }
                } catch (error) {
                    this.log(`âŒ æ•°æ®æ’å…¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async testRealtime() {
                this.log('âš¡ æµ‹è¯•å®æ—¶åŒæ­¥åŠŸèƒ½...');
                
                if (!this.connectionManager || !this.connectionManager.isConnected) {
                    this.log('âŒ æ— æ³•æµ‹è¯•å®æ—¶åŒæ­¥ï¼šè¿æ¥æœªå»ºç«‹', 'error');
                    return;
                }

                try {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶åŒæ­¥æµ‹è¯•é€»è¾‘
                    this.log('â„¹ï¸ å®æ—¶åŒæ­¥æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...');
                } catch (error) {
                    this.log(`âŒ å®æ—¶åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            updateOverallStatus() {
                const totalTests = Object.keys(this.testResults).length;
                const passedTests = Object.values(this.testResults).filter(result => result).length;
                const totalTime = Date.now() - this.startTime;
                
                if (passedTests === totalTests) {
                    this.updateStatus('overall', 'success', `æ‰€æœ‰æµ‹è¯•é€šè¿‡ (${totalTime}ms)`);
                    this.log(`ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼é€šè¿‡ç‡: ${passedTests}/${totalTests} (${totalTime}ms)`, 'success');
                } else if (passedTests > 0) {
                    this.updateStatus('overall', 'warning', `éƒ¨åˆ†æµ‹è¯•é€šè¿‡ (${passedTests}/${totalTests})`);
                    this.log(`âš ï¸ éƒ¨åˆ†æµ‹è¯•é€šè¿‡: ${passedTests}/${totalTests}`, 'warning');
                } else {
                    this.updateStatus('overall', 'error', 'æ‰€æœ‰æµ‹è¯•å¤±è´¥');
                    this.log('âŒ æ‰€æœ‰æµ‹è¯•å¤±è´¥', 'error');
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            new ConnectionTester();
        });

        // ç›‘å¬ç»Ÿä¸€éªŒè¯å®Œæˆäº‹ä»¶
        window.addEventListener('connectionVerified', function(event) {
            const report = event.detail;
            console.log('ğŸ“Š æ”¶åˆ°ç»Ÿä¸€éªŒè¯æŠ¥å‘Š:', report);
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            if (report.summary.successRate === '100.0%') {
                updateStatus('âœ… æ‰€æœ‰è¿æ¥éªŒè¯é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸', 'success');
            } else {
                updateStatus(`âš ï¸ éªŒè¯å®Œæˆï¼ŒæˆåŠŸç‡: ${report.summary.successRate}`, 'warning');
            }
            
            // æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
            const reportDiv = document.getElementById('test-results');
            if (reportDiv) {
                reportDiv.innerHTML += `
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">ğŸ“Š ç»Ÿä¸€éªŒè¯æŠ¥å‘Š</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>æ€»æ£€æŸ¥é¡¹: ${report.summary.total}</div>
                            <div>æˆåŠŸç‡: ${report.summary.successRate}</div>
                            <div class="text-green-600">é€šè¿‡: ${report.summary.passed}</div>
                            <div class="text-red-600">å¤±è´¥: ${report.summary.failed}</div>
                        </div>
                        ${report.recommendations.length > 0 ? `
                            <div class="mt-4">
                                <h4 class="font-semibold mb-2">ğŸ’¡ å»ºè®®:</h4>
                                <ul class="list-disc list-inside space-y-1">
                                    ${report.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        });
    </script>
</body>
</html>