<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ æŠ½å¥–è½®ç›˜ç³»ç»Ÿ - ç®¡ç†å‘˜é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .admin-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- åŠ è½½ Supabase é…ç½® - ç¡®ä¿ä¸ç”¨æˆ·ç«¯ç»Ÿä¸€ -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <div class="container mx-auto px-4 py-8">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-blue-400">ğŸ¯ æŠ½å¥–è½®ç›˜ç³»ç»Ÿ</h1>
                <p class="text-gray-300 mt-2">ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ - Supabase äº‘æœåŠ¡å™¨</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <span id="connection-indicator" class="status-indicator status-offline"></span>
                    <span id="connection-status" class="text-sm">è¿æ¥ä¸­...</span>
                </div>
                <button onclick="window.open('index.html', '_blank')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    ğŸ® ç”¨æˆ·ç«¯
                </button>
                <button onclick="window.open('supabase-connection-validator.html', '_blank')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    ğŸ”§ è¿æ¥éªŒè¯å™¨
                </button>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">æ€»ç”¨æˆ·æ•°</p>
                        <p id="total-users" class="text-2xl font-bold text-blue-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ‘¥</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">ä»Šæ—¥æ³¨å†Œ</p>
                        <p id="today-registrations" class="text-2xl font-bold text-green-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ“ˆ</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">æŠ½å¥–æ¬¡æ•°</p>
                        <p id="total-draws" class="text-2xl font-bold text-yellow-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ²</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">ç³»ç»ŸçŠ¶æ€</p>
                        <p id="system-status" class="text-2xl font-bold text-green-400">æ­£å¸¸</p>
                    </div>
                    <div class="text-3xl">âš¡</div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ç”¨æˆ·ç®¡ç† -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-400">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h3>
                    <button onclick="refreshUserData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
                <div class="data-table">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="text-left p-2">å§“å</th>
                                <th class="text-left p-2">ç”µè¯</th>
                                <th class="text-left p-2">æ³¨å†Œæ—¶é—´</th>
                                <th class="text-left p-2">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="users-table" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="4" class="text-center p-4 text-gray-400">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŠ½å¥–è®¾ç½® -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-green-400 mb-4">ğŸ® æŠ½å¥–è®¾ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">å¥–å“é…ç½®</label>
                        <textarea id="prizes-config" rows="6" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="è¾“å…¥å¥–å“é…ç½® JSON..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="updatePrizes()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1">
                            ğŸ’¾ ä¿å­˜è®¾ç½®
                        </button>
                        <button onclick="resetPrizes()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            ğŸ”„ é‡ç½®
                        </button>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶ç›‘æ§ -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">ğŸ“Š å®æ—¶ç›‘æ§</h3>
                <div id="realtime-logs" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto text-sm">
                    <div class="text-gray-400">ç­‰å¾…å®æ—¶æ•°æ®...</div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="clearLogs()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                    </button>
                    <button onclick="exportLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ“¥ å¯¼å‡ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- æ•°æ®åˆ†æ -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-purple-400 mb-4">ğŸ“ˆ æ•°æ®åˆ†æ</h3>
                <div class="space-y-4">
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-blue-300 mb-2">ç”¨æˆ·æ³¨å†Œè¶‹åŠ¿</h4>
                        <div id="registration-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            å›¾è¡¨åŠ è½½ä¸­...
                        </div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-green-300 mb-2">æŠ½å¥–æ´»è·ƒåº¦</h4>
                        <div id="activity-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            å›¾è¡¨åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿå·¥å…· -->
        <div class="mt-8 admin-card bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold text-red-400 mb-4">ğŸ”§ ç³»ç»Ÿå·¥å…·</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="backupDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded text-center">
                    ğŸ’¾ æ•°æ®å¤‡ä»½
                </button>
                <button onclick="clearCache()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded text-center">
                    ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜
                </button>
                <button onclick="systemDiagnostic()" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded text-center">
                    ğŸ” ç³»ç»Ÿè¯Šæ–­
                </button>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let realtimeChannel = null;
        const logs = [];

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ - ä½¿ç”¨ä¸ç”¨æˆ·ç«¯ç›¸åŒçš„é…ç½®
        async function initializeSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase é…ç½®æœªæ‰¾åˆ°');
                }

                const config = window.SUPABASE_CONFIG;
                
                // éªŒè¯é…ç½®
                if (!config.SUPABASE_URL || config.SUPABASE_URL === 'https://your-project-id.supabase.co') {
                    throw new Error('Supabase URL æœªæ­£ç¡®é…ç½®');
                }
                
                if (!config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === 'your-supabase-anon-key-here') {
                    throw new Error('Supabase API Key æœªæ­£ç¡®é…ç½®');
                }

                // åˆå§‹åŒ–å®¢æˆ·ç«¯
                supabase = window.supabase.createClient(
                    config.SUPABASE_URL,
                    config.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: false
                        },
                        realtime: {
                            params: {
                                eventsPerSecond: 10
                            }
                        }
                    }
                );

                updateConnectionStatus('online', 'å·²è¿æ¥åˆ° Supabase äº‘æœåŠ¡å™¨');
                addLog('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è®¾ç½®å®æ—¶ç›‘å¬
                setupRealtimeSubscription();
                
                // åŠ è½½åˆå§‹æ•°æ®
                await loadDashboardData();
                
                return true;
            } catch (error) {
                updateConnectionStatus('offline', `è¿æ¥å¤±è´¥: ${error.message}`);
                addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connection-indicator');
            const statusText = document.getElementById('connection-status');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = message;
        }

        // è®¾ç½®å®æ—¶è®¢é˜…
        function setupRealtimeSubscription() {
            if (!supabase) return;

            try {
                realtimeChannel = supabase
                    .channel('admin-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'users' },
                        (payload) => {
                            addLog(`ğŸ‘¥ ç”¨æˆ·æ•°æ®æ›´æ–°: ${payload.eventType}`, 'info');
                            refreshUserData();
                        }
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'settings' },
                        (payload) => {
                            addLog(`âš™ï¸ è®¾ç½®æ›´æ–°: ${payload.eventType}`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            addLog('ğŸ“¡ å®æ—¶ç›‘å¬å·²å¯åŠ¨', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            addLog('âŒ å®æ—¶ç›‘å¬è¿æ¥å¤±è´¥', 'error');
                        }
                    });
            } catch (error) {
                addLog(`âŒ å®æ—¶è®¢é˜…è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
                await loadUserStats();
                
                // åŠ è½½ç”¨æˆ·åˆ—è¡¨
                await refreshUserData();
                
                // åŠ è½½å¥–å“é…ç½®
                await loadPrizesConfig();
                
                addLog('ğŸ“Š ä»ªè¡¨æ¿æ•°æ®åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                addLog(`âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
        async function loadUserStats() {
            try {
                const { count: totalUsers, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (usersError) throw usersError;

                document.getElementById('total-users').textContent = totalUsers || 0;

                // ä»Šæ—¥æ³¨å†Œæ•°
                const today = new Date().toISOString().split('T')[0];
                const { count: todayCount, error: todayError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);

                if (!todayError) {
                    document.getElementById('today-registrations').textContent = todayCount || 0;
                }

                // æŠ½å¥–æ¬¡æ•°ç»Ÿè®¡ï¼ˆä»ç”¨æˆ·è¡¨çš„ draw_count å­—æ®µï¼‰
                const { data: drawData, error: drawError } = await supabase
                    .from('users')
                    .select('draw_count');

                if (!drawError && drawData) {
                    const totalDraws = drawData.reduce((sum, user) => sum + (user.draw_count || 0), 0);
                    document.getElementById('total-draws').textContent = totalDraws;
                }

            } catch (error) {
                addLog(`âŒ ç”¨æˆ·ç»Ÿè®¡åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ·æ–°ç”¨æˆ·æ•°æ®
        async function refreshUserData() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const tbody = document.getElementById('users-table');
                tbody.innerHTML = '';

                if (users && users.length > 0) {
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-700';
                        row.innerHTML = `
                            <td class="p-2">${user.name || '-'}</td>
                            <td class="p-2">${user.phone || '-'}</td>
                            <td class="p-2">${new Date(user.created_at).toLocaleString()}</td>
                            <td class="p-2">
                                <span class="px-2 py-1 rounded text-xs ${user.is_active ? 'bg-green-600' : 'bg-gray-600'}">
                                    ${user.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                }

                addLog(`ğŸ“Š ç”¨æˆ·æ•°æ®å·²åˆ·æ–°ï¼Œå…± ${users.length} æ¡è®°å½•`, 'info');
            } catch (error) {
                addLog(`âŒ ç”¨æˆ·æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½å¥–å“é…ç½®
        async function loadPrizesConfig() {
            try {
                const { data: settings, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'prizes_config')
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                const textarea = document.getElementById('prizes-config');
                if (settings && settings.value) {
                    textarea.value = JSON.stringify(settings.value, null, 2);
                } else {
                    // é»˜è®¤å¥–å“é…ç½®
                    const defaultPrizes = {
                        prizes: [
                            { name: "ä¸€ç­‰å¥–", probability: 0.05, color: "#ff6b6b" },
                            { name: "äºŒç­‰å¥–", probability: 0.15, color: "#4ecdc4" },
                            { name: "ä¸‰ç­‰å¥–", probability: 0.30, color: "#45b7d1" },
                            { name: "è°¢è°¢å‚ä¸", probability: 0.50, color: "#96ceb4" }
                        ]
                    };
                    textarea.value = JSON.stringify(defaultPrizes, null, 2);
                }
            } catch (error) {
                addLog(`âŒ å¥–å“é…ç½®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°å¥–å“é…ç½®
        async function updatePrizes() {
            try {
                const textarea = document.getElementById('prizes-config');
                const config = JSON.parse(textarea.value);

                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'prizes_config',
                        value: config,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('âœ… å¥–å“é…ç½®å·²ä¿å­˜', 'success');
                alert('å¥–å“é…ç½®ä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                addLog(`âŒ å¥–å“é…ç½®ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        // é‡ç½®å¥–å“é…ç½®
        function resetPrizes() {
            if (confirm('ç¡®å®šè¦é‡ç½®å¥–å“é…ç½®å—ï¼Ÿ')) {
                loadPrizesConfig();
                addLog('ğŸ”„ å¥–å“é…ç½®å·²é‡ç½®', 'info');
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logs.push(logEntry);

            const logsContainer = document.getElementById('realtime-logs');
            const logElement = document.createElement('div');
            logElement.className = `mb-1 ${type === 'success' ? 'text-green-400' : 
                                           type === 'error' ? 'text-red-400' : 
                                           type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // ä¿æŒæœ€å¤š100æ¡æ—¥å¿—
            if (logs.length > 100) {
                logs.shift();
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logs.length = 0;
            document.getElementById('realtime-logs').innerHTML = '<div class="text-gray-400">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logText = logs.map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ•°æ®å¤‡ä»½
        async function backupDatabase() {
            try {
                addLog('ğŸ’¾ å¼€å§‹æ•°æ®å¤‡ä»½...', 'info');
                
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*');

                const { data: settings, error: settingsError } = await supabase
                    .from('settings')
                    .select('*');

                if (usersError || settingsError) {
                    throw new Error('æ•°æ®è¯»å–å¤±è´¥');
                }

                const backup = {
                    timestamp: new Date().toISOString(),
                    users: users || [],
                    settings: settings || []
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `database-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                addLog('âœ… æ•°æ®å¤‡ä»½å®Œæˆ', 'success');
            } catch (error) {
                addLog(`âŒ æ•°æ®å¤‡ä»½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç†ç¼“å­˜
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç†ç³»ç»Ÿç¼“å­˜å—ï¼Ÿ')) {
                localStorage.clear();
                sessionStorage.clear();
                addLog('ğŸ—‘ï¸ ç³»ç»Ÿç¼“å­˜å·²æ¸…ç†', 'info');
                alert('ç¼“å­˜æ¸…ç†å®Œæˆï¼');
            }
        }

        // ç³»ç»Ÿè¯Šæ–­
        async function systemDiagnostic() {
            addLog('ğŸ” å¼€å§‹ç³»ç»Ÿè¯Šæ–­...', 'info');
            
            try {
                // æ£€æŸ¥æ•°æ®åº“è¿æ¥
                const { error: dbError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (dbError) {
                    addLog('âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸', 'error');
                } else {
                    addLog('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
                }

                // æ£€æŸ¥å®æ—¶è¿æ¥
                if (realtimeChannel && realtimeChannel.state === 'joined') {
                    addLog('âœ… å®æ—¶è¿æ¥æ­£å¸¸', 'success');
                } else {
                    addLog('âš ï¸ å®æ—¶è¿æ¥å¼‚å¸¸', 'warning');
                }

                // æ£€æŸ¥é…ç½®
                if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.SUPABASE_URL) {
                    addLog('âœ… é…ç½®æ–‡ä»¶æ­£å¸¸', 'success');
                } else {
                    addLog('âŒ é…ç½®æ–‡ä»¶å¼‚å¸¸', 'error');
                }

                addLog('ğŸ” ç³»ç»Ÿè¯Šæ–­å®Œæˆ', 'info');
            } catch (error) {
                addLog(`âŒ ç³»ç»Ÿè¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async function() {
            addLog('ğŸš€ ç®¡ç†å‘˜é¢æ¿å¯åŠ¨ä¸­...', 'info');
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬å·²åŠ è½½
            setTimeout(async () => {
                const success = await initializeSupabase();
                if (success) {
                    addLog('âœ… ç®¡ç†å‘˜é¢æ¿åˆå§‹åŒ–å®Œæˆ', 'success');
                } else {
                    addLog('âŒ ç®¡ç†å‘˜é¢æ¿åˆå§‹åŒ–å¤±è´¥', 'error');
                }
            }, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            if (realtimeChannel && supabase) {
                supabase.removeChannel(realtimeChannel);
            }
        });

        // å®šæœŸåˆ·æ–°æ•°æ®
        setInterval(async () => {
            if (supabase) {
                await loadUserStats();
            }
        }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>