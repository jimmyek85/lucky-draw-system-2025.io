<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 抽奖轮盘系统 - 管理员面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .admin-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- 加载 Supabase 配置 - 确保与用户端统一 -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <div class="container mx-auto px-4 py-8">
        <!-- 顶部导航 -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-blue-400">🎯 抽奖轮盘系统</h1>
                <p class="text-gray-300 mt-2">管理员控制面板 - Supabase 云服务器</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <span id="connection-indicator" class="status-indicator status-offline"></span>
                    <span id="connection-status" class="text-sm">连接中...</span>
                </div>
                <button onclick="window.open('index.html', '_blank')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    🎮 用户端
                </button>
                <button onclick="window.open('supabase-connection-validator.html', '_blank')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    🔧 连接验证器
                </button>
            </div>
        </div>

        <!-- 系统状态概览 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">总用户数</p>
                        <p id="total-users" class="text-2xl font-bold text-blue-400">-</p>
                    </div>
                    <div class="text-3xl">👥</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">今日注册</p>
                        <p id="today-registrations" class="text-2xl font-bold text-green-400">-</p>
                    </div>
                    <div class="text-3xl">📈</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">抽奖次数</p>
                        <p id="total-draws" class="text-2xl font-bold text-yellow-400">-</p>
                    </div>
                    <div class="text-3xl">🎲</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">系统状态</p>
                        <p id="system-status" class="text-2xl font-bold text-green-400">正常</p>
                    </div>
                    <div class="text-3xl">⚡</div>
                </div>
            </div>
        </div>

        <!-- 主要功能区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 用户管理 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-400">👥 用户管理</h3>
                    <button onclick="refreshUserData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        🔄 刷新
                    </button>
                </div>
                <div class="data-table">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="text-left p-2">姓名</th>
                                <th class="text-left p-2">电话</th>
                                <th class="text-left p-2">注册时间</th>
                                <th class="text-left p-2">状态</th>
                            </tr>
                        </thead>
                        <tbody id="users-table" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="4" class="text-center p-4 text-gray-400">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 抽奖设置 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-green-400 mb-4">🎮 抽奖设置</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">奖品配置</label>
                        <textarea id="prizes-config" rows="6" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" placeholder="输入奖品配置 JSON..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="updatePrizes()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1">
                            💾 保存设置
                        </button>
                        <button onclick="resetPrizes()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            🔄 重置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 实时监控 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">📊 实时监控</h3>
                <div id="realtime-logs" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto text-sm">
                    <div class="text-gray-400">等待实时数据...</div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="clearLogs()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        🗑️ 清空日志
                    </button>
                    <button onclick="exportLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        📥 导出日志
                    </button>
                </div>
            </div>

            <!-- 数据分析 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-purple-400 mb-4">📈 数据分析</h3>
                <div class="space-y-4">
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-blue-300 mb-2">用户注册趋势</h4>
                        <div id="registration-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            图表加载中...
                        </div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-green-300 mb-2">抽奖活跃度</h4>
                        <div id="activity-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            图表加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统工具 -->
        <div class="mt-8 admin-card bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold text-red-400 mb-4">🔧 系统工具</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="backupDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded text-center">
                    💾 数据备份
                </button>
                <button onclick="clearCache()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded text-center">
                    🗑️ 清理缓存
                </button>
                <button onclick="systemDiagnostic()" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded text-center">
                    🔍 系统诊断
                </button>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let realtimeChannel = null;
        const logs = [];

        // 初始化 Supabase 客户端 - 使用与用户端相同的配置
        async function initializeSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase 配置未找到');
                }

                const config = window.SUPABASE_CONFIG;
                
                // 验证配置
                if (!config.SUPABASE_URL || config.SUPABASE_URL === 'https://your-project-id.supabase.co') {
                    throw new Error('Supabase URL 未正确配置');
                }
                
                if (!config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === 'your-supabase-anon-key-here') {
                    throw new Error('Supabase API Key 未正确配置');
                }

                // 初始化客户端
                supabase = window.supabase.createClient(
                    config.SUPABASE_URL,
                    config.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: false
                        },
                        realtime: {
                            params: {
                                eventsPerSecond: 10
                            }
                        }
                    }
                );

                updateConnectionStatus('online', '已连接到 Supabase 云服务器');
                addLog('✅ Supabase 客户端初始化成功', 'success');
                
                // 设置实时监听
                setupRealtimeSubscription();
                
                // 加载初始数据
                await loadDashboardData();
                
                return true;
            } catch (error) {
                updateConnectionStatus('offline', `连接失败: ${error.message}`);
                addLog(`❌ 初始化失败: ${error.message}`, 'error');
                return false;
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connection-indicator');
            const statusText = document.getElementById('connection-status');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = message;
        }

        // 设置实时订阅
        function setupRealtimeSubscription() {
            if (!supabase) return;

            try {
                realtimeChannel = supabase
                    .channel('admin-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'users' },
                        (payload) => {
                            addLog(`👥 用户数据更新: ${payload.eventType}`, 'info');
                            refreshUserData();
                        }
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'settings' },
                        (payload) => {
                            addLog(`⚙️ 设置更新: ${payload.eventType}`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            addLog('📡 实时监听已启动', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            addLog('❌ 实时监听连接失败', 'error');
                        }
                    });
            } catch (error) {
                addLog(`❌ 实时订阅设置失败: ${error.message}`, 'error');
            }
        }

        // 加载仪表板数据
        async function loadDashboardData() {
            try {
                // 加载用户统计
                await loadUserStats();
                
                // 加载用户列表
                await refreshUserData();
                
                // 加载奖品配置
                await loadPrizesConfig();
                
                addLog('📊 仪表板数据加载完成', 'success');
            } catch (error) {
                addLog(`❌ 数据加载失败: ${error.message}`, 'error');
            }
        }

        // 加载用户统计
        async function loadUserStats() {
            try {
                const { count: totalUsers, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (usersError) throw usersError;

                document.getElementById('total-users').textContent = totalUsers || 0;

                // 今日注册数
                const today = new Date().toISOString().split('T')[0];
                const { count: todayCount, error: todayError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);

                if (!todayError) {
                    document.getElementById('today-registrations').textContent = todayCount || 0;
                }

                // 抽奖次数统计（从用户表的 draw_count 字段）
                const { data: drawData, error: drawError } = await supabase
                    .from('users')
                    .select('draw_count');

                if (!drawError && drawData) {
                    const totalDraws = drawData.reduce((sum, user) => sum + (user.draw_count || 0), 0);
                    document.getElementById('total-draws').textContent = totalDraws;
                }

            } catch (error) {
                addLog(`❌ 用户统计加载失败: ${error.message}`, 'error');
            }
        }

        // 刷新用户数据
        async function refreshUserData() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const tbody = document.getElementById('users-table');
                tbody.innerHTML = '';

                if (users && users.length > 0) {
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-700';
                        row.innerHTML = `
                            <td class="p-2">${user.name || '-'}</td>
                            <td class="p-2">${user.phone || '-'}</td>
                            <td class="p-2">${new Date(user.created_at).toLocaleString()}</td>
                            <td class="p-2">
                                <span class="px-2 py-1 rounded text-xs ${user.is_active ? 'bg-green-600' : 'bg-gray-600'}">
                                    ${user.is_active ? '活跃' : '非活跃'}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">暂无用户数据</td></tr>';
                }

                addLog(`📊 用户数据已刷新，共 ${users.length} 条记录`, 'info');
            } catch (error) {
                addLog(`❌ 用户数据刷新失败: ${error.message}`, 'error');
            }
        }

        // 加载奖品配置
        async function loadPrizesConfig() {
            try {
                const { data: settings, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'prizes_config')
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                const textarea = document.getElementById('prizes-config');
                if (settings && settings.value) {
                    textarea.value = JSON.stringify(settings.value, null, 2);
                } else {
                    // 默认奖品配置
                    const defaultPrizes = {
                        prizes: [
                            { name: "一等奖", probability: 0.05, color: "#ff6b6b" },
                            { name: "二等奖", probability: 0.15, color: "#4ecdc4" },
                            { name: "三等奖", probability: 0.30, color: "#45b7d1" },
                            { name: "谢谢参与", probability: 0.50, color: "#96ceb4" }
                        ]
                    };
                    textarea.value = JSON.stringify(defaultPrizes, null, 2);
                }
            } catch (error) {
                addLog(`❌ 奖品配置加载失败: ${error.message}`, 'error');
            }
        }

        // 更新奖品配置
        async function updatePrizes() {
            try {
                const textarea = document.getElementById('prizes-config');
                const config = JSON.parse(textarea.value);

                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'prizes_config',
                        value: config,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('✅ 奖品配置已保存', 'success');
                alert('奖品配置保存成功！');
            } catch (error) {
                addLog(`❌ 奖品配置保存失败: ${error.message}`, 'error');
                alert(`保存失败: ${error.message}`);
            }
        }

        // 重置奖品配置
        function resetPrizes() {
            if (confirm('确定要重置奖品配置吗？')) {
                loadPrizesConfig();
                addLog('🔄 奖品配置已重置', 'info');
            }
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logs.push(logEntry);

            const logsContainer = document.getElementById('realtime-logs');
            const logElement = document.createElement('div');
            logElement.className = `mb-1 ${type === 'success' ? 'text-green-400' : 
                                           type === 'error' ? 'text-red-400' : 
                                           type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // 保持最多100条日志
            if (logs.length > 100) {
                logs.shift();
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // 清空日志
        function clearLogs() {
            logs.length = 0;
            document.getElementById('realtime-logs').innerHTML = '<div class="text-gray-400">日志已清空</div>';
        }

        // 导出日志
        function exportLogs() {
            const logText = logs.map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 数据备份
        async function backupDatabase() {
            try {
                addLog('💾 开始数据备份...', 'info');
                
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*');

                const { data: settings, error: settingsError } = await supabase
                    .from('settings')
                    .select('*');

                if (usersError || settingsError) {
                    throw new Error('数据读取失败');
                }

                const backup = {
                    timestamp: new Date().toISOString(),
                    users: users || [],
                    settings: settings || []
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `database-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                addLog('✅ 数据备份完成', 'success');
            } catch (error) {
                addLog(`❌ 数据备份失败: ${error.message}`, 'error');
            }
        }

        // 清理缓存
        function clearCache() {
            if (confirm('确定要清理系统缓存吗？')) {
                localStorage.clear();
                sessionStorage.clear();
                addLog('🗑️ 系统缓存已清理', 'info');
                alert('缓存清理完成！');
            }
        }

        // 系统诊断
        async function systemDiagnostic() {
            addLog('🔍 开始系统诊断...', 'info');
            
            try {
                // 检查数据库连接
                const { error: dbError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (dbError) {
                    addLog('❌ 数据库连接异常', 'error');
                } else {
                    addLog('✅ 数据库连接正常', 'success');
                }

                // 检查实时连接
                if (realtimeChannel && realtimeChannel.state === 'joined') {
                    addLog('✅ 实时连接正常', 'success');
                } else {
                    addLog('⚠️ 实时连接异常', 'warning');
                }

                // 检查配置
                if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.SUPABASE_URL) {
                    addLog('✅ 配置文件正常', 'success');
                } else {
                    addLog('❌ 配置文件异常', 'error');
                }

                addLog('🔍 系统诊断完成', 'info');
            } catch (error) {
                addLog(`❌ 系统诊断失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', async function() {
            addLog('🚀 管理员面板启动中...', 'info');
            
            // 延迟执行，确保所有脚本已加载
            setTimeout(async () => {
                const success = await initializeSupabase();
                if (success) {
                    addLog('✅ 管理员面板初始化完成', 'success');
                } else {
                    addLog('❌ 管理员面板初始化失败', 'error');
                }
            }, 1000);
        });

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function() {
            if (realtimeChannel && supabase) {
                supabase.removeChannel(realtimeChannel);
            }
        });

        // 定期刷新数据
        setInterval(async () => {
            if (supabase) {
                await loadUserStats();
            }
        }, 30000); // 每30秒刷新一次
    </script>
</body>
</html>