<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 抽奖轮盘系统 - 管理员面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .admin-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- 加载 Supabase 配置 - 确保与用户端统一 -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <div class="container mx-auto px-4 py-8">
        <!-- 顶部导航 -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-blue-400">🎯 抽奖轮盘系统</h1>
                <p class="text-gray-300 mt-2">管理员控制面板 - Supabase 云服务器</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <span id="connection-indicator" class="status-indicator status-offline"></span>
                    <span id="connection-status" class="text-sm">连接中...</span>
                </div>
                <button onclick="window.open('index.html', '_blank')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    🎮 用户端
                </button>
                <button onclick="window.open('supabase-connection-validator.html', '_blank')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    🔧 连接验证器
                </button>
            </div>
        </div>

        <!-- 系统状态概览 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">总用户数</p>
                        <p id="total-users" class="text-2xl font-bold text-blue-400">-</p>
                    </div>
                    <div class="text-3xl">👥</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">今日注册</p>
                        <p id="today-registrations" class="text-2xl font-bold text-green-400">-</p>
                    </div>
                    <div class="text-3xl">📈</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">今日参与者</p>
                        <p id="today-participants" class="text-2xl font-bold text-purple-400">-</p>
                    </div>
                    <div class="text-3xl">🎯</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">总抽奖次数</p>
                        <p id="total-draws" class="text-2xl font-bold text-yellow-400">-</p>
                    </div>
                    <div class="text-3xl">🎲</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">系统状态</p>
                        <p id="system-status" class="text-2xl font-bold text-green-400">正常</p>
                    </div>
                    <div class="text-3xl">⚡</div>
                </div>
            </div>
        </div>

        <!-- 主要功能区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 用户搜索和管理 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-400">👥 用户搜索与管理</h3>
                    <button onclick="refreshUserData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        🔄 刷新
                    </button>
                </div>
                
                <!-- 搜索框 -->
                <div class="mb-6">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <input type="text" id="user-search" placeholder="搜索用户名或电话号码..." 
                                   class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                        </div>
                        <button onclick="searchUsers()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            搜索
                        </button>
                        <button onclick="clearSearch()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            清除
                        </button>
                    </div>
                </div>

                <div class="data-table">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="text-left p-2">姓名</th>
                                <th class="text-left p-2">电话</th>
                                <th class="text-left p-2">注册时间</th>
                                <th class="text-left p-2">抽奖次数</th>
                                <th class="text-left p-2">获得奖品</th>
                                <th class="text-left p-2">剩余机会</th>
                                <th class="text-left p-2">操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-table" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="7" class="text-center p-4 text-gray-400">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 抽奖设置 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-green-400 mb-4">🎮 抽奖设置</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">奖品配置（简单格式）</label>
                        <div class="text-sm text-gray-400 mb-2">
                            格式：奖品名称 概率%（每行一个奖品）<br>
                            例如：1602 mug 1%，1602 Pen 15%，Cash Voucher RM5 18%
                        </div>
                        <textarea id="prizes-simple-config" rows="8" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" 
                                  placeholder="1602 Mug 1%&#10;1602 Pen 15%&#10;Cash Voucher RM5 18%&#10;Online Voucher RM10 7%&#10;Online Voucher RM20 5%&#10;Free 660ml Bottle 8%&#10;New 330ml Can 12%&#10;Cooler Bag 7%&#10;Wine Card 0%&#10;Spin Again! 9%&#10;Thank You 18%"></textarea>
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <h4 class="text-sm font-medium text-gray-300 mb-2">当前概率总计：<span id="total-percentage" class="text-yellow-400">0%</span></h4>
                        <div class="text-xs text-gray-400">建议总计为100%，系统会自动调整</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="updatePrizesSimple()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1">
                            💾 保存设置
                        </button>
                        <button onclick="resetPrizesSimple()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            🔄 重置为默认
                        </button>
                        <button onclick="validatePrizes()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            ✅ 验证配置
                        </button>
                    </div>
                    
                    <!-- 高级配置（可折叠） -->
                    <div class="mt-4">
                        <button onclick="toggleAdvancedConfig()" class="text-sm text-blue-400 hover:text-blue-300">
                            🔧 显示高级JSON配置
                        </button>
                        <div id="advanced-config" class="hidden mt-3">
                            <label class="block text-sm font-medium text-gray-300 mb-2">JSON配置（高级用户）</label>
                            <textarea id="prizes-json-config" rows="6" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-xs" 
                                      placeholder="自动生成的JSON配置..." readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 公告栏管理 -->
        <div class="admin-card bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-green-400 mb-4">📢 公告栏管理</h3>
            
            <!-- 发布新公告 -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">发布新公告</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">公告标题</label>
                        <input type="text" id="announcement-title" placeholder="输入公告标题..." 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">公告内容</label>
                        <textarea id="announcement-content" rows="4" placeholder="输入公告内容..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">上传图片/海报</label>
                        <input type="file" id="announcement-image" accept="image/*" 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="publishAnnouncement()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            📢 发布公告
                        </button>
                        <button onclick="clearAnnouncementForm()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            清除
                        </button>
                    </div>
                </div>
            </div>

            <!-- 公告列表 -->
            <div>
                <h4 class="text-lg font-semibold text-white mb-3">已发布公告</h4>
                <div id="announcements-list" class="space-y-4">
                    <!-- 公告列表将在这里动态加载 -->
                </div>
            </div>
        </div>

        <!-- 内容管理 -->
        <div class="admin-card bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-blue-400 mb-4">📝 内容管理</h3>
            
            <!-- 领奖T&C管理 -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">🏆 领奖条款与条件 (T&C)</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">领奖条款内容</label>
                        <textarea id="terms-content" rows="6" placeholder="输入领奖条款与条件..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"></textarea>
                    </div>
                    <button onclick="updateTermsConditions()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        💾 保存领奖条款
                    </button>
                </div>
            </div>

            <!-- 优惠套餐管理 -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">🎉 优惠套餐内容</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">优惠套餐详情</label>
                        <textarea id="promotion-content" rows="8" 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-orange-500">🎉🎉🎉特价优惠🎉🎉🎉
（周一至周四） monday to thursday：
消费满55令吉以上(以一张单据为准)可以8令吉优惠价购得660ml瓶装精酿啤酒 (只限3瓶)
Spend RM55 or more (based on one receipt), you can purchase 660ml bottles of craft beer at a discounted price of RM8 (limited to 3 bottles)</textarea>
                    </div>
                    <button onclick="updatePromotionContent()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                        💾 保存优惠套餐
                    </button>
                </div>
            </div>
        </div>

        <!-- 产品知识库管理 -->
        <div class="admin-card bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-purple-400 mb-4">📚 AI啤酒推荐知识库</h3>
            
            <!-- 添加新知识 -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">添加产品知识</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">产品名称</label>
                        <input type="text" id="knowledge-title" placeholder="输入产品名称..." 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                    </div>
                    <input type="hidden" id="knowledge-category" value="beer">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">产品描述</label>
                        <textarea id="knowledge-description" rows="4" placeholder="输入详细的产品描述..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">产品特点</label>
                        <textarea id="knowledge-features" rows="3" placeholder="输入产品特点（每行一个特点）..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"></textarea>
                    </div>
                    <input type="hidden" id="knowledge-price" value="0">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">上传产品图片</label>
                        <input type="file" id="knowledge-images" accept="image/*" multiple 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">上传产品文档</label>
                        <input type="file" id="knowledge-documents" accept=".pdf,.doc,.docx,.txt" multiple 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="addKnowledge()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                            📚 添加知识
                        </button>
                        <button onclick="clearKnowledgeForm()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            清除
                        </button>
                    </div>
                </div>
            </div>

            <!-- 知识库列表 -->
            <div>
                <h4 class="text-lg font-semibold text-white mb-3">知识库内容</h4>
                <div class="mb-4">
                    <input type="text" id="knowledge-search" placeholder="搜索产品知识..." 
                           class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                </div>
                <div id="knowledge-list" class="space-y-4">
                    <!-- 知识库列表将在这里动态加载 -->
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- 实时监控 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">📊 实时监控</h3>
                <div id="realtime-logs" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto text-sm">
                    <div class="text-gray-400">等待实时数据...</div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="clearLogs()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        🗑️ 清空日志
                    </button>
                    <button onclick="exportLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        📥 导出日志
                    </button>
                </div>
            </div>

            <!-- 数据分析 -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-purple-400 mb-4">📈 数据分析</h3>
                <div class="space-y-4">
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-blue-300 mb-2">用户注册趋势</h4>
                        <div id="registration-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            图表加载中...
                        </div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-green-300 mb-2">抽奖活跃度</h4>
                        <div id="activity-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            图表加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统配置 -->
        <div class="mt-8 admin-card bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold text-purple-400 mb-4">⚙️ 系统配置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 抽奖机会配置 -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-white mb-3">🎯 抽奖机会配置</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">新用户初始抽奖机会</label>
                            <input type="number" id="initial-chances" min="1" max="10" value="1" 
                                   class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                            <div class="text-xs text-gray-400 mt-1">建议设置为 1-5 次</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">"再来一次"奖励机会</label>
                            <input type="number" id="spin-again-bonus" min="1" max="5" value="1" 
                                   class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">最大累积机会数</label>
                            <input type="number" id="max-chances" min="5" max="50" value="10" 
                                   class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                        </div>
                        <button onclick="saveLotteryConfig()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                            💾 保存配置
                        </button>
                    </div>
                </div>
                
                <!-- 系统状态配置 -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-white mb-3">🔧 系统状态</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">抽奖系统状态</span>
                            <span id="lottery-status" class="text-green-400">正常运行</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">数据库连接</span>
                            <span id="db-status" class="text-green-400">已连接</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">实时同步</span>
                            <span id="realtime-status" class="text-green-400">已启用</span>
                        </div>
                        <button onclick="loadLotteryConfig()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
                            🔄 重新加载配置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统工具 -->
        <div class="mt-8 admin-card bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold text-red-400 mb-4">🔧 系统工具</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="backupDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded text-center">
                    💾 数据备份
                </button>
                <button onclick="clearCache()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded text-center">
                    🗑️ 清理缓存
                </button>
                <button onclick="systemDiagnostic()" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded text-center">
                    🔍 系统诊断
                </button>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let realtimeChannel = null;
        const logs = [];

        // 初始化 Supabase 客户端 - 使用与用户端相同的配置
        async function initializeSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase 配置未找到');
                }

                const config = window.SUPABASE_CONFIG;
                
                // 验证配置
                if (!config.SUPABASE_URL || config.SUPABASE_URL === 'https://your-project-id.supabase.co') {
                    throw new Error('Supabase URL 未正确配置');
                }
                
                if (!config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === 'your-supabase-anon-key-here') {
                    throw new Error('Supabase API Key 未正确配置');
                }

                // 初始化客户端，优化实时连接配置
                supabase = window.supabase.createClient(
                    config.SUPABASE_URL,
                    config.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: false,
                            autoRefreshToken: true
                        },
                        realtime: {
                            params: {
                                eventsPerSecond: 10
                            },
                            heartbeatIntervalMs: 30000,
                            reconnectAfterMs: function(tries) {
                                return Math.min(tries * 1000, 30000);
                            }
                        },
                        db: {
                            schema: 'public'
                        },
                        global: {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        }
                    }
                );

                updateConnectionStatus('online', '已连接到 Supabase 云服务器');
                addLog('✅ Supabase 客户端初始化成功', 'success');
                
                // 设置实时监听
                setupRealtimeSubscription();
                
                // 加载初始数据
                await loadDashboardData();
                
                return true;
            } catch (error) {
                updateConnectionStatus('offline', `连接失败: ${error.message}`);
                addLog(`❌ 初始化失败: ${error.message}`, 'error');
                return false;
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connection-indicator');
            const statusText = document.getElementById('connection-status');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = message;
        }

        // 设置实时订阅
        function setupRealtimeSubscription() {
            if (!supabase) return;

            try {
                realtimeChannel = supabase
                    .channel('admin-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'users' },
                        (payload) => {
                            addLog(`👥 用户数据更新: ${payload.eventType}`, 'info');
                            refreshUserData();
                        }
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'settings' },
                        (payload) => {
                            addLog(`⚙️ 设置更新: ${payload.eventType}`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            addLog('📡 实时监听已启动', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            addLog('❌ 实时监听连接失败', 'error');
                        }
                    });
            } catch (error) {
                addLog(`❌ 实时订阅设置失败: ${error.message}`, 'error');
            }
        }

        // 加载仪表板数据
        async function loadDashboardData() {
            try {
                // 加载用户统计
                await loadUserStats();
                
                // 加载用户列表
                await refreshUserData();
                
                // 加载奖品配置
                await loadPrizesConfig();
                
                // 加载公告列表
                await loadAnnouncements();
                
                // 加载知识库
                await loadKnowledge();
                
                // 加载内容管理数据
                await loadContentManagement();
                
                addLog('📊 仪表板数据加载完成', 'success');
            } catch (error) {
                addLog(`❌ 数据加载失败: ${error.message}`, 'error');
            }
        }

        // 加载用户统计
        async function loadUserStats() {
            try {
                const { count: totalUsers, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (usersError) throw usersError;

                document.getElementById('total-users').textContent = totalUsers || 0;

                // 今日注册数
                const today = new Date().toISOString().split('T')[0];
                const { count: todayCount, error: todayError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);

                if (!todayError) {
                    document.getElementById('today-registrations').textContent = todayCount || 0;
                }

                // 今日参与者数（今天有抽奖记录的用户）
                try {
                    const { data: todayParticipants, error: participantsError } = await supabase
                        .from('users')
                        .select('id')
                        .gte('last_draw_date', today);

                    if (!participantsError) {
                        document.getElementById('today-participants').textContent = todayParticipants?.length || 0;
                    } else {
                        document.getElementById('today-participants').textContent = '0';
                    }
                } catch (e) {
                    document.getElementById('today-participants').textContent = '0';
                }

                // 抽奖次数统计（从用户表的 draw_count 字段）
                const { data: drawData, error: drawError } = await supabase
                    .from('users')
                    .select('draw_count');

                if (!drawError && drawData) {
                    const totalDraws = drawData.reduce((sum, user) => sum + (user.draw_count || 0), 0);
                    document.getElementById('total-draws').textContent = totalDraws;
                }

            } catch (error) {
                addLog(`❌ 用户统计加载失败: ${error.message}`, 'error');
                // 设置默认值
                document.getElementById('total-users').textContent = '0';
                document.getElementById('today-registrations').textContent = '0';
                document.getElementById('today-participants').textContent = '0';
                document.getElementById('total-draws').textContent = '0';
            }
        }

        // 刷新用户数据
        async function refreshUserData() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const tbody = document.getElementById('users-table');
                tbody.innerHTML = '';

                if (users && users.length > 0) {
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-700';
                        row.innerHTML = `
                            <td class="p-2">${user.name || '-'}</td>
                            <td class="p-2">${user.phone || '-'}</td>
                            <td class="p-2">${new Date(user.created_at).toLocaleString()}</td>
                            <td class="p-2">
                                <span class="px-2 py-1 rounded text-xs ${user.is_active ? 'bg-green-600' : 'bg-gray-600'}">
                                    ${user.is_active ? '活跃' : '非活跃'}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">暂无用户数据</td></tr>';
                }

                addLog(`📊 用户数据已刷新，共 ${users.length} 条记录`, 'info');
            } catch (error) {
                addLog(`❌ 用户数据刷新失败: ${error.message}`, 'error');
            }
        }

        // 奖品颜色配置
        const prizeColors = [
            "#fde047", "#4b5563", "#60a5fa", "#ef4444", "#a78bfa", 
            "#f97316", "#22c55e", "#ec4899", "#d946ef", "#14b8a6", "#84cc16"
        ];

        // 加载奖品配置
        async function loadPrizesConfig() {
            try {
                const { data: settings, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'prizes_config')
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                const simpleTextarea = document.getElementById('prizes-simple-config');
                const jsonTextarea = document.getElementById('prizes-json-config');
                
                if (settings && settings.value) {
                    // 将JSON配置转换为简单格式
                    const prizes = settings.value.prizes || settings.value;
                    const simpleFormat = prizes.map(prize => 
                        `${prize.name || prize.text} ${(prize.percentage || prize.probability * 100)}%`
                    ).join('\n');
                    
                    simpleTextarea.value = simpleFormat;
                    if (jsonTextarea) jsonTextarea.value = JSON.stringify(settings.value, null, 2);
                } else {
                    // 默认奖品配置
                    const defaultSimpleConfig = `1602 Mug 1%
1602 Pen 15%
Cash Voucher RM5 18%
Online Voucher RM10 7%
Online Voucher RM20 5%
Free 660ml Bottle 8%
New 330ml Can 12%
Cooler Bag 7%
Wine Card 0%
Spin Again! 9%
Thank You 18%`;
                    simpleTextarea.value = defaultSimpleConfig;
                    updateJsonFromSimple();
                }
                
                calculateTotalPercentage();
            } catch (error) {
                addLog(`❌ 奖品配置加载失败: ${error.message}`, 'error');
            }
        }

        function parseSimpleConfig(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const prizes = [];
            
            lines.forEach((line, index) => {
                const match = line.trim().match(/^(.+?)\s+(\d+(?:\.\d+)?)%$/);
                if (match) {
                    const name = match[1].trim();
                    const percentage = parseFloat(match[2]);
                    const color = prizeColors[index % prizeColors.length];
                    
                    prizes.push({
                        text: name,
                        name: name,
                        percentage: percentage,
                        probability: percentage / 100,
                        color: color
                    });
                }
            });
            
            return prizes;
        }

        function updateJsonFromSimple() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                
                const config = {
                    prizes: prizes,
                    updated_at: new Date().toISOString()
                };
                
                const jsonTextarea = document.getElementById('prizes-json-config');
                if (jsonTextarea) jsonTextarea.value = JSON.stringify(config, null, 2);
                calculateTotalPercentage();
            } catch (error) {
                console.error('解析简单配置失败:', error);
            }
        }

        function calculateTotalPercentage() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                const total = prizes.reduce((sum, prize) => sum + prize.percentage, 0);
                
                const totalElement = document.getElementById('total-percentage');
                if (totalElement) {
                    totalElement.textContent = `${total.toFixed(1)}%`;
                    
                    // 根据总计改变颜色
                    if (total === 100) {
                        totalElement.className = 'text-green-400';
                    } else if (total > 95 && total < 105) {
                        totalElement.className = 'text-yellow-400';
                    } else {
                        totalElement.className = 'text-red-400';
                    }
                }
            } catch (error) {
                const totalElement = document.getElementById('total-percentage');
                if (totalElement) {
                    totalElement.textContent = '错误';
                    totalElement.className = 'text-red-400';
                }
            }
        }

        async function updatePrizesSimple() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                
                if (prizes.length === 0) {
                    throw new Error('请输入有效的奖品配置');
                }
                
                const config = {
                    prizes: prizes,
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'prizes_config',
                        value: config,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                updateJsonFromSimple();
                addLog('✅ 奖品配置已保存', 'success');
                alert('奖品配置保存成功！前端将在下次刷新时更新。');
            } catch (error) {
                addLog(`❌ 奖品配置保存失败: ${error.message}`, 'error');
                alert(`保存失败: ${error.message}`);
            }
        }

        function validatePrizes() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                
                if (prizes.length === 0) {
                    alert('❌ 没有找到有效的奖品配置');
                    return;
                }
                
                const total = prizes.reduce((sum, prize) => sum + prize.percentage, 0);
                const duplicates = prizes.filter((prize, index, arr) => 
                    arr.findIndex(p => p.name === prize.name) !== index
                );
                
                let message = `✅ 配置验证结果:\n`;
                message += `- 奖品数量: ${prizes.length}\n`;
                message += `- 概率总计: ${total.toFixed(1)}%\n`;
                
                if (duplicates.length > 0) {
                    message += `⚠️ 发现重复奖品: ${duplicates.map(d => d.name).join(', ')}\n`;
                }
                
                if (total !== 100) {
                    message += `⚠️ 概率总计不等于100%，建议调整\n`;
                }
                
                message += `\n奖品列表:\n`;
                prizes.forEach(prize => {
                    message += `- ${prize.name}: ${prize.percentage}%\n`;
                });
                
                alert(message);
                updateJsonFromSimple();
            } catch (error) {
                alert(`❌ 验证失败: ${error.message}`);
            }
        }

        function resetPrizesSimple() {
            if (confirm('确定要重置为默认奖品配置吗？')) {
                const defaultConfig = `1602 Mug 1%
1602 Pen 15%
Cash Voucher RM5 18%
Online Voucher RM10 7%
Online Voucher RM20 5%
Free 660ml Bottle 8%
New 330ml Can 12%
Cooler Bag 7%
Wine Card 0%
Spin Again! 9%
Thank You 18%`;
                
                document.getElementById('prizes-simple-config').value = defaultConfig;
                updateJsonFromSimple();
                addLog('🔄 奖品配置已重置为默认', 'info');
            }
        }

        function toggleAdvancedConfig() {
            const advancedDiv = document.getElementById('advanced-config');
            const button = event.target;
            
            if (advancedDiv.classList.contains('hidden')) {
                advancedDiv.classList.remove('hidden');
                button.textContent = '🔧 隐藏高级JSON配置';
                updateJsonFromSimple();
            } else {
                advancedDiv.classList.add('hidden');
                button.textContent = '🔧 显示高级JSON配置';
            }
        }

        // 更新奖品配置（兼容旧版本）
        async function updatePrizes() {
            return await updatePrizesSimple();
        }

        // 重置奖品配置
        function resetPrizes() {
            if (confirm('确定要重置奖品配置吗？')) {
                loadPrizesConfig();
                addLog('🔄 奖品配置已重置', 'info');
            }
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logs.push(logEntry);

            const logsContainer = document.getElementById('realtime-logs');
            const logElement = document.createElement('div');
            logElement.className = `mb-1 ${type === 'success' ? 'text-green-400' : 
                                           type === 'error' ? 'text-red-400' : 
                                           type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // 保持最多100条日志
            if (logs.length > 100) {
                logs.shift();
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // 清空日志
        function clearLogs() {
            logs.length = 0;
            document.getElementById('realtime-logs').innerHTML = '<div class="text-gray-400">日志已清空</div>';
        }

        // 导出日志
        function exportLogs() {
            const logText = logs.map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 数据备份
        async function backupDatabase() {
            try {
                addLog('💾 开始数据备份...', 'info');
                
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*');

                const { data: settings, error: settingsError } = await supabase
                    .from('settings')
                    .select('*');

                if (usersError || settingsError) {
                    throw new Error('数据读取失败');
                }

                const backup = {
                    timestamp: new Date().toISOString(),
                    users: users || [],
                    settings: settings || []
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `database-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                addLog('✅ 数据备份完成', 'success');
            } catch (error) {
                addLog(`❌ 数据备份失败: ${error.message}`, 'error');
            }
        }

        // 清理缓存
        function clearCache() {
            if (confirm('确定要清理系统缓存吗？')) {
                localStorage.clear();
                sessionStorage.clear();
                addLog('🗑️ 系统缓存已清理', 'info');
                alert('缓存清理完成！');
            }
        }

        // 系统诊断
        async function systemDiagnostic() {
            addLog('🔍 开始系统诊断...', 'info');
            
            try {
                // 检查数据库连接
                const { error: dbError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (dbError) {
                    addLog('❌ 数据库连接异常', 'error');
                } else {
                    addLog('✅ 数据库连接正常', 'success');
                }

                // 检查实时连接
                if (realtimeChannel && realtimeChannel.state === 'joined') {
                    addLog('✅ 实时连接正常', 'success');
                } else {
                    addLog('⚠️ 实时连接异常', 'warning');
                }

                // 检查配置
                if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.SUPABASE_URL) {
                    addLog('✅ 配置文件正常', 'success');
                } else {
                    addLog('❌ 配置文件异常', 'error');
                }

                addLog('🔍 系统诊断完成', 'info');
            } catch (error) {
                addLog(`❌ 系统诊断失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', async function() {
            addLog('🚀 管理员面板启动中...', 'info');
            
            // 延迟执行，确保所有脚本已加载
            setTimeout(async () => {
                const success = await initializeSupabase();
                if (success) {
                    addLog('✅ 管理员面板初始化完成', 'success');
                } else {
                    addLog('❌ 管理员面板初始化失败', 'error');
                }
            }, 1000);
        });

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', function() {
            if (realtimeChannel && supabase) {
                supabase.removeChannel(realtimeChannel);
            }
        });

        // 搜索用户
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.trim();
            if (!searchTerm) {
                await refreshUserData();
                return;
            }

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayUsers(users);
                addLog(`🔍 搜索用户: "${searchTerm}", 找到 ${users.length} 条结果`, 'info');
            } catch (error) {
                addLog(`❌ 搜索用户失败: ${error.message}`, 'error');
            }
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('user-search').value = '';
            refreshUserData();
        }

        // 显示用户列表
         function displayUsers(users) {
             const tbody = document.getElementById('users-table');
             tbody.innerHTML = '';
 
             if (users && users.length > 0) {
                 users.forEach(user => {
                     // 处理奖品记录显示
                     let prizesDisplay = '-';
                     if (user.prizeswon && Array.isArray(user.prizeswon) && user.prizeswon.length > 0) {
                         prizesDisplay = user.prizeswon.map(prize => {
                             if (typeof prize === 'string') {
                                 return prize;
                             } else if (prize.prize) {
                                 return prize.prize;
                             } else if (prize.name) {
                                 return prize.name;
                             }
                             return JSON.stringify(prize);
                         }).join(', ');
                         
                         // 如果奖品太长，截断显示
                         if (prizesDisplay.length > 50) {
                             prizesDisplay = prizesDisplay.substring(0, 50) + '...';
                         }
                     } else if (user.prizes_won && Array.isArray(user.prizes_won) && user.prizes_won.length > 0) {
                         prizesDisplay = user.prizes_won.map(prize => {
                             if (typeof prize === 'string') {
                                 return prize;
                             } else if (prize.prize) {
                                 return prize.prize;
                             } else if (prize.name) {
                                 return prize.name;
                             }
                             return JSON.stringify(prize);
                         }).join(', ');
                         
                         if (prizesDisplay.length > 50) {
                             prizesDisplay = prizesDisplay.substring(0, 50) + '...';
                         }
                     }

                     const row = document.createElement('tr');
                     row.className = 'hover:bg-gray-700';
                     row.innerHTML = `
                         <td class="p-2">${user.name || '-'}</td>
                         <td class="p-2">${user.phone || '-'}</td>
                         <td class="p-2">${new Date(user.created_at || user.joindate).toLocaleString()}</td>
                         <td class="p-2">${user.draw_count || user.total_spins || 0}</td>
                         <td class="p-2" title="${prizesDisplay}">${prizesDisplay}</td>
                         <td class="p-2">${user.remaining_chances || 0}</td>
                         <td class="p-2">
                             <button onclick="viewUserPrizes('${user.id}', '${user.name}')" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs mr-1">
                                 查看奖品
                             </button>
                             <button onclick="addChance('${user.id}', '${user.name}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs mr-1">
                                 +1机会
                             </button>
                             <button onclick="editUser('${user.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">
                                 编辑
                             </button>
                             <button onclick="deleteUser('${user.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                                 删除
                             </button>
                         </td>
                     `;
                     tbody.appendChild(row);
                 });
             } else {
                 tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400">暂无用户数据</td></tr>';
             }
         }

         // 为用户添加抽奖机会
         async function addChance(userId, userName) {
             if (!confirm(`确定要为用户 "${userName}" 添加1次抽奖机会吗？`)) return;

             try {
                 // 获取当前用户数据
                 const { data: user, error: getUserError } = await supabase
                     .from('users')
                     .select('remaining_chances, extra_chances')
                     .eq('id', userId)
                     .single();

                 if (getUserError) throw getUserError;

                 // 更新用户的剩余机会和额外机会
                 const { error: updateError } = await supabase
                     .from('users')
                     .update({
                         remaining_chances: (user.remaining_chances || 0) + 1,
                         extra_chances: (user.extra_chances || 0) + 1,
                         updated_at: new Date().toISOString()
                     })
                     .eq('id', userId);

                 if (updateError) throw updateError;

                 addLog(`✅ 已为用户 "${userName}" 添加1次抽奖机会`, 'success');
                 
                 // 刷新用户列表
                 const searchTerm = document.getElementById('user-search').value.trim();
                 if (searchTerm) {
                     await searchUsers();
                 } else {
                     await refreshUserData();
                 }

                 alert(`成功为用户 "${userName}" 添加1次抽奖机会！`);
             } catch (error) {
                 addLog(`❌ 添加抽奖机会失败: ${error.message}`, 'error');
                 alert(`添加失败: ${error.message}`);
             }
         }

         // 编辑用户
         async function editUser(userId) {
             try {
                 const { data: user, error } = await supabase
                     .from('users')
                     .select('*')
                     .eq('id', userId)
                     .single();

                 if (error) throw error;

                 const newName = prompt('用户名:', user.name || '');
                 if (newName === null) return;

                 const newPhone = prompt('电话号码:', user.phone || '');
                 if (newPhone === null) return;

                 const newChances = prompt('剩余机会:', user.remaining_chances || 0);
                 if (newChances === null) return;

                 const { error: updateError } = await supabase
                     .from('users')
                     .update({
                         name: newName,
                         phone: newPhone,
                         remaining_chances: parseInt(newChances) || 0,
                         updated_at: new Date().toISOString()
                     })
                     .eq('id', userId);

                 if (updateError) throw updateError;

                 addLog(`✅ 用户信息已更新`, 'success');
                 
                 // 刷新用户列表
                 const searchTerm = document.getElementById('user-search').value.trim();
                 if (searchTerm) {
                     await searchUsers();
                 } else {
                     await refreshUserData();
                 }

                 alert('用户信息更新成功！');
             } catch (error) {
                 addLog(`❌ 更新用户信息失败: ${error.message}`, 'error');
                 alert(`更新失败: ${error.message}`);
             }
         }

         // 删除用户
         async function deleteUser(userId) {
             if (!confirm('确定要删除这个用户吗？此操作不可恢复！')) return;

             try {
                 const { error } = await supabase
                     .from('users')
                     .delete()
                     .eq('id', userId);

                 if (error) throw error;

                 addLog('🗑️ 用户已删除', 'info');
                 
                 // 刷新用户列表
                 const searchTerm = document.getElementById('user-search').value.trim();
                 if (searchTerm) {
                     await searchUsers();
                 } else {
                     await refreshUserData();
                 }

                 alert('用户删除成功！');
             } catch (error) {
                 addLog(`❌ 删除用户失败: ${error.message}`, 'error');
                 alert(`删除失败: ${error.message}`);
             }
         }

         // 查看用户奖品详情
         async function viewUserPrizes(userId, userName) {
             try {
                 // 获取用户详细信息和抽奖历史
                 const { data: user, error: userError } = await supabase
                     .from('users')
                     .select('*')
                     .eq('id', userId)
                     .single();

                 if (userError) throw userError;

                 // 获取抽奖历史记录
                 const { data: drawHistory, error: historyError } = await supabase
                     .from('draw_history')
                     .select('*')
                     .eq('user_id', userId)
                     .order('spin_date', { ascending: false });

                 // 构建奖品详情显示
                 let prizesContent = '';
                 
                 // 显示用户基本信息
                 prizesContent += `<div class="mb-4 p-4 bg-gray-700 rounded">
                     <h4 class="text-lg font-semibold text-white mb-2">用户信息</h4>
                     <p><strong>姓名:</strong> ${user.name || '-'}</p>
                     <p><strong>电话:</strong> ${user.phone || '-'}</p>
                     <p><strong>注册时间:</strong> ${new Date(user.created_at || user.joindate).toLocaleString()}</p>
                     <p><strong>总抽奖次数:</strong> ${user.draw_count || user.total_spins || 0}</p>
                     <p><strong>剩余机会:</strong> ${user.remaining_chances || 0}</p>
                 </div>`;

                 // 显示获奖记录
                 prizesContent += `<div class="mb-4 p-4 bg-gray-700 rounded">
                     <h4 class="text-lg font-semibold text-white mb-2">🏆 获奖记录</h4>`;

                 // 从用户表的奖品字段显示
                 if (user.prizeswon && Array.isArray(user.prizeswon) && user.prizeswon.length > 0) {
                     prizesContent += '<div class="mb-3"><h5 class="font-medium text-green-400">用户表记录:</h5><ul class="list-disc list-inside text-gray-300">';
                     user.prizeswon.forEach((prize, index) => {
                         let prizeText = '';
                         if (typeof prize === 'string') {
                             prizeText = prize;
                         } else if (prize.prize) {
                             prizeText = `${prize.prize} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else if (prize.name) {
                             prizeText = `${prize.name} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else {
                             prizeText = JSON.stringify(prize);
                         }
                         prizesContent += `<li>${prizeText}</li>`;
                     });
                     prizesContent += '</ul></div>';
                 } else if (user.prizes_won && Array.isArray(user.prizes_won) && user.prizes_won.length > 0) {
                     prizesContent += '<div class="mb-3"><h5 class="font-medium text-green-400">用户表记录:</h5><ul class="list-disc list-inside text-gray-300">';
                     user.prizes_won.forEach((prize, index) => {
                         let prizeText = '';
                         if (typeof prize === 'string') {
                             prizeText = prize;
                         } else if (prize.prize) {
                             prizeText = `${prize.prize} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else if (prize.name) {
                             prizeText = `${prize.name} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else {
                             prizeText = JSON.stringify(prize);
                         }
                         prizesContent += `<li>${prizeText}</li>`;
                     });
                     prizesContent += '</ul></div>';
                 }

                 // 从抽奖历史表显示
                 if (!historyError && drawHistory && drawHistory.length > 0) {
                     prizesContent += '<div class="mb-3"><h5 class="font-medium text-blue-400">抽奖历史记录:</h5><ul class="list-disc list-inside text-gray-300">';
                     drawHistory.forEach(record => {
                         const prizeText = record.prize_won || record.result || '未知奖品';
                         const dateText = new Date(record.spin_date || record.created_at).toLocaleString();
                         prizesContent += `<li>${prizeText} - ${dateText}</li>`;
                     });
                     prizesContent += '</ul></div>';
                 }

                 if (!user.prizeswon?.length && !user.prizes_won?.length && (!drawHistory || drawHistory.length === 0)) {
                     prizesContent += '<p class="text-gray-400">该用户暂无获奖记录</p>';
                 }

                 prizesContent += '</div>';

                 // 显示模态框
                 const modal = document.createElement('div');
                 modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                 modal.innerHTML = `
                     <div class="bg-gray-800 p-6 rounded-lg max-w-2xl max-h-96 overflow-y-auto">
                         <div class="flex justify-between items-center mb-4">
                             <h3 class="text-xl font-bold text-white">${userName} - 奖品详情</h3>
                             <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                 </svg>
                             </button>
                         </div>
                         <div class="text-gray-300">
                             ${prizesContent}
                         </div>
                     </div>
                 `;
                 document.body.appendChild(modal);

                 addLog(`🔍 查看用户 "${userName}" 的奖品详情`, 'info');
             } catch (error) {
                 addLog(`❌ 查看用户奖品失败: ${error.message}`, 'error');
                 alert(`查看失败: ${error.message}`);
             }
         }

        // 发布公告
        async function publishAnnouncement() {
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            const imageFile = document.getElementById('announcement-image').files[0];

            if (!title || !content) {
                alert('请填写公告标题和内容');
                return;
            }

            try {
                let imageUrl = null;

                // 如果有图片，先上传图片
                if (imageFile) {
                    const fileName = `announcements/${Date.now()}_${imageFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('images')
                        .upload(fileName, imageFile);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('images')
                        .getPublicUrl(fileName);
                    
                    imageUrl = urlData.publicUrl;
                }

                // 保存公告到数据库
                const { error } = await supabase
                    .from('announcements')
                    .insert({
                        title,
                        content,
                        image_url: imageUrl,
                        created_at: new Date().toISOString(),
                        is_active: true
                    });

                if (error) throw error;

                addLog('📢 公告发布成功', 'success');
                clearAnnouncementForm();
                await loadAnnouncements();
                alert('公告发布成功！');
            } catch (error) {
                addLog(`❌ 公告发布失败: ${error.message}`, 'error');
                alert(`发布失败: ${error.message}`);
            }
        }

        // 清除公告表单
        function clearAnnouncementForm() {
            document.getElementById('announcement-title').value = '';
            document.getElementById('announcement-content').value = '';
            document.getElementById('announcement-image').value = '';
        }

        // 加载公告列表
        async function loadAnnouncements() {
            try {
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('announcements-list');
                container.innerHTML = '';

                if (announcements && announcements.length > 0) {
                    announcements.forEach(announcement => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-700 p-4 rounded-lg';
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h5 class="font-semibold text-white">${announcement.title}</h5>
                                <div class="flex gap-2">
                                    <button onclick="toggleAnnouncement('${announcement.id}', ${!announcement.is_active})" 
                                            class="px-2 py-1 rounded text-xs ${
                                                announcement.is_active ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'
                                            } text-white">
                                        ${announcement.is_active ? '隐藏' : '显示'}
                                    </button>
                                    <button onclick="deleteAnnouncement('${announcement.id}')" 
                                            class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                        删除
                                    </button>
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm mb-2">${announcement.content}</p>
                            ${announcement.image_url ? `<img src="${announcement.image_url}" class="max-w-xs rounded mb-2" alt="公告图片">` : ''}
                            <div class="flex justify-between items-center text-xs text-gray-400">
                                <span>发布时间: ${new Date(announcement.created_at).toLocaleString()}</span>
                                <span class="px-2 py-1 rounded ${
                                    announcement.is_active ? 'bg-green-600' : 'bg-gray-600'
                                }">
                                    ${announcement.is_active ? '已发布' : '已隐藏'}
                                </span>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-gray-400 text-center p-4">暂无公告</div>';
                }
            } catch (error) {
                addLog(`❌ 加载公告失败: ${error.message}`, 'error');
            }
        }

        // 切换公告状态
        async function toggleAnnouncement(id, isActive) {
            try {
                const { error } = await supabase
                    .from('announcements')
                    .update({ is_active: isActive })
                    .eq('id', id);

                if (error) throw error;

                addLog(`📢 公告状态已更新: ${isActive ? '显示' : '隐藏'}`, 'info');
                await loadAnnouncements();
            } catch (error) {
                addLog(`❌ 更新公告状态失败: ${error.message}`, 'error');
            }
        }

        // 删除公告
        async function deleteAnnouncement(id) {
            if (!confirm('确定要删除这条公告吗？')) return;

            try {
                const { error } = await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                addLog('🗑️ 公告已删除', 'info');
                await loadAnnouncements();
            } catch (error) {
                addLog(`❌ 删除公告失败: ${error.message}`, 'error');
            }
        }

        // 添加产品知识
        async function addKnowledge() {
            const title = document.getElementById('knowledge-title').value.trim();
            const category = document.getElementById('knowledge-category').value;
            const description = document.getElementById('knowledge-description').value.trim();
            const features = document.getElementById('knowledge-features').value.trim();
            const price = document.getElementById('knowledge-price').value.trim();
            const imageFiles = document.getElementById('knowledge-images').files;
            const documentFiles = document.getElementById('knowledge-documents').files;

            if (!title || !category || !description) {
                alert('请填写产品名称、分类和描述');
                return;
            }

            try {
                let imageUrls = [];
                let documentUrls = [];

                // 上传图片
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const fileName = `knowledge/images/${Date.now()}_${i}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('images')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('images')
                        .getPublicUrl(fileName);
                    
                    imageUrls.push(urlData.publicUrl);
                }

                // 上传文档
                for (let i = 0; i < documentFiles.length; i++) {
                    const file = documentFiles[i];
                    const fileName = `knowledge/documents/${Date.now()}_${i}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('documents')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('documents')
                        .getPublicUrl(fileName);
                    
                    documentUrls.push({
                        name: file.name,
                        url: urlData.publicUrl
                    });
                }

                // 保存知识到数据库
                const { error } = await supabase
                    .from('knowledge')
                    .insert({
                        title,
                        category,
                        description,
                        features: features.split('\n').filter(f => f.trim()),
                        price,
                        image_urls: imageUrls,
                        document_urls: documentUrls,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('📚 产品知识添加成功', 'success');
                clearKnowledgeForm();
                await loadKnowledge();
                alert('产品知识添加成功！');
            } catch (error) {
                addLog(`❌ 添加产品知识失败: ${error.message}`, 'error');
                alert(`添加失败: ${error.message}`);
            }
        }

        // 清除知识表单
        function clearKnowledgeForm() {
            document.getElementById('knowledge-title').value = '';
            document.getElementById('knowledge-category').value = '';
            document.getElementById('knowledge-description').value = '';
            document.getElementById('knowledge-features').value = '';
            document.getElementById('knowledge-price').value = '';
            document.getElementById('knowledge-images').value = '';
            document.getElementById('knowledge-documents').value = '';
        }

        // 加载知识库
        async function loadKnowledge() {
            try {
                const { data: knowledge, error } = await supabase
                    .from('knowledge')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('knowledge-list');
                container.innerHTML = '';

                if (knowledge && knowledge.length > 0) {
                    knowledge.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-700 p-4 rounded-lg';
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-semibold text-white">${item.title}</h5>
                                    <span class="text-xs px-2 py-1 bg-purple-600 rounded">${getCategoryName(item.category)}</span>
                                </div>
                                <button onclick="deleteKnowledge('${item.id}')" 
                                        class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                    删除
                                </button>
                            </div>
                            <p class="text-gray-300 text-sm mb-2">${item.description}</p>
                            ${item.price ? `<p class="text-green-400 font-semibold mb-2">价格: ${item.price}</p>` : ''}
                            ${item.features && item.features.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-sm font-medium text-gray-300 mb-1">产品特点:</p>
                                    <ul class="text-xs text-gray-400 list-disc list-inside">
                                        ${item.features.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${item.image_urls && item.image_urls.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-sm font-medium text-gray-300 mb-1">产品图片:</p>
                                    <div class="flex gap-2 flex-wrap">
                                        ${item.image_urls.map(url => `<img src="${url}" class="w-16 h-16 object-cover rounded" alt="产品图片">`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${item.document_urls && item.document_urls.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-sm font-medium text-gray-300 mb-1">相关文档:</p>
                                    <div class="flex gap-2 flex-wrap">
                                        ${item.document_urls.map(doc => `<a href="${doc.url}" target="_blank" class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded">${doc.name}</a>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="text-xs text-gray-400">
                                创建时间: ${new Date(item.created_at).toLocaleString()}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-gray-400 text-center p-4">暂无产品知识</div>';
                }
            } catch (error) {
                addLog(`❌ 加载知识库失败: ${error.message}`, 'error');
            }
        }

        // 获取分类名称
        function getCategoryName(category) {
            const categories = {
                'electronics': '电子产品',
                'clothing': '服装',
                'food': '食品',
                'beauty': '美容护肤',
                'home': '家居用品',
                'sports': '运动健身',
                'other': '其他'
            };
            return categories[category] || category;
        }

        // 删除知识
        async function deleteKnowledge(id) {
            if (!confirm('确定要删除这条产品知识吗？')) return;

            try {
                const { error } = await supabase
                    .from('knowledge')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                addLog('🗑️ 产品知识已删除', 'info');
                await loadKnowledge();
            } catch (error) {
                addLog(`❌ 删除产品知识失败: ${error.message}`, 'error');
            }
        }

        // 更新领奖条款
        async function updateTermsConditions() {
            const content = document.getElementById('terms-content').value.trim();
            
            if (!content) {
                alert('请输入领奖条款内容');
                return;
            }

            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'terms_conditions',
                        value: content,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('🏆 领奖条款已更新', 'success');
                alert('领奖条款保存成功！');
            } catch (error) {
                addLog(`❌ 更新领奖条款失败: ${error.message}`, 'error');
                alert(`保存失败: ${error.message}`);
            }
        }

        // 更新优惠套餐内容
        async function updatePromotionContent() {
            const content = document.getElementById('promotion-content').value.trim();
            
            if (!content) {
                alert('请输入优惠套餐内容');
                return;
            }

            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'promotion_content',
                        value: content,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('🎉 优惠套餐内容已更新', 'success');
                alert('优惠套餐内容保存成功！');
            } catch (error) {
                addLog(`❌ 更新优惠套餐内容失败: ${error.message}`, 'error');
                alert(`保存失败: ${error.message}`);
            }
        }

        // 加载内容管理数据
        async function loadContentManagement() {
            try {
                // 加载领奖条款
                const { data: termsData, error: termsError } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'terms_conditions')
                    .single();

                if (!termsError && termsData) {
                    document.getElementById('terms-content').value = termsData.value;
                }

                // 加载优惠套餐内容
                const { data: promotionData, error: promotionError } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'promotion_content')
                    .single();

                if (!promotionError && promotionData) {
                    document.getElementById('promotion-content').value = promotionData.value;
                }

            } catch (error) {
                addLog(`❌ 加载内容管理数据失败: ${error.message}`, 'error');
            }
        }

        // 搜索框事件监听
        document.addEventListener('DOMContentLoaded', function() {
            const userSearchInput = document.getElementById('user-search');
            if (userSearchInput) {
                userSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }

            const knowledgeSearchInput = document.getElementById('knowledge-search');
            if (knowledgeSearchInput) {
                knowledgeSearchInput.addEventListener('input', function() {
                    // 实现知识库搜索功能
                    // 这里可以添加实时搜索逻辑
                });
            }
        });

        // 定期刷新数据
        setInterval(async () => {
            if (supabase) {
                await loadUserStats();
            }
        }, 30000); // 每30秒刷新一次

        // 抽奖配置管理函数
        async function saveLotteryConfig() {
            try {
                const initialChances = parseInt(document.getElementById('initial-chances').value) || 1;
                const spinAgainBonus = parseInt(document.getElementById('spin-again-bonus').value) || 1;
                const maxChances = parseInt(document.getElementById('max-chances').value) || 10;

                // 验证输入值
                if (initialChances < 1 || initialChances > 10) {
                    alert('初始抽奖机会必须在 1-10 之间');
                    return;
                }

                if (spinAgainBonus < 1 || spinAgainBonus > 5) {
                    alert('"再来一次"奖励机会必须在 1-5 之间');
                    return;
                }

                if (maxChances < 5 || maxChances > 50) {
                    alert('最大累积机会数必须在 5-50 之间');
                    return;
                }

                // 保存配置到数据库
                const configData = {
                    INITIAL_CHANCES: initialChances,
                    SPIN_AGAIN_BONUS: spinAgainBonus,
                    MAX_ACCUMULATED_CHANCES: maxChances,
                    DAILY_FREE_CHANCES: 1,
                    ENABLE_DAILY_FREE: false,
                    ALLOW_ADMIN_ADD_CHANCES: true
                };

                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'lottery_config',
                        value: JSON.stringify(configData),
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('⚙️ 抽奖配置已保存', 'success');
                alert('抽奖配置保存成功！\n\n注意：新配置将在下次用户注册时生效。');

                // 更新系统状态显示
                updateSystemStatus();

            } catch (error) {
                addLog(`❌ 保存抽奖配置失败: ${error.message}`, 'error');
                alert(`保存失败: ${error.message}`);
            }
        }

        // 加载抽奖配置
        async function loadLotteryConfig() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'lottery_config')
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 表示没有找到记录
                    throw error;
                }

                let config = {
                    INITIAL_CHANCES: 1,
                    SPIN_AGAIN_BONUS: 1,
                    MAX_ACCUMULATED_CHANCES: 10
                };

                if (data && data.value) {
                    try {
                        config = JSON.parse(data.value);
                    } catch (parseError) {
                        addLog('⚠️ 配置数据格式错误，使用默认配置', 'warning');
                    }
                }

                // 更新界面显示
                document.getElementById('initial-chances').value = config.INITIAL_CHANCES || 1;
                document.getElementById('spin-again-bonus').value = config.SPIN_AGAIN_BONUS || 1;
                document.getElementById('max-chances').value = config.MAX_ACCUMULATED_CHANCES || 10;

                addLog('🔄 抽奖配置已重新加载', 'info');
                updateSystemStatus();

            } catch (error) {
                addLog(`❌ 加载抽奖配置失败: ${error.message}`, 'error');
                // 使用默认值
                document.getElementById('initial-chances').value = 1;
                document.getElementById('spin-again-bonus').value = 1;
                document.getElementById('max-chances').value = 10;
            }
        }

        // 更新系统状态显示
        async function updateSystemStatus() {
            try {
                // 检查数据库连接
                const { error: dbError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                const dbStatus = document.getElementById('db-status');
                if (dbError) {
                    dbStatus.textContent = '连接异常';
                    dbStatus.className = 'text-red-400';
                } else {
                    dbStatus.textContent = '已连接';
                    dbStatus.className = 'text-green-400';
                }

                // 检查实时连接状态
                const realtimeStatus = document.getElementById('realtime-status');
                if (realtimeChannel && realtimeChannel.state === 'joined') {
                    realtimeStatus.textContent = '已启用';
                    realtimeStatus.className = 'text-green-400';
                } else {
                    realtimeStatus.textContent = '未连接';
                    realtimeStatus.className = 'text-yellow-400';
                }

                // 抽奖系统状态
                const lotteryStatus = document.getElementById('lottery-status');
                lotteryStatus.textContent = '正常运行';
                lotteryStatus.className = 'text-green-400';

            } catch (error) {
                addLog(`❌ 更新系统状态失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时加载配置
        window.addEventListener('load', function() {
            setTimeout(async () => {
                await loadLotteryConfig();
            }, 1500);
        });
    </script>
</body>
</html>