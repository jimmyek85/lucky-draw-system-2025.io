<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ æŠ½å¥–è½®ç›˜ç³»ç»Ÿ - ç®¡ç†å‘˜é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .admin-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .data-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- åŠ è½½ Supabase é…ç½® - ç¡®ä¿ä¸ç”¨æˆ·ç«¯ç»Ÿä¸€ -->
    <script src="supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <div class="container mx-auto px-4 py-8">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-blue-400">ğŸ¯ æŠ½å¥–è½®ç›˜ç³»ç»Ÿ</h1>
                <p class="text-gray-300 mt-2">ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ - Supabase äº‘æœåŠ¡å™¨</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <span id="connection-indicator" class="status-indicator status-offline"></span>
                    <span id="connection-status" class="text-sm">è¿æ¥ä¸­...</span>
                </div>
                <button onclick="window.open('index.html', '_blank')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    ğŸ® ç”¨æˆ·ç«¯
                </button>
                <button onclick="window.open('supabase-connection-validator.html', '_blank')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    ğŸ”§ è¿æ¥éªŒè¯å™¨
                </button>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">æ€»ç”¨æˆ·æ•°</p>
                        <p id="total-users" class="text-2xl font-bold text-blue-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ‘¥</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">ä»Šæ—¥æ³¨å†Œ</p>
                        <p id="today-registrations" class="text-2xl font-bold text-green-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ“ˆ</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">ä»Šæ—¥å‚ä¸è€…</p>
                        <p id="today-participants" class="text-2xl font-bold text-purple-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ¯</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">æ€»æŠ½å¥–æ¬¡æ•°</p>
                        <p id="total-draws" class="text-2xl font-bold text-yellow-400">-</p>
                    </div>
                    <div class="text-3xl">ğŸ²</div>
                </div>
            </div>
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">ç³»ç»ŸçŠ¶æ€</p>
                        <p id="system-status" class="text-2xl font-bold text-green-400">æ­£å¸¸</p>
                    </div>
                    <div class="text-3xl">âš¡</div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ç”¨æˆ·æœç´¢å’Œç®¡ç† -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-400">ğŸ‘¥ ç”¨æˆ·æœç´¢ä¸ç®¡ç†</h3>
                    <button onclick="refreshUserData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="mb-6">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·åæˆ–ç”µè¯å·ç ..." 
                                   class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                        </div>
                        <button onclick="searchUsers()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            æœç´¢
                        </button>
                        <button onclick="clearSearch()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            æ¸…é™¤
                        </button>
                    </div>
                </div>

                <div class="data-table">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="text-left p-2">å§“å</th>
                                <th class="text-left p-2">ç”µè¯</th>
                                <th class="text-left p-2">æ³¨å†Œæ—¶é—´</th>
                                <th class="text-left p-2">æŠ½å¥–æ¬¡æ•°</th>
                                <th class="text-left p-2">è·å¾—å¥–å“</th>
                                <th class="text-left p-2">å‰©ä½™æœºä¼š</th>
                                <th class="text-left p-2">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="users-table" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="7" class="text-center p-4 text-gray-400">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æŠ½å¥–è®¾ç½® -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-green-400 mb-4">ğŸ® æŠ½å¥–è®¾ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">å¥–å“é…ç½®ï¼ˆç®€å•æ ¼å¼ï¼‰</label>
                        <div class="text-sm text-gray-400 mb-2">
                            æ ¼å¼ï¼šå¥–å“åç§° æ¦‚ç‡%ï¼ˆæ¯è¡Œä¸€ä¸ªå¥–å“ï¼‰<br>
                            ä¾‹å¦‚ï¼š1602 mug 1%ï¼Œ1602 Pen 15%ï¼ŒCash Voucher RM5 18%
                        </div>
                        <textarea id="prizes-simple-config" rows="8" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white" 
                                  placeholder="1602 Mug 1%&#10;1602 Pen 15%&#10;Cash Voucher RM5 18%&#10;Online Voucher RM10 7%&#10;Online Voucher RM20 5%&#10;Free 660ml Bottle 8%&#10;New 330ml Can 12%&#10;Cooler Bag 7%&#10;Wine Card 0%&#10;Spin Again! 9%&#10;Thank You 18%"></textarea>
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <h4 class="text-sm font-medium text-gray-300 mb-2">å½“å‰æ¦‚ç‡æ€»è®¡ï¼š<span id="total-percentage" class="text-yellow-400">0%</span></h4>
                        <div class="text-xs text-gray-400">å»ºè®®æ€»è®¡ä¸º100%ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒæ•´</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="updatePrizesSimple()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1">
                            ğŸ’¾ ä¿å­˜è®¾ç½®
                        </button>
                        <button onclick="resetPrizesSimple()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            ğŸ”„ é‡ç½®ä¸ºé»˜è®¤
                        </button>
                        <button onclick="validatePrizes()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            âœ… éªŒè¯é…ç½®
                        </button>
                    </div>
                    
                    <!-- é«˜çº§é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
                    <div class="mt-4">
                        <button onclick="toggleAdvancedConfig()" class="text-sm text-blue-400 hover:text-blue-300">
                            ğŸ”§ æ˜¾ç¤ºé«˜çº§JSONé…ç½®
                        </button>
                        <div id="advanced-config" class="hidden mt-3">
                            <label class="block text-sm font-medium text-gray-300 mb-2">JSONé…ç½®ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰</label>
                            <textarea id="prizes-json-config" rows="6" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-xs" 
                                      placeholder="è‡ªåŠ¨ç”Ÿæˆçš„JSONé…ç½®..." readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¬å‘Šæ ç®¡ç† -->
        <div class="admin-card bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-green-400 mb-4">ğŸ“¢ å…¬å‘Šæ ç®¡ç†</h3>
            
            <!-- å‘å¸ƒæ–°å…¬å‘Š -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">å‘å¸ƒæ–°å…¬å‘Š</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">å…¬å‘Šæ ‡é¢˜</label>
                        <input type="text" id="announcement-title" placeholder="è¾“å…¥å…¬å‘Šæ ‡é¢˜..." 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">å…¬å‘Šå†…å®¹</label>
                        <textarea id="announcement-content" rows="4" placeholder="è¾“å…¥å…¬å‘Šå†…å®¹..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-green-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ä¸Šä¼ å›¾ç‰‡/æµ·æŠ¥</label>
                        <input type="file" id="announcement-image" accept="image/*" 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="publishAnnouncement()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            ğŸ“¢ å‘å¸ƒå…¬å‘Š
                        </button>
                        <button onclick="clearAnnouncementForm()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            æ¸…é™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- å…¬å‘Šåˆ—è¡¨ -->
            <div>
                <h4 class="text-lg font-semibold text-white mb-3">å·²å‘å¸ƒå…¬å‘Š</h4>
                <div id="announcements-list" class="space-y-4">
                    <!-- å…¬å‘Šåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- å†…å®¹ç®¡ç† -->
        <div class="admin-card bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-blue-400 mb-4">ğŸ“ å†…å®¹ç®¡ç†</h3>
            
            <!-- é¢†å¥–T&Cç®¡ç† -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">ğŸ† é¢†å¥–æ¡æ¬¾ä¸æ¡ä»¶ (T&C)</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">é¢†å¥–æ¡æ¬¾å†…å®¹</label>
                        <textarea id="terms-content" rows="6" placeholder="è¾“å…¥é¢†å¥–æ¡æ¬¾ä¸æ¡ä»¶..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"></textarea>
                    </div>
                    <button onclick="updateTermsConditions()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        ğŸ’¾ ä¿å­˜é¢†å¥–æ¡æ¬¾
                    </button>
                </div>
            </div>

            <!-- ä¼˜æƒ å¥—é¤ç®¡ç† -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">ğŸ‰ ä¼˜æƒ å¥—é¤å†…å®¹</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ä¼˜æƒ å¥—é¤è¯¦æƒ…</label>
                        <textarea id="promotion-content" rows="8" 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-orange-500">ğŸ‰ğŸ‰ğŸ‰ç‰¹ä»·ä¼˜æƒ ğŸ‰ğŸ‰ğŸ‰
ï¼ˆå‘¨ä¸€è‡³å‘¨å››ï¼‰ monday to thursdayï¼š
æ¶ˆè´¹æ»¡55ä»¤å‰ä»¥ä¸Š(ä»¥ä¸€å¼ å•æ®ä¸ºå‡†)å¯ä»¥8ä»¤å‰ä¼˜æƒ ä»·è´­å¾—660mlç“¶è£…ç²¾é…¿å•¤é…’ (åªé™3ç“¶)
Spend RM55 or more (based on one receipt), you can purchase 660ml bottles of craft beer at a discounted price of RM8 (limited to 3 bottles)</textarea>
                    </div>
                    <button onclick="updatePromotionContent()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                        ğŸ’¾ ä¿å­˜ä¼˜æƒ å¥—é¤
                    </button>
                </div>
            </div>
        </div>

        <!-- äº§å“çŸ¥è¯†åº“ç®¡ç† -->
        <div class="admin-card bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-purple-400 mb-4">ğŸ“š AIå•¤é…’æ¨èçŸ¥è¯†åº“</h3>
            
            <!-- æ·»åŠ æ–°çŸ¥è¯† -->
            <div class="mb-6 p-4 bg-gray-700 rounded-lg">
                <h4 class="text-lg font-semibold text-white mb-3">æ·»åŠ äº§å“çŸ¥è¯†</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">äº§å“åç§°</label>
                        <input type="text" id="knowledge-title" placeholder="è¾“å…¥äº§å“åç§°..." 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                    </div>
                    <input type="hidden" id="knowledge-category" value="beer">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">äº§å“æè¿°</label>
                        <textarea id="knowledge-description" rows="4" placeholder="è¾“å…¥è¯¦ç»†çš„äº§å“æè¿°..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">äº§å“ç‰¹ç‚¹</label>
                        <textarea id="knowledge-features" rows="3" placeholder="è¾“å…¥äº§å“ç‰¹ç‚¹ï¼ˆæ¯è¡Œä¸€ä¸ªç‰¹ç‚¹ï¼‰..." 
                                  class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"></textarea>
                    </div>
                    <input type="hidden" id="knowledge-price" value="0">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ä¸Šä¼ äº§å“å›¾ç‰‡</label>
                        <input type="file" id="knowledge-images" accept="image/*" multiple 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ä¸Šä¼ äº§å“æ–‡æ¡£</label>
                        <input type="file" id="knowledge-documents" accept=".pdf,.doc,.docx,.txt" multiple 
                               class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="addKnowledge()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                            ğŸ“š æ·»åŠ çŸ¥è¯†
                        </button>
                        <button onclick="clearKnowledgeForm()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            æ¸…é™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- çŸ¥è¯†åº“åˆ—è¡¨ -->
            <div>
                <h4 class="text-lg font-semibold text-white mb-3">çŸ¥è¯†åº“å†…å®¹</h4>
                <div class="mb-4">
                    <input type="text" id="knowledge-search" placeholder="æœç´¢äº§å“çŸ¥è¯†..." 
                           class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                </div>
                <div id="knowledge-list" class="space-y-4">
                    <!-- çŸ¥è¯†åº“åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- å®æ—¶ç›‘æ§ -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">ğŸ“Š å®æ—¶ç›‘æ§</h3>
                <div id="realtime-logs" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto text-sm">
                    <div class="text-gray-400">ç­‰å¾…å®æ—¶æ•°æ®...</div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="clearLogs()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                    </button>
                    <button onclick="exportLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ğŸ“¥ å¯¼å‡ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- æ•°æ®åˆ†æ -->
            <div class="admin-card bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-purple-400 mb-4">ğŸ“ˆ æ•°æ®åˆ†æ</h3>
                <div class="space-y-4">
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-blue-300 mb-2">ç”¨æˆ·æ³¨å†Œè¶‹åŠ¿</h4>
                        <div id="registration-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            å›¾è¡¨åŠ è½½ä¸­...
                        </div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-bold text-green-300 mb-2">æŠ½å¥–æ´»è·ƒåº¦</h4>
                        <div id="activity-chart" class="h-32 bg-gray-800 rounded flex items-center justify-center text-gray-400">
                            å›¾è¡¨åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿé…ç½® -->
        <div class="mt-8 admin-card bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold text-purple-400 mb-4">âš™ï¸ ç³»ç»Ÿé…ç½®</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- æŠ½å¥–æœºä¼šé…ç½® -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-white mb-3">ğŸ¯ æŠ½å¥–æœºä¼šé…ç½®</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æ–°ç”¨æˆ·åˆå§‹æŠ½å¥–æœºä¼š</label>
                            <input type="number" id="initial-chances" min="1" max="10" value="1" 
                                   class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                            <div class="text-xs text-gray-400 mt-1">å»ºè®®è®¾ç½®ä¸º 1-5 æ¬¡</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">"å†æ¥ä¸€æ¬¡"å¥–åŠ±æœºä¼š</label>
                            <input type="number" id="spin-again-bonus" min="1" max="5" value="1" 
                                   class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æœ€å¤§ç´¯ç§¯æœºä¼šæ•°</label>
                            <input type="number" id="max-chances" min="5" max="50" value="10" 
                                   class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                        </div>
                        <button onclick="saveLotteryConfig()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                            ğŸ’¾ ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>
                
                <!-- ç³»ç»ŸçŠ¶æ€é…ç½® -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-white mb-3">ğŸ”§ ç³»ç»ŸçŠ¶æ€</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">æŠ½å¥–ç³»ç»ŸçŠ¶æ€</span>
                            <span id="lottery-status" class="text-green-400">æ­£å¸¸è¿è¡Œ</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">æ•°æ®åº“è¿æ¥</span>
                            <span id="db-status" class="text-green-400">å·²è¿æ¥</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">å®æ—¶åŒæ­¥</span>
                            <span id="realtime-status" class="text-green-400">å·²å¯ç”¨</span>
                        </div>
                        <button onclick="loadLotteryConfig()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
                            ğŸ”„ é‡æ–°åŠ è½½é…ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿå·¥å…· -->
        <div class="mt-8 admin-card bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold text-red-400 mb-4">ğŸ”§ ç³»ç»Ÿå·¥å…·</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="backupDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded text-center">
                    ğŸ’¾ æ•°æ®å¤‡ä»½
                </button>
                <button onclick="clearCache()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded text-center">
                    ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜
                </button>
                <button onclick="systemDiagnostic()" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded text-center">
                    ğŸ” ç³»ç»Ÿè¯Šæ–­
                </button>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let realtimeChannel = null;
        const logs = [];

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ - ä½¿ç”¨ä¸ç”¨æˆ·ç«¯ç›¸åŒçš„é…ç½®
        async function initializeSupabase() {
            try {
                if (!window.SUPABASE_CONFIG) {
                    throw new Error('Supabase é…ç½®æœªæ‰¾åˆ°');
                }

                const config = window.SUPABASE_CONFIG;
                
                // éªŒè¯é…ç½®
                if (!config.SUPABASE_URL || config.SUPABASE_URL === 'https://your-project-id.supabase.co') {
                    throw new Error('Supabase URL æœªæ­£ç¡®é…ç½®');
                }
                
                if (!config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === 'your-supabase-anon-key-here') {
                    throw new Error('Supabase API Key æœªæ­£ç¡®é…ç½®');
                }

                // åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œä¼˜åŒ–å®æ—¶è¿æ¥é…ç½®
                supabase = window.supabase.createClient(
                    config.SUPABASE_URL,
                    config.SUPABASE_ANON_KEY,
                    {
                        auth: {
                            persistSession: false,
                            autoRefreshToken: true
                        },
                        realtime: {
                            params: {
                                eventsPerSecond: 10
                            },
                            heartbeatIntervalMs: 30000,
                            reconnectAfterMs: function(tries) {
                                return Math.min(tries * 1000, 30000);
                            }
                        },
                        db: {
                            schema: 'public'
                        },
                        global: {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        }
                    }
                );

                updateConnectionStatus('online', 'å·²è¿æ¥åˆ° Supabase äº‘æœåŠ¡å™¨');
                addLog('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è®¾ç½®å®æ—¶ç›‘å¬
                setupRealtimeSubscription();
                
                // åŠ è½½åˆå§‹æ•°æ®
                await loadDashboardData();
                
                return true;
            } catch (error) {
                updateConnectionStatus('offline', `è¿æ¥å¤±è´¥: ${error.message}`);
                addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connection-indicator');
            const statusText = document.getElementById('connection-status');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = message;
        }

        // è®¾ç½®å®æ—¶è®¢é˜…
        function setupRealtimeSubscription() {
            if (!supabase) return;

            try {
                realtimeChannel = supabase
                    .channel('admin-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'users' },
                        (payload) => {
                            addLog(`ğŸ‘¥ ç”¨æˆ·æ•°æ®æ›´æ–°: ${payload.eventType}`, 'info');
                            refreshUserData();
                        }
                    )
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'settings' },
                        (payload) => {
                            addLog(`âš™ï¸ è®¾ç½®æ›´æ–°: ${payload.eventType}`, 'info');
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            addLog('ğŸ“¡ å®æ—¶ç›‘å¬å·²å¯åŠ¨', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            addLog('âŒ å®æ—¶ç›‘å¬è¿æ¥å¤±è´¥', 'error');
                        }
                    });
            } catch (error) {
                addLog(`âŒ å®æ—¶è®¢é˜…è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
                await loadUserStats();
                
                // åŠ è½½ç”¨æˆ·åˆ—è¡¨
                await refreshUserData();
                
                // åŠ è½½å¥–å“é…ç½®
                await loadPrizesConfig();
                
                // åŠ è½½å…¬å‘Šåˆ—è¡¨
                await loadAnnouncements();
                
                // åŠ è½½çŸ¥è¯†åº“
                await loadKnowledge();
                
                // åŠ è½½å†…å®¹ç®¡ç†æ•°æ®
                await loadContentManagement();
                
                addLog('ğŸ“Š ä»ªè¡¨æ¿æ•°æ®åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                addLog(`âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
        async function loadUserStats() {
            try {
                const { count: totalUsers, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (usersError) throw usersError;

                document.getElementById('total-users').textContent = totalUsers || 0;

                // ä»Šæ—¥æ³¨å†Œæ•°
                const today = new Date().toISOString().split('T')[0];
                const { count: todayCount, error: todayError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today);

                if (!todayError) {
                    document.getElementById('today-registrations').textContent = todayCount || 0;
                }

                // ä»Šæ—¥å‚ä¸è€…æ•°ï¼ˆä»Šå¤©æœ‰æŠ½å¥–è®°å½•çš„ç”¨æˆ·ï¼‰
                try {
                    const { data: todayParticipants, error: participantsError } = await supabase
                        .from('users')
                        .select('id')
                        .gte('last_draw_date', today);

                    if (!participantsError) {
                        document.getElementById('today-participants').textContent = todayParticipants?.length || 0;
                    } else {
                        document.getElementById('today-participants').textContent = '0';
                    }
                } catch (e) {
                    document.getElementById('today-participants').textContent = '0';
                }

                // æŠ½å¥–æ¬¡æ•°ç»Ÿè®¡ï¼ˆä»ç”¨æˆ·è¡¨çš„ draw_count å­—æ®µï¼‰
                const { data: drawData, error: drawError } = await supabase
                    .from('users')
                    .select('draw_count');

                if (!drawError && drawData) {
                    const totalDraws = drawData.reduce((sum, user) => sum + (user.draw_count || 0), 0);
                    document.getElementById('total-draws').textContent = totalDraws;
                }

            } catch (error) {
                addLog(`âŒ ç”¨æˆ·ç»Ÿè®¡åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                // è®¾ç½®é»˜è®¤å€¼
                document.getElementById('total-users').textContent = '0';
                document.getElementById('today-registrations').textContent = '0';
                document.getElementById('today-participants').textContent = '0';
                document.getElementById('total-draws').textContent = '0';
            }
        }

        // åˆ·æ–°ç”¨æˆ·æ•°æ®
        async function refreshUserData() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const tbody = document.getElementById('users-table');
                tbody.innerHTML = '';

                if (users && users.length > 0) {
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-700';
                        row.innerHTML = `
                            <td class="p-2">${user.name || '-'}</td>
                            <td class="p-2">${user.phone || '-'}</td>
                            <td class="p-2">${new Date(user.created_at).toLocaleString()}</td>
                            <td class="p-2">
                                <span class="px-2 py-1 rounded text-xs ${user.is_active ? 'bg-green-600' : 'bg-gray-600'}">
                                    ${user.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                }

                addLog(`ğŸ“Š ç”¨æˆ·æ•°æ®å·²åˆ·æ–°ï¼Œå…± ${users.length} æ¡è®°å½•`, 'info');
            } catch (error) {
                addLog(`âŒ ç”¨æˆ·æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¥–å“é¢œè‰²é…ç½®
        const prizeColors = [
            "#fde047", "#4b5563", "#60a5fa", "#ef4444", "#a78bfa", 
            "#f97316", "#22c55e", "#ec4899", "#d946ef", "#14b8a6", "#84cc16"
        ];

        // åŠ è½½å¥–å“é…ç½®
        async function loadPrizesConfig() {
            try {
                const { data: settings, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'prizes_config')
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                const simpleTextarea = document.getElementById('prizes-simple-config');
                const jsonTextarea = document.getElementById('prizes-json-config');
                
                if (settings && settings.value) {
                    // å°†JSONé…ç½®è½¬æ¢ä¸ºç®€å•æ ¼å¼
                    const prizes = settings.value.prizes || settings.value;
                    const simpleFormat = prizes.map(prize => 
                        `${prize.name || prize.text} ${(prize.percentage || prize.probability * 100)}%`
                    ).join('\n');
                    
                    simpleTextarea.value = simpleFormat;
                    if (jsonTextarea) jsonTextarea.value = JSON.stringify(settings.value, null, 2);
                } else {
                    // é»˜è®¤å¥–å“é…ç½®
                    const defaultSimpleConfig = `1602 Mug 1%
1602 Pen 15%
Cash Voucher RM5 18%
Online Voucher RM10 7%
Online Voucher RM20 5%
Free 660ml Bottle 8%
New 330ml Can 12%
Cooler Bag 7%
Wine Card 0%
Spin Again! 9%
Thank You 18%`;
                    simpleTextarea.value = defaultSimpleConfig;
                    updateJsonFromSimple();
                }
                
                calculateTotalPercentage();
            } catch (error) {
                addLog(`âŒ å¥–å“é…ç½®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function parseSimpleConfig(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const prizes = [];
            
            lines.forEach((line, index) => {
                const match = line.trim().match(/^(.+?)\s+(\d+(?:\.\d+)?)%$/);
                if (match) {
                    const name = match[1].trim();
                    const percentage = parseFloat(match[2]);
                    const color = prizeColors[index % prizeColors.length];
                    
                    prizes.push({
                        text: name,
                        name: name,
                        percentage: percentage,
                        probability: percentage / 100,
                        color: color
                    });
                }
            });
            
            return prizes;
        }

        function updateJsonFromSimple() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                
                const config = {
                    prizes: prizes,
                    updated_at: new Date().toISOString()
                };
                
                const jsonTextarea = document.getElementById('prizes-json-config');
                if (jsonTextarea) jsonTextarea.value = JSON.stringify(config, null, 2);
                calculateTotalPercentage();
            } catch (error) {
                console.error('è§£æç®€å•é…ç½®å¤±è´¥:', error);
            }
        }

        function calculateTotalPercentage() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                const total = prizes.reduce((sum, prize) => sum + prize.percentage, 0);
                
                const totalElement = document.getElementById('total-percentage');
                if (totalElement) {
                    totalElement.textContent = `${total.toFixed(1)}%`;
                    
                    // æ ¹æ®æ€»è®¡æ”¹å˜é¢œè‰²
                    if (total === 100) {
                        totalElement.className = 'text-green-400';
                    } else if (total > 95 && total < 105) {
                        totalElement.className = 'text-yellow-400';
                    } else {
                        totalElement.className = 'text-red-400';
                    }
                }
            } catch (error) {
                const totalElement = document.getElementById('total-percentage');
                if (totalElement) {
                    totalElement.textContent = 'é”™è¯¯';
                    totalElement.className = 'text-red-400';
                }
            }
        }

        async function updatePrizesSimple() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                
                if (prizes.length === 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å¥–å“é…ç½®');
                }
                
                const config = {
                    prizes: prizes,
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'prizes_config',
                        value: config,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                updateJsonFromSimple();
                addLog('âœ… å¥–å“é…ç½®å·²ä¿å­˜', 'success');
                alert('å¥–å“é…ç½®ä¿å­˜æˆåŠŸï¼å‰ç«¯å°†åœ¨ä¸‹æ¬¡åˆ·æ–°æ—¶æ›´æ–°ã€‚');
            } catch (error) {
                addLog(`âŒ å¥–å“é…ç½®ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        function validatePrizes() {
            try {
                const simpleText = document.getElementById('prizes-simple-config').value;
                const prizes = parseSimpleConfig(simpleText);
                
                if (prizes.length === 0) {
                    alert('âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å¥–å“é…ç½®');
                    return;
                }
                
                const total = prizes.reduce((sum, prize) => sum + prize.percentage, 0);
                const duplicates = prizes.filter((prize, index, arr) => 
                    arr.findIndex(p => p.name === prize.name) !== index
                );
                
                let message = `âœ… é…ç½®éªŒè¯ç»“æœ:\n`;
                message += `- å¥–å“æ•°é‡: ${prizes.length}\n`;
                message += `- æ¦‚ç‡æ€»è®¡: ${total.toFixed(1)}%\n`;
                
                if (duplicates.length > 0) {
                    message += `âš ï¸ å‘ç°é‡å¤å¥–å“: ${duplicates.map(d => d.name).join(', ')}\n`;
                }
                
                if (total !== 100) {
                    message += `âš ï¸ æ¦‚ç‡æ€»è®¡ä¸ç­‰äº100%ï¼Œå»ºè®®è°ƒæ•´\n`;
                }
                
                message += `\nå¥–å“åˆ—è¡¨:\n`;
                prizes.forEach(prize => {
                    message += `- ${prize.name}: ${prize.percentage}%\n`;
                });
                
                alert(message);
                updateJsonFromSimple();
            } catch (error) {
                alert(`âŒ éªŒè¯å¤±è´¥: ${error.message}`);
            }
        }

        function resetPrizesSimple() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¥–å“é…ç½®å—ï¼Ÿ')) {
                const defaultConfig = `1602 Mug 1%
1602 Pen 15%
Cash Voucher RM5 18%
Online Voucher RM10 7%
Online Voucher RM20 5%
Free 660ml Bottle 8%
New 330ml Can 12%
Cooler Bag 7%
Wine Card 0%
Spin Again! 9%
Thank You 18%`;
                
                document.getElementById('prizes-simple-config').value = defaultConfig;
                updateJsonFromSimple();
                addLog('ğŸ”„ å¥–å“é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤', 'info');
            }
        }

        function toggleAdvancedConfig() {
            const advancedDiv = document.getElementById('advanced-config');
            const button = event.target;
            
            if (advancedDiv.classList.contains('hidden')) {
                advancedDiv.classList.remove('hidden');
                button.textContent = 'ğŸ”§ éšè—é«˜çº§JSONé…ç½®';
                updateJsonFromSimple();
            } else {
                advancedDiv.classList.add('hidden');
                button.textContent = 'ğŸ”§ æ˜¾ç¤ºé«˜çº§JSONé…ç½®';
            }
        }

        // æ›´æ–°å¥–å“é…ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        async function updatePrizes() {
            return await updatePrizesSimple();
        }

        // é‡ç½®å¥–å“é…ç½®
        function resetPrizes() {
            if (confirm('ç¡®å®šè¦é‡ç½®å¥–å“é…ç½®å—ï¼Ÿ')) {
                loadPrizesConfig();
                addLog('ğŸ”„ å¥–å“é…ç½®å·²é‡ç½®', 'info');
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logs.push(logEntry);

            const logsContainer = document.getElementById('realtime-logs');
            const logElement = document.createElement('div');
            logElement.className = `mb-1 ${type === 'success' ? 'text-green-400' : 
                                           type === 'error' ? 'text-red-400' : 
                                           type === 'warning' ? 'text-yellow-400' : 'text-blue-400'}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // ä¿æŒæœ€å¤š100æ¡æ—¥å¿—
            if (logs.length > 100) {
                logs.shift();
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logs.length = 0;
            document.getElementById('realtime-logs').innerHTML = '<div class="text-gray-400">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logText = logs.map(log => `[${log.timestamp}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ•°æ®å¤‡ä»½
        async function backupDatabase() {
            try {
                addLog('ğŸ’¾ å¼€å§‹æ•°æ®å¤‡ä»½...', 'info');
                
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('*');

                const { data: settings, error: settingsError } = await supabase
                    .from('settings')
                    .select('*');

                if (usersError || settingsError) {
                    throw new Error('æ•°æ®è¯»å–å¤±è´¥');
                }

                const backup = {
                    timestamp: new Date().toISOString(),
                    users: users || [],
                    settings: settings || []
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `database-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                addLog('âœ… æ•°æ®å¤‡ä»½å®Œæˆ', 'success');
            } catch (error) {
                addLog(`âŒ æ•°æ®å¤‡ä»½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç†ç¼“å­˜
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç†ç³»ç»Ÿç¼“å­˜å—ï¼Ÿ')) {
                localStorage.clear();
                sessionStorage.clear();
                addLog('ğŸ—‘ï¸ ç³»ç»Ÿç¼“å­˜å·²æ¸…ç†', 'info');
                alert('ç¼“å­˜æ¸…ç†å®Œæˆï¼');
            }
        }

        // ç³»ç»Ÿè¯Šæ–­
        async function systemDiagnostic() {
            addLog('ğŸ” å¼€å§‹ç³»ç»Ÿè¯Šæ–­...', 'info');
            
            try {
                // æ£€æŸ¥æ•°æ®åº“è¿æ¥
                const { error: dbError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                if (dbError) {
                    addLog('âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸', 'error');
                } else {
                    addLog('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
                }

                // æ£€æŸ¥å®æ—¶è¿æ¥
                if (realtimeChannel && realtimeChannel.state === 'joined') {
                    addLog('âœ… å®æ—¶è¿æ¥æ­£å¸¸', 'success');
                } else {
                    addLog('âš ï¸ å®æ—¶è¿æ¥å¼‚å¸¸', 'warning');
                }

                // æ£€æŸ¥é…ç½®
                if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.SUPABASE_URL) {
                    addLog('âœ… é…ç½®æ–‡ä»¶æ­£å¸¸', 'success');
                } else {
                    addLog('âŒ é…ç½®æ–‡ä»¶å¼‚å¸¸', 'error');
                }

                addLog('ğŸ” ç³»ç»Ÿè¯Šæ–­å®Œæˆ', 'info');
            } catch (error) {
                addLog(`âŒ ç³»ç»Ÿè¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async function() {
            addLog('ğŸš€ ç®¡ç†å‘˜é¢æ¿å¯åŠ¨ä¸­...', 'info');
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬å·²åŠ è½½
            setTimeout(async () => {
                const success = await initializeSupabase();
                if (success) {
                    addLog('âœ… ç®¡ç†å‘˜é¢æ¿åˆå§‹åŒ–å®Œæˆ', 'success');
                } else {
                    addLog('âŒ ç®¡ç†å‘˜é¢æ¿åˆå§‹åŒ–å¤±è´¥', 'error');
                }
            }, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            if (realtimeChannel && supabase) {
                supabase.removeChannel(realtimeChannel);
            }
        });

        // æœç´¢ç”¨æˆ·
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.trim();
            if (!searchTerm) {
                await refreshUserData();
                return;
            }

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayUsers(users);
                addLog(`ğŸ” æœç´¢ç”¨æˆ·: "${searchTerm}", æ‰¾åˆ° ${users.length} æ¡ç»“æœ`, 'info');
            } catch (error) {
                addLog(`âŒ æœç´¢ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('user-search').value = '';
            refreshUserData();
        }

        // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
         function displayUsers(users) {
             const tbody = document.getElementById('users-table');
             tbody.innerHTML = '';
 
             if (users && users.length > 0) {
                 users.forEach(user => {
                     // å¤„ç†å¥–å“è®°å½•æ˜¾ç¤º
                     let prizesDisplay = '-';
                     if (user.prizeswon && Array.isArray(user.prizeswon) && user.prizeswon.length > 0) {
                         prizesDisplay = user.prizeswon.map(prize => {
                             if (typeof prize === 'string') {
                                 return prize;
                             } else if (prize.prize) {
                                 return prize.prize;
                             } else if (prize.name) {
                                 return prize.name;
                             }
                             return JSON.stringify(prize);
                         }).join(', ');
                         
                         // å¦‚æœå¥–å“å¤ªé•¿ï¼Œæˆªæ–­æ˜¾ç¤º
                         if (prizesDisplay.length > 50) {
                             prizesDisplay = prizesDisplay.substring(0, 50) + '...';
                         }
                     } else if (user.prizes_won && Array.isArray(user.prizes_won) && user.prizes_won.length > 0) {
                         prizesDisplay = user.prizes_won.map(prize => {
                             if (typeof prize === 'string') {
                                 return prize;
                             } else if (prize.prize) {
                                 return prize.prize;
                             } else if (prize.name) {
                                 return prize.name;
                             }
                             return JSON.stringify(prize);
                         }).join(', ');
                         
                         if (prizesDisplay.length > 50) {
                             prizesDisplay = prizesDisplay.substring(0, 50) + '...';
                         }
                     }

                     const row = document.createElement('tr');
                     row.className = 'hover:bg-gray-700';
                     row.innerHTML = `
                         <td class="p-2">${user.name || '-'}</td>
                         <td class="p-2">${user.phone || '-'}</td>
                         <td class="p-2">${new Date(user.created_at || user.joindate).toLocaleString()}</td>
                         <td class="p-2">${user.draw_count || user.total_spins || 0}</td>
                         <td class="p-2" title="${prizesDisplay}">${prizesDisplay}</td>
                         <td class="p-2">${user.remaining_chances || 0}</td>
                         <td class="p-2">
                             <button onclick="viewUserPrizes('${user.id}', '${user.name}')" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs mr-1">
                                 æŸ¥çœ‹å¥–å“
                             </button>
                             <button onclick="addChance('${user.id}', '${user.name}')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs mr-1">
                                 +1æœºä¼š
                             </button>
                             <button onclick="editUser('${user.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">
                                 ç¼–è¾‘
                             </button>
                             <button onclick="deleteUser('${user.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                                 åˆ é™¤
                             </button>
                         </td>
                     `;
                     tbody.appendChild(row);
                 });
             } else {
                 tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-400">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
             }
         }

         // ä¸ºç”¨æˆ·æ·»åŠ æŠ½å¥–æœºä¼š
         async function addChance(userId, userName) {
             if (!confirm(`ç¡®å®šè¦ä¸ºç”¨æˆ· "${userName}" æ·»åŠ 1æ¬¡æŠ½å¥–æœºä¼šå—ï¼Ÿ`)) return;

             try {
                 // è·å–å½“å‰ç”¨æˆ·æ•°æ®
                 const { data: user, error: getUserError } = await supabase
                     .from('users')
                     .select('remaining_chances, extra_chances')
                     .eq('id', userId)
                     .single();

                 if (getUserError) throw getUserError;

                 // æ›´æ–°ç”¨æˆ·çš„å‰©ä½™æœºä¼šå’Œé¢å¤–æœºä¼š
                 const { error: updateError } = await supabase
                     .from('users')
                     .update({
                         remaining_chances: (user.remaining_chances || 0) + 1,
                         extra_chances: (user.extra_chances || 0) + 1,
                         updated_at: new Date().toISOString()
                     })
                     .eq('id', userId);

                 if (updateError) throw updateError;

                 addLog(`âœ… å·²ä¸ºç”¨æˆ· "${userName}" æ·»åŠ 1æ¬¡æŠ½å¥–æœºä¼š`, 'success');
                 
                 // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                 const searchTerm = document.getElementById('user-search').value.trim();
                 if (searchTerm) {
                     await searchUsers();
                 } else {
                     await refreshUserData();
                 }

                 alert(`æˆåŠŸä¸ºç”¨æˆ· "${userName}" æ·»åŠ 1æ¬¡æŠ½å¥–æœºä¼šï¼`);
             } catch (error) {
                 addLog(`âŒ æ·»åŠ æŠ½å¥–æœºä¼šå¤±è´¥: ${error.message}`, 'error');
                 alert(`æ·»åŠ å¤±è´¥: ${error.message}`);
             }
         }

         // ç¼–è¾‘ç”¨æˆ·
         async function editUser(userId) {
             try {
                 const { data: user, error } = await supabase
                     .from('users')
                     .select('*')
                     .eq('id', userId)
                     .single();

                 if (error) throw error;

                 const newName = prompt('ç”¨æˆ·å:', user.name || '');
                 if (newName === null) return;

                 const newPhone = prompt('ç”µè¯å·ç :', user.phone || '');
                 if (newPhone === null) return;

                 const newChances = prompt('å‰©ä½™æœºä¼š:', user.remaining_chances || 0);
                 if (newChances === null) return;

                 const { error: updateError } = await supabase
                     .from('users')
                     .update({
                         name: newName,
                         phone: newPhone,
                         remaining_chances: parseInt(newChances) || 0,
                         updated_at: new Date().toISOString()
                     })
                     .eq('id', userId);

                 if (updateError) throw updateError;

                 addLog(`âœ… ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°`, 'success');
                 
                 // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                 const searchTerm = document.getElementById('user-search').value.trim();
                 if (searchTerm) {
                     await searchUsers();
                 } else {
                     await refreshUserData();
                 }

                 alert('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
             } catch (error) {
                 addLog(`âŒ æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
                 alert(`æ›´æ–°å¤±è´¥: ${error.message}`);
             }
         }

         // åˆ é™¤ç”¨æˆ·
         async function deleteUser(userId) {
             if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

             try {
                 const { error } = await supabase
                     .from('users')
                     .delete()
                     .eq('id', userId);

                 if (error) throw error;

                 addLog('ğŸ—‘ï¸ ç”¨æˆ·å·²åˆ é™¤', 'info');
                 
                 // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                 const searchTerm = document.getElementById('user-search').value.trim();
                 if (searchTerm) {
                     await searchUsers();
                 } else {
                     await refreshUserData();
                 }

                 alert('ç”¨æˆ·åˆ é™¤æˆåŠŸï¼');
             } catch (error) {
                 addLog(`âŒ åˆ é™¤ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
                 alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
             }
         }

         // æŸ¥çœ‹ç”¨æˆ·å¥–å“è¯¦æƒ…
         async function viewUserPrizes(userId, userName) {
             try {
                 // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å’ŒæŠ½å¥–å†å²
                 const { data: user, error: userError } = await supabase
                     .from('users')
                     .select('*')
                     .eq('id', userId)
                     .single();

                 if (userError) throw userError;

                 // è·å–æŠ½å¥–å†å²è®°å½•
                 const { data: drawHistory, error: historyError } = await supabase
                     .from('draw_history')
                     .select('*')
                     .eq('user_id', userId)
                     .order('spin_date', { ascending: false });

                 // æ„å»ºå¥–å“è¯¦æƒ…æ˜¾ç¤º
                 let prizesContent = '';
                 
                 // æ˜¾ç¤ºç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                 prizesContent += `<div class="mb-4 p-4 bg-gray-700 rounded">
                     <h4 class="text-lg font-semibold text-white mb-2">ç”¨æˆ·ä¿¡æ¯</h4>
                     <p><strong>å§“å:</strong> ${user.name || '-'}</p>
                     <p><strong>ç”µè¯:</strong> ${user.phone || '-'}</p>
                     <p><strong>æ³¨å†Œæ—¶é—´:</strong> ${new Date(user.created_at || user.joindate).toLocaleString()}</p>
                     <p><strong>æ€»æŠ½å¥–æ¬¡æ•°:</strong> ${user.draw_count || user.total_spins || 0}</p>
                     <p><strong>å‰©ä½™æœºä¼š:</strong> ${user.remaining_chances || 0}</p>
                 </div>`;

                 // æ˜¾ç¤ºè·å¥–è®°å½•
                 prizesContent += `<div class="mb-4 p-4 bg-gray-700 rounded">
                     <h4 class="text-lg font-semibold text-white mb-2">ğŸ† è·å¥–è®°å½•</h4>`;

                 // ä»ç”¨æˆ·è¡¨çš„å¥–å“å­—æ®µæ˜¾ç¤º
                 if (user.prizeswon && Array.isArray(user.prizeswon) && user.prizeswon.length > 0) {
                     prizesContent += '<div class="mb-3"><h5 class="font-medium text-green-400">ç”¨æˆ·è¡¨è®°å½•:</h5><ul class="list-disc list-inside text-gray-300">';
                     user.prizeswon.forEach((prize, index) => {
                         let prizeText = '';
                         if (typeof prize === 'string') {
                             prizeText = prize;
                         } else if (prize.prize) {
                             prizeText = `${prize.prize} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else if (prize.name) {
                             prizeText = `${prize.name} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else {
                             prizeText = JSON.stringify(prize);
                         }
                         prizesContent += `<li>${prizeText}</li>`;
                     });
                     prizesContent += '</ul></div>';
                 } else if (user.prizes_won && Array.isArray(user.prizes_won) && user.prizes_won.length > 0) {
                     prizesContent += '<div class="mb-3"><h5 class="font-medium text-green-400">ç”¨æˆ·è¡¨è®°å½•:</h5><ul class="list-disc list-inside text-gray-300">';
                     user.prizes_won.forEach((prize, index) => {
                         let prizeText = '';
                         if (typeof prize === 'string') {
                             prizeText = prize;
                         } else if (prize.prize) {
                             prizeText = `${prize.prize} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else if (prize.name) {
                             prizeText = `${prize.name} (${new Date(prize.timestamp || prize.date).toLocaleString()})`;
                         } else {
                             prizeText = JSON.stringify(prize);
                         }
                         prizesContent += `<li>${prizeText}</li>`;
                     });
                     prizesContent += '</ul></div>';
                 }

                 // ä»æŠ½å¥–å†å²è¡¨æ˜¾ç¤º
                 if (!historyError && drawHistory && drawHistory.length > 0) {
                     prizesContent += '<div class="mb-3"><h5 class="font-medium text-blue-400">æŠ½å¥–å†å²è®°å½•:</h5><ul class="list-disc list-inside text-gray-300">';
                     drawHistory.forEach(record => {
                         const prizeText = record.prize_won || record.result || 'æœªçŸ¥å¥–å“';
                         const dateText = new Date(record.spin_date || record.created_at).toLocaleString();
                         prizesContent += `<li>${prizeText} - ${dateText}</li>`;
                     });
                     prizesContent += '</ul></div>';
                 }

                 if (!user.prizeswon?.length && !user.prizes_won?.length && (!drawHistory || drawHistory.length === 0)) {
                     prizesContent += '<p class="text-gray-400">è¯¥ç”¨æˆ·æš‚æ— è·å¥–è®°å½•</p>';
                 }

                 prizesContent += '</div>';

                 // æ˜¾ç¤ºæ¨¡æ€æ¡†
                 const modal = document.createElement('div');
                 modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                 modal.innerHTML = `
                     <div class="bg-gray-800 p-6 rounded-lg max-w-2xl max-h-96 overflow-y-auto">
                         <div class="flex justify-between items-center mb-4">
                             <h3 class="text-xl font-bold text-white">${userName} - å¥–å“è¯¦æƒ…</h3>
                             <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                 </svg>
                             </button>
                         </div>
                         <div class="text-gray-300">
                             ${prizesContent}
                         </div>
                     </div>
                 `;
                 document.body.appendChild(modal);

                 addLog(`ğŸ” æŸ¥çœ‹ç”¨æˆ· "${userName}" çš„å¥–å“è¯¦æƒ…`, 'info');
             } catch (error) {
                 addLog(`âŒ æŸ¥çœ‹ç”¨æˆ·å¥–å“å¤±è´¥: ${error.message}`, 'error');
                 alert(`æŸ¥çœ‹å¤±è´¥: ${error.message}`);
             }
         }

        // å‘å¸ƒå…¬å‘Š
        async function publishAnnouncement() {
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            const imageFile = document.getElementById('announcement-image').files[0];

            if (!title || !content) {
                alert('è¯·å¡«å†™å…¬å‘Šæ ‡é¢˜å’Œå†…å®¹');
                return;
            }

            try {
                let imageUrl = null;

                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ å›¾ç‰‡
                if (imageFile) {
                    const fileName = `announcements/${Date.now()}_${imageFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('images')
                        .upload(fileName, imageFile);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('images')
                        .getPublicUrl(fileName);
                    
                    imageUrl = urlData.publicUrl;
                }

                // ä¿å­˜å…¬å‘Šåˆ°æ•°æ®åº“
                const { error } = await supabase
                    .from('announcements')
                    .insert({
                        title,
                        content,
                        image_url: imageUrl,
                        created_at: new Date().toISOString(),
                        is_active: true
                    });

                if (error) throw error;

                addLog('ğŸ“¢ å…¬å‘Šå‘å¸ƒæˆåŠŸ', 'success');
                clearAnnouncementForm();
                await loadAnnouncements();
                alert('å…¬å‘Šå‘å¸ƒæˆåŠŸï¼');
            } catch (error) {
                addLog(`âŒ å…¬å‘Šå‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
                alert(`å‘å¸ƒå¤±è´¥: ${error.message}`);
            }
        }

        // æ¸…é™¤å…¬å‘Šè¡¨å•
        function clearAnnouncementForm() {
            document.getElementById('announcement-title').value = '';
            document.getElementById('announcement-content').value = '';
            document.getElementById('announcement-image').value = '';
        }

        // åŠ è½½å…¬å‘Šåˆ—è¡¨
        async function loadAnnouncements() {
            try {
                const { data: announcements, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('announcements-list');
                container.innerHTML = '';

                if (announcements && announcements.length > 0) {
                    announcements.forEach(announcement => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-700 p-4 rounded-lg';
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h5 class="font-semibold text-white">${announcement.title}</h5>
                                <div class="flex gap-2">
                                    <button onclick="toggleAnnouncement('${announcement.id}', ${!announcement.is_active})" 
                                            class="px-2 py-1 rounded text-xs ${
                                                announcement.is_active ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'
                                            } text-white">
                                        ${announcement.is_active ? 'éšè—' : 'æ˜¾ç¤º'}
                                    </button>
                                    <button onclick="deleteAnnouncement('${announcement.id}')" 
                                            class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm mb-2">${announcement.content}</p>
                            ${announcement.image_url ? `<img src="${announcement.image_url}" class="max-w-xs rounded mb-2" alt="å…¬å‘Šå›¾ç‰‡">` : ''}
                            <div class="flex justify-between items-center text-xs text-gray-400">
                                <span>å‘å¸ƒæ—¶é—´: ${new Date(announcement.created_at).toLocaleString()}</span>
                                <span class="px-2 py-1 rounded ${
                                    announcement.is_active ? 'bg-green-600' : 'bg-gray-600'
                                }">
                                    ${announcement.is_active ? 'å·²å‘å¸ƒ' : 'å·²éšè—'}
                                </span>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-gray-400 text-center p-4">æš‚æ— å…¬å‘Š</div>';
                }
            } catch (error) {
                addLog(`âŒ åŠ è½½å…¬å‘Šå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ‡æ¢å…¬å‘ŠçŠ¶æ€
        async function toggleAnnouncement(id, isActive) {
            try {
                const { error } = await supabase
                    .from('announcements')
                    .update({ is_active: isActive })
                    .eq('id', id);

                if (error) throw error;

                addLog(`ğŸ“¢ å…¬å‘ŠçŠ¶æ€å·²æ›´æ–°: ${isActive ? 'æ˜¾ç¤º' : 'éšè—'}`, 'info');
                await loadAnnouncements();
            } catch (error) {
                addLog(`âŒ æ›´æ–°å…¬å‘ŠçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤å…¬å‘Š
        async function deleteAnnouncement(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) return;

            try {
                const { error } = await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                addLog('ğŸ—‘ï¸ å…¬å‘Šå·²åˆ é™¤', 'info');
                await loadAnnouncements();
            } catch (error) {
                addLog(`âŒ åˆ é™¤å…¬å‘Šå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ äº§å“çŸ¥è¯†
        async function addKnowledge() {
            const title = document.getElementById('knowledge-title').value.trim();
            const category = document.getElementById('knowledge-category').value;
            const description = document.getElementById('knowledge-description').value.trim();
            const features = document.getElementById('knowledge-features').value.trim();
            const price = document.getElementById('knowledge-price').value.trim();
            const imageFiles = document.getElementById('knowledge-images').files;
            const documentFiles = document.getElementById('knowledge-documents').files;

            if (!title || !category || !description) {
                alert('è¯·å¡«å†™äº§å“åç§°ã€åˆ†ç±»å’Œæè¿°');
                return;
            }

            try {
                let imageUrls = [];
                let documentUrls = [];

                // ä¸Šä¼ å›¾ç‰‡
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const fileName = `knowledge/images/${Date.now()}_${i}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('images')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('images')
                        .getPublicUrl(fileName);
                    
                    imageUrls.push(urlData.publicUrl);
                }

                // ä¸Šä¼ æ–‡æ¡£
                for (let i = 0; i < documentFiles.length; i++) {
                    const file = documentFiles[i];
                    const fileName = `knowledge/documents/${Date.now()}_${i}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('documents')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage
                        .from('documents')
                        .getPublicUrl(fileName);
                    
                    documentUrls.push({
                        name: file.name,
                        url: urlData.publicUrl
                    });
                }

                // ä¿å­˜çŸ¥è¯†åˆ°æ•°æ®åº“
                const { error } = await supabase
                    .from('knowledge')
                    .insert({
                        title,
                        category,
                        description,
                        features: features.split('\n').filter(f => f.trim()),
                        price,
                        image_urls: imageUrls,
                        document_urls: documentUrls,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('ğŸ“š äº§å“çŸ¥è¯†æ·»åŠ æˆåŠŸ', 'success');
                clearKnowledgeForm();
                await loadKnowledge();
                alert('äº§å“çŸ¥è¯†æ·»åŠ æˆåŠŸï¼');
            } catch (error) {
                addLog(`âŒ æ·»åŠ äº§å“çŸ¥è¯†å¤±è´¥: ${error.message}`, 'error');
                alert(`æ·»åŠ å¤±è´¥: ${error.message}`);
            }
        }

        // æ¸…é™¤çŸ¥è¯†è¡¨å•
        function clearKnowledgeForm() {
            document.getElementById('knowledge-title').value = '';
            document.getElementById('knowledge-category').value = '';
            document.getElementById('knowledge-description').value = '';
            document.getElementById('knowledge-features').value = '';
            document.getElementById('knowledge-price').value = '';
            document.getElementById('knowledge-images').value = '';
            document.getElementById('knowledge-documents').value = '';
        }

        // åŠ è½½çŸ¥è¯†åº“
        async function loadKnowledge() {
            try {
                const { data: knowledge, error } = await supabase
                    .from('knowledge')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('knowledge-list');
                container.innerHTML = '';

                if (knowledge && knowledge.length > 0) {
                    knowledge.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-700 p-4 rounded-lg';
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-semibold text-white">${item.title}</h5>
                                    <span class="text-xs px-2 py-1 bg-purple-600 rounded">${getCategoryName(item.category)}</span>
                                </div>
                                <button onclick="deleteKnowledge('${item.id}')" 
                                        class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                    åˆ é™¤
                                </button>
                            </div>
                            <p class="text-gray-300 text-sm mb-2">${item.description}</p>
                            ${item.price ? `<p class="text-green-400 font-semibold mb-2">ä»·æ ¼: ${item.price}</p>` : ''}
                            ${item.features && item.features.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-sm font-medium text-gray-300 mb-1">äº§å“ç‰¹ç‚¹:</p>
                                    <ul class="text-xs text-gray-400 list-disc list-inside">
                                        ${item.features.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${item.image_urls && item.image_urls.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-sm font-medium text-gray-300 mb-1">äº§å“å›¾ç‰‡:</p>
                                    <div class="flex gap-2 flex-wrap">
                                        ${item.image_urls.map(url => `<img src="${url}" class="w-16 h-16 object-cover rounded" alt="äº§å“å›¾ç‰‡">`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${item.document_urls && item.document_urls.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-sm font-medium text-gray-300 mb-1">ç›¸å…³æ–‡æ¡£:</p>
                                    <div class="flex gap-2 flex-wrap">
                                        ${item.document_urls.map(doc => `<a href="${doc.url}" target="_blank" class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded">${doc.name}</a>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="text-xs text-gray-400">
                                åˆ›å»ºæ—¶é—´: ${new Date(item.created_at).toLocaleString()}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-gray-400 text-center p-4">æš‚æ— äº§å“çŸ¥è¯†</div>';
                }
            } catch (error) {
                addLog(`âŒ åŠ è½½çŸ¥è¯†åº“å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–åˆ†ç±»åç§°
        function getCategoryName(category) {
            const categories = {
                'electronics': 'ç”µå­äº§å“',
                'clothing': 'æœè£…',
                'food': 'é£Ÿå“',
                'beauty': 'ç¾å®¹æŠ¤è‚¤',
                'home': 'å®¶å±…ç”¨å“',
                'sports': 'è¿åŠ¨å¥èº«',
                'other': 'å…¶ä»–'
            };
            return categories[category] || category;
        }

        // åˆ é™¤çŸ¥è¯†
        async function deleteKnowledge(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡äº§å“çŸ¥è¯†å—ï¼Ÿ')) return;

            try {
                const { error } = await supabase
                    .from('knowledge')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                addLog('ğŸ—‘ï¸ äº§å“çŸ¥è¯†å·²åˆ é™¤', 'info');
                await loadKnowledge();
            } catch (error) {
                addLog(`âŒ åˆ é™¤äº§å“çŸ¥è¯†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°é¢†å¥–æ¡æ¬¾
        async function updateTermsConditions() {
            const content = document.getElementById('terms-content').value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥é¢†å¥–æ¡æ¬¾å†…å®¹');
                return;
            }

            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'terms_conditions',
                        value: content,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('ğŸ† é¢†å¥–æ¡æ¬¾å·²æ›´æ–°', 'success');
                alert('é¢†å¥–æ¡æ¬¾ä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                addLog(`âŒ æ›´æ–°é¢†å¥–æ¡æ¬¾å¤±è´¥: ${error.message}`, 'error');
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°ä¼˜æƒ å¥—é¤å†…å®¹
        async function updatePromotionContent() {
            const content = document.getElementById('promotion-content').value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥ä¼˜æƒ å¥—é¤å†…å®¹');
                return;
            }

            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'promotion_content',
                        value: content,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('ğŸ‰ ä¼˜æƒ å¥—é¤å†…å®¹å·²æ›´æ–°', 'success');
                alert('ä¼˜æƒ å¥—é¤å†…å®¹ä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                addLog(`âŒ æ›´æ–°ä¼˜æƒ å¥—é¤å†…å®¹å¤±è´¥: ${error.message}`, 'error');
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        // åŠ è½½å†…å®¹ç®¡ç†æ•°æ®
        async function loadContentManagement() {
            try {
                // åŠ è½½é¢†å¥–æ¡æ¬¾
                const { data: termsData, error: termsError } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'terms_conditions')
                    .single();

                if (!termsError && termsData) {
                    document.getElementById('terms-content').value = termsData.value;
                }

                // åŠ è½½ä¼˜æƒ å¥—é¤å†…å®¹
                const { data: promotionData, error: promotionError } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'promotion_content')
                    .single();

                if (!promotionError && promotionData) {
                    document.getElementById('promotion-content').value = promotionData.value;
                }

            } catch (error) {
                addLog(`âŒ åŠ è½½å†…å®¹ç®¡ç†æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æœç´¢æ¡†äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const userSearchInput = document.getElementById('user-search');
            if (userSearchInput) {
                userSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            }

            const knowledgeSearchInput = document.getElementById('knowledge-search');
            if (knowledgeSearchInput) {
                knowledgeSearchInput.addEventListener('input', function() {
                    // å®ç°çŸ¥è¯†åº“æœç´¢åŠŸèƒ½
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶æœç´¢é€»è¾‘
                });
            }
        });

        // å®šæœŸåˆ·æ–°æ•°æ®
        setInterval(async () => {
            if (supabase) {
                await loadUserStats();
            }
        }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡

        // æŠ½å¥–é…ç½®ç®¡ç†å‡½æ•°
        async function saveLotteryConfig() {
            try {
                const initialChances = parseInt(document.getElementById('initial-chances').value) || 1;
                const spinAgainBonus = parseInt(document.getElementById('spin-again-bonus').value) || 1;
                const maxChances = parseInt(document.getElementById('max-chances').value) || 10;

                // éªŒè¯è¾“å…¥å€¼
                if (initialChances < 1 || initialChances > 10) {
                    alert('åˆå§‹æŠ½å¥–æœºä¼šå¿…é¡»åœ¨ 1-10 ä¹‹é—´');
                    return;
                }

                if (spinAgainBonus < 1 || spinAgainBonus > 5) {
                    alert('"å†æ¥ä¸€æ¬¡"å¥–åŠ±æœºä¼šå¿…é¡»åœ¨ 1-5 ä¹‹é—´');
                    return;
                }

                if (maxChances < 5 || maxChances > 50) {
                    alert('æœ€å¤§ç´¯ç§¯æœºä¼šæ•°å¿…é¡»åœ¨ 5-50 ä¹‹é—´');
                    return;
                }

                // ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
                const configData = {
                    INITIAL_CHANCES: initialChances,
                    SPIN_AGAIN_BONUS: spinAgainBonus,
                    MAX_ACCUMULATED_CHANCES: maxChances,
                    DAILY_FREE_CHANCES: 1,
                    ENABLE_DAILY_FREE: false,
                    ALLOW_ADMIN_ADD_CHANCES: true
                };

                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        key: 'lottery_config',
                        value: JSON.stringify(configData),
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                addLog('âš™ï¸ æŠ½å¥–é…ç½®å·²ä¿å­˜', 'success');
                alert('æŠ½å¥–é…ç½®ä¿å­˜æˆåŠŸï¼\n\næ³¨æ„ï¼šæ–°é…ç½®å°†åœ¨ä¸‹æ¬¡ç”¨æˆ·æ³¨å†Œæ—¶ç”Ÿæ•ˆã€‚');

                // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
                updateSystemStatus();

            } catch (error) {
                addLog(`âŒ ä¿å­˜æŠ½å¥–é…ç½®å¤±è´¥: ${error.message}`, 'error');
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        // åŠ è½½æŠ½å¥–é…ç½®
        async function loadLotteryConfig() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'lottery_config')
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°è®°å½•
                    throw error;
                }

                let config = {
                    INITIAL_CHANCES: 1,
                    SPIN_AGAIN_BONUS: 1,
                    MAX_ACCUMULATED_CHANCES: 10
                };

                if (data && data.value) {
                    try {
                        config = JSON.parse(data.value);
                    } catch (parseError) {
                        addLog('âš ï¸ é…ç½®æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®', 'warning');
                    }
                }

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                document.getElementById('initial-chances').value = config.INITIAL_CHANCES || 1;
                document.getElementById('spin-again-bonus').value = config.SPIN_AGAIN_BONUS || 1;
                document.getElementById('max-chances').value = config.MAX_ACCUMULATED_CHANCES || 10;

                addLog('ğŸ”„ æŠ½å¥–é…ç½®å·²é‡æ–°åŠ è½½', 'info');
                updateSystemStatus();

            } catch (error) {
                addLog(`âŒ åŠ è½½æŠ½å¥–é…ç½®å¤±è´¥: ${error.message}`, 'error');
                // ä½¿ç”¨é»˜è®¤å€¼
                document.getElementById('initial-chances').value = 1;
                document.getElementById('spin-again-bonus').value = 1;
                document.getElementById('max-chances').value = 10;
            }
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
        async function updateSystemStatus() {
            try {
                // æ£€æŸ¥æ•°æ®åº“è¿æ¥
                const { error: dbError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });

                const dbStatus = document.getElementById('db-status');
                if (dbError) {
                    dbStatus.textContent = 'è¿æ¥å¼‚å¸¸';
                    dbStatus.className = 'text-red-400';
                } else {
                    dbStatus.textContent = 'å·²è¿æ¥';
                    dbStatus.className = 'text-green-400';
                }

                // æ£€æŸ¥å®æ—¶è¿æ¥çŠ¶æ€
                const realtimeStatus = document.getElementById('realtime-status');
                if (realtimeChannel && realtimeChannel.state === 'joined') {
                    realtimeStatus.textContent = 'å·²å¯ç”¨';
                    realtimeStatus.className = 'text-green-400';
                } else {
                    realtimeStatus.textContent = 'æœªè¿æ¥';
                    realtimeStatus.className = 'text-yellow-400';
                }

                // æŠ½å¥–ç³»ç»ŸçŠ¶æ€
                const lotteryStatus = document.getElementById('lottery-status');
                lotteryStatus.textContent = 'æ­£å¸¸è¿è¡Œ';
                lotteryStatus.className = 'text-green-400';

            } catch (error) {
                addLog(`âŒ æ›´æ–°ç³»ç»ŸçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®
        window.addEventListener('load', function() {
            setTimeout(async () => {
                await loadLotteryConfig();
            }, 1500);
        });
    </script>
</body>
</html>